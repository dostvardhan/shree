<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome • Shreshtha</title>

  <style>
    body{font-family:Arial, Helvetica, sans-serif; background:#3a3240; color:#222; margin:0; padding:0; display:flex; align-items:flex-start; justify-content:center; min-height:100vh}
    .card {background: #fff; width:520px; margin:40px; padding:28px; box-shadow: 0 6px 20px rgba(0,0,0,.25); border-radius:8px; text-align:center;}
    a{display:block; margin:8px 0; font-size:13px}
    button {padding:8px 14px; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer}
  </style>

  <!-- Auth0 SPA JS from official CDN (fast fix) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js" defer></script>

  <!-- Inline guard/init script (loads AFTER SDK because of defer order) -->
  <script defer>
  (function(){
    // ---------- REPLACE these with your real Auth0 values ----------
    const AUTH0_DOMAIN = "dev-zzhjbmtzoxtgoz31.us.auth0.com"; // e.g. dev-xxxxxx.auth0.com
    const AUTH0_CLIENT_ID = "0glcwUr7ZZ9sbBTBPiUPahEqqwUcuzfR";
    const AUTH0_AUDIENCE = "https://shree-drive.onrender.com"; // optional
    const REDIRECT_AFTER_LOGIN = "/life.html"; // change if needed
    // ---------------------------------------------------------------

    // expose a promise so other scripts can await readiness
    window.__AUTH_READY__ = (async function init() {
      try {
        if (typeof createAuth0Client !== 'function') {
          console.error('Auth0 SDK not found: createAuth0Client is not a function');
          return null;
        }

        const auth0 = await createAuth0Client({
          domain: AUTH0_DOMAIN,
          client_id: AUTH0_CLIENT_ID,
          audience: AUTH0_AUDIENCE || undefined,
          cacheLocation: 'memory',
          useRefreshTokens: false,
        });

        // helper wrappers
        const wrapper = {
          _auth0: auth0,
          isAuthenticated: async () => {
            try { return await auth0.isAuthenticated(); } catch(e){ console.error(e); return false; }
          },
          login: async (opts = {}) => {
            // redirect-based login (uses Auth0 hosted login page)
            return auth0.loginWithRedirect({
              redirect_uri: window.location.origin + REDIRECT_AFTER_LOGIN,
              ...opts
            });
          },
          handleRedirectCallback: async () => {
            try {
              const result = await auth0.handleRedirectCallback();
              return result;
            } catch(e) {
              console.warn('handleRedirectCallback err', e);
              return null;
            }
          },
          logout: (opts = {}) => {
            return auth0.logout({ returnTo: window.location.origin + (opts.returnTo || '/') });
          },
          getUser: async () => {
            try { return await auth0.getUser(); } catch(e){ return null; }
          },
          getToken: async (opts = {}) => {
            try { return await auth0.getTokenSilently(opts); } catch(e){ console.error('getToken err', e); return null; }
          },
          authFetch: async (input, init = {}) => {
            // fetch wrapper that adds Authorization header when token is available
            try {
              const token = await wrapper.getToken();
              const headers = new Headers(init.headers || {});
              if (token) headers.set('Authorization', 'Bearer ' + token);
              const merged = Object.assign({}, init, { headers });
              return fetch(input, merged);
            } catch(e) {
              console.error('authFetch error', e);
              return fetch(input, init);
            }
          }
        };

        // export
        window.__AUTH__ = wrapper;
        return wrapper;
      } catch (err) {
        console.error('Auth init failed', err);
        return null;
      }
    })();
  })();
  </script>
</head>

<body>
  <div class="card">
    <h2>Welcome ✨</h2>
    <p style="font-size:13px; color:#666">Private site — login required to continue.</p>

    <div id="login-area" style="margin-top:16px">
      <button id="login-btn">Login</button>
      <button id="logout-btn" style="display:none">Logout</button>
    </div>

    <div style="margin-top:18px; font-size:13px">
      <a href="/life.html">Go to Life Page</a>
      <a href="/gallery.html">Go to Gallery</a>
      <a href="/upload.html">Go to Upload</a>
    </div>

    <div id="user-info" style="margin-top:14px; font-size:13px; color:#444"></div>
  </div>

  <script>
    // UI wiring: uses window.__AUTH_READY__ promise
    (async function(){
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userInfo = document.getElementById('user-info');

      // Wait until guard/SDK inits or times out
      let auth = null;
      try {
        // wait up to ~6s for init; avoid indefinite waiting
        auth = await Promise.race([
          window.__AUTH_READY__,
          new Promise(resolve => setTimeout(() => resolve(null), 6000))
        ]);
      } catch(e) {
        console.error('auth await err', e);
      }

      function showUser(u) {
        if (!u) { userInfo.textContent = ''; return; }
        userInfo.textContent = `Signed in as ${u.name || u.email || u.sub}`;
      }

      async function refreshUI() {
        if (!auth) {
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          showUser(null);
          return;
        }
        const isAuth = await auth.isAuthenticated();
        if (isAuth) {
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          const user = await auth.getUser();
          showUser(user);
        } else {
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          showUser(null);
        }
      }

      loginBtn.addEventListener('click', async function () {
        if (!auth) {
          alert('Auth not ready. Please try again in a moment.');
          return;
        }
        try {
          await auth.login();
          // After redirect flow user will land on REDIRECT_AFTER_LOGIN; this page might be replaced.
        } catch (e) {
          console.error('login err', e);
        }
      });

      logoutBtn.addEventListener('click', function () {
        if (!auth) {
          alert('Auth not ready.');
          return;
        }
        auth.logout({ returnTo: '/' });
      });

      // handle page load after redirect from Auth0
      (async function handleRedirectIfAny(){
        if (!auth) return;
        const url = new URL(window.location.href);
        if (url.searchParams.has('code') && url.searchParams.has('state')) {
          try {
            await auth._auth0.handleRedirectCallback();
            // clean url (remove query params)
            url.searchParams.delete('code');
            url.searchParams.delete('state');
            window.history.replaceState({}, document.title, url.pathname + url.search);
            // redirect to desired page
            window.location.href = REDIRECT_AFTER_LOGIN || '/';
          } catch (e) {
            console.warn('redirect handling failed', e);
          }
        }
      })();

      // initial UI
      await refreshUI();

      // optionally refresh UI every 10s to pick up login state changes (not required)
      setInterval(refreshUI, 10000);
    })();
  </script>
</body>
</html>
