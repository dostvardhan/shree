<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sweet Memories • Shreshtha</title>
  <style>
    body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:#3b3f2d;color:#fff;overflow-x:hidden;}
    h1{text-align:center;padding:20px;color:#f7cfe0;font-size:28px;}
    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:20px;max-width:980px;margin:0 auto;}
    .card{position:relative;overflow:hidden;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.32);height:190px;}
    .card img{width:100%;height:100%;object-fit:cover;transition:transform .38s ease;}
    .card:hover img{transform:scale(1.06);}
    .quote{position:absolute;bottom:6px;left:6px;right:6px;padding:8px;background:rgba(0,0,0,.45);font-size:13px;text-align:center;border-radius:6px;}
    .heart{position:fixed;bottom:-20px;color:rgba(255,90,140,.85);font-size:18px;animation:rise 6.5s linear infinite;}
    @keyframes rise{0%{transform:translateY(0) scale(1);}100%{transform:translateY(-110vh) scale(.5);opacity:0;}}
    #logout-btn{position:fixed;top:16px;right:16px;padding:6px 12px;border:none;border-radius:6px;background:#f76ca2;color:#fff;cursor:pointer;}
    #protected{display:none;}
  </style>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js" defer></script>

  <!-- Guard -->
  <script defer>
  (function(){
    const AUTH0_DOMAIN="dev-zzhjbmtzoxtgoz31.us.auth0.com";
    const AUTH0_CLIENT_ID="0glcwUr7ZZ9sbBTBPiUPahEqqwUcuzfR";
    const AUTH0_AUDIENCE="https://shree-drive.onrender.com";
    window.__AUTH_READY__ = (async function init(){
      const auth0 = await createAuth0Client({ domain: AUTH0_DOMAIN, client_id: AUTH0_CLIENT_ID, audience: AUTH0_AUDIENCE, cacheLocation:'memory' });
      window.__AUTH__ = {
        _auth0: auth0,
        isAuthenticated: () => auth0.isAuthenticated(),
        login: () => auth0.loginWithRedirect({ redirect_uri: window.location.href }),
        logout: () => auth0.logout({ returnTo: window.location.origin }),
        getUser: () => auth0.getUser(),
        getToken: () => auth0.getTokenSilently(),
        authFetch: async (u, o={}) => {
          try {
            const t = await auth0.getTokenSilently();
            const h = new Headers(o.headers||{});
            if (t) h.set('Authorization','Bearer '+t);
            return fetch(u, { ...o, headers: h, credentials: 'include' });
          } catch(e){
            return fetch(u,o);
          }
        }
      };
      return window.__AUTH__;
    })();
  })();
  </script>
</head>
<body>
  <div id="protected">
    <h1>Sweet Memories of Shreshtha 💖</h1>

    <div class="gallery" id="gallery">
      <!-- placeholder cards (will be replaced by JS after /list) -->
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
      <div class="card"><img src="/placeholder.jpg" alt="..."><div class="quote">Loading…</div></div>
    </div>

    <button id="logout-btn">Logout</button>
  </div>

  <!-- floating hearts -->
  <script>
  function createHeart(){
    const heart=document.createElement('div');
    heart.className='heart';
    heart.style.left=(Math.random()*90)+'vw';
    heart.style.fontSize=(14+Math.random()*10)+'px';
    heart.innerHTML='❤';
    document.body.appendChild(heart);
    setTimeout(()=>heart.remove(),6500);
  }
  setInterval(createHeart,900);
  </script>

  <!-- Auth + gallery loader -->
  <script>
  (async function(){
    const auth = await window.__AUTH_READY__;
    if(!await auth.isAuthenticated()){ await auth.login(); return; }
    document.getElementById('protected').style.display='block';
    document.getElementById('logout-btn').onclick = () => auth.logout();

    // fetch list from backend
    const listRes = await auth.authFetch('https://shree-drive.onrender.com/list');
    if(!listRes.ok){ console.error('list failed', listRes.status); return; }
    const data = await listRes.json();
    const files = data.files || [];
    const galleryEl = document.getElementById('gallery');
    galleryEl.innerHTML = ''; // clear placeholders

    // show most recent first; limit to 9 for layout
    const showList = files.slice(0,9);
    for(const f of showList){
      try{
        // fetch blob from backend via authFetch (secure)
        const fileRes = await auth.authFetch(`https://shree-drive.onrender.com/files/${f.id}`);
        if(!fileRes.ok){ console.warn('file fetch failed', f.id, fileRes.status); continue; }
        const blob = await fileRes.blob();
        const url = URL.createObjectURL(blob);

        const card = document.createElement('div');
        card.className = 'card';
        const img = document.createElement('img');
        img.src = url;
        img.alt = f.name || '';
        const q = document.createElement('div');
        q.className = 'quote';
        q.textContent = f.name || '';

        card.appendChild(img);
        card.appendChild(q);
        galleryEl.appendChild(card);

        img.onload = () => URL.revokeObjectURL(url);
      } catch (e){
        console.error('file blob err', e);
      }
    }
  })();
  </script>
</body>
</html>
