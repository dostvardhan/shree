<!doctype html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; media-src 'self';">
<meta charset="utf-8">
<title>Shree Music Player</title>
<style>
  body{margin:12px;font-family:system-ui,Segoe UI,Roboto;display:flex;align-items:center;gap:12px}
  button{padding:8px 12px;border-radius:8px;border:none;background:#6e2430;color:white;cursor:pointer}
  input[type=range]{width:160px}
  .label{font-size:13px;color:#333}
</style>
</head>
<body>
  <button id="playBtn">Play</button>
  <input id="vol" type="range" min="0" max="1" step="0.01" value="0.6">
  <span class="label" id="status">Stopped</span>

  <audio id="bg" loop preload="auto"></audio>

<script>
  // Set the audio src here; server should serve /api/music
  const audio = document.getElementById('bg');
  audio.src = '/api/music';
  const playBtn = document.getElementById('playBtn');
  const vol = document.getElementById('vol');
  const status = document.getElementById('status');

  // restore volume
  const savedVol = parseFloat(localStorage.getItem('shree_bg_vol'));
  audio.volume = !isNaN(savedVol) ? savedVol : 0.6;
  vol.value = audio.volume;

  function updateUI(){
    status.textContent = audio.paused ? 'Paused' : 'Playing';
    playBtn.textContent = audio.paused ? 'Play' : 'Pause';
  }
  playBtn.addEventListener('click', ()=> {
    if (audio.paused) audio.play().catch(()=>{});
    else audio.pause();
    updateUI();
  });
  audio.addEventListener('play', updateUI);
  audio.addEventListener('pause', updateUI);

  vol.addEventListener('input', (e) => {
    audio.volume = Number(e.target.value);
    localStorage.setItem('shree_bg_vol', String(audio.volume));
  });

  // receive commands from opener via postMessage
  window.addEventListener('message', (ev) => {
    const cmd = ev.data && ev.data.cmd;
    if (!cmd) return;
    if (cmd === 'play') audio.play().catch(()=>{});
    else if (cmd === 'pause') audio.pause();
    else if (cmd === 'toggle') { if (audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
    else if (cmd === 'setVol') { audio.volume = Number(ev.data.v); vol.value = audio.volume; localStorage.setItem('shree_bg_vol', String(audio.volume)); }
  }, false);

  // when ready, tell opener that we're ready
  if (window.opener) window.opener.postMessage({ from:'shreePlayer', ready:true }, '*');

  // try to auto-play if allowed (will be blocked until user interacts)
  audio.play().catch(()=>{ updateUI(); });
  updateUI();
</script>
<!-- Mini Floating Music Player (added by script) -->
<style>
  /* compact heart player */
  .music-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 6px 20px rgba(0,0,0,0.14);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 160;
    transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    border: 2px solid rgba(255,255,255,0.6);
    backdrop-filter: blur(4px);
  }
  .music-btn:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,0.18); }
  .music-btn.playing { animation: mPulse 2s infinite ease-in-out; }
  @keyframes mPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.06); }
    100% { transform: scale(1); }
  }
  /* soft pastel ring when active */
  .music-btn .ring {
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    pointer-events: none;
    box-shadow: 0 0 0 4px rgba(255,215,153,0.06);
    opacity: 0;
    transform: scale(.94);
    transition: opacity .25s ease, transform .25s ease;
  }
  .music-btn.playing .ring { opacity: 1; transform: scale(1); }

  /* heart icon */
  .music-btn svg { width:22px; height:22px; display:block; }
  .music-btn .heart { fill: #ff6f91; transition: transform .15s ease; }
  .music-btn.playing .heart { fill: #ffd166; transform: scale(1.05); }

  /* small focus outline for keyboard users */
  .music-btn:focus { outline: 3px solid rgba(255,255,255,0.9); outline-offset: 6px; border-radius: 50%; }
</style>

<button id="musicButton" class="music-btn" aria-pressed="false" aria-label="Play background music" title="Play / Pause music">
  <span class="ring" aria-hidden="true"></span>
  <!-- Heart icon -->
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path class="heart" d="M12 21s-7.33-4.94-9.33-7.02C.8 11.9 2.1 7.9 5.5 6.3 7.2 5.4 9.1 6 10 7.3c.9-1.3 2.8-1.9 4.5-1 3.4 1.6 4.7 5.6 2.8 7.68C19.33 16.06 12 21 12 21z"/>
  </svg>
</button>

<audio id="bgMusic" loop preload="auto">
  <source src="/music/bg.mp3" type="audio/mpeg" />
</audio>

<script>
(() => {
  const btn = document.getElementById('musicButton');
  const heart = btn.querySelector('.heart');
  const music = document.getElementById('bgMusic');
  let playing = false;
  // icons are inlined via SVG; update aria + classes
  function setPlaying(state) {
    playing = !!state;
    btn.setAttribute('aria-pressed', playing ? 'true' : 'false');
    if (playing) {
      btn.classList.add('playing');
      try { music.play().catch(()=>{}); } catch(e){}
      btn.setAttribute('title','Pause music');
    } else {
      btn.classList.remove('playing');
      try { music.pause(); } catch(e){}
      btn.setAttribute('title','Play music');
    }
  }

  // restore last state from localStorage if user had it playing
  try {
    if (localStorage.getItem('shree_music_playing') === '1') {
      setPlaying(true);
    }
  } catch(e){}

  btn.addEventListener('click', (ev) => {
    setPlaying(!playing);
    try { localStorage.setItem('shree_music_playing', playing ? '1' : '0'); } catch(e){}
  });

  // keyboard accessibility (space / enter)
  btn.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); btn.click(); }
  });

  // if the audio fails to play (autoplay policies), keep UI sync
  music.addEventListener('play', ()=> setPlaying(true));
  music.addEventListener('pause', ()=> setPlaying(false));
})();
</script>
</body>
</html>






