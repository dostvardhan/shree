<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shree Music Player</title>

<!-- fix: connect-src typo and keep CSP simple for now; adjust as needed -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; media-src 'self'">

<style>
  body{margin:12px;font-family:system-ui,Segoe UI,Roboto;display:flex;align-items:center;gap:12px;background:transparent}
  button{padding:8px 12px;border-radius:8px;border:none;background:#6e2430;color:white;cursor:pointer}
  input[type=range]{width:180px}
  .label{font-size:13px;color:#333}
</style>
</head>
<body>

  <button id="playBtn">Play</button>
  <input id="vol" type="range" min="0" max="100" step="1" value="60" />
  <span class="label" id="status">Stopped</span>

  <!-- WARNING: use the same audio id across site scripts -->
  <audio id="bgMusicFinal" loop preload="auto" style="display:none">
    <source src="/music/bg.mp3" type="audio/mpeg" />
    <!-- If you really serve audio from /api/music change the src attribute to that path. -->
  </audio>

<script>
(function(){
  const KEY = 'shree_music_volume';
  const KEY_PLAY = 'shree_music_playing';

  const audio = document.getElementById('bgMusicFinal');
  const playBtn = document.getElementById('playBtn');
  const vol = document.getElementById('vol');
  const status = document.getElementById('status');

  // restore volume (0..100)
  try {
    const savedVol = localStorage.getItem(KEY);
    const v = savedVol !== null ? Math.max(0,Math.min(100,parseInt(savedVol,10))) : 60;
    audio.volume = v/100;
    vol.value = v;
  } catch(e){ vol.value = 60; audio.volume = 0.6; }

  function updateUI(){
    status.textContent = audio.paused ? 'Paused' : 'Playing';
    playBtn.textContent = audio.paused ? 'Play' : 'Pause';
  }

  playBtn.addEventListener('click', ()=> {
    if (audio.paused) audio.play().catch(()=>{});
    else audio.pause();
    updateUI();
  });

  audio.addEventListener('play', updateUI);
  audio.addEventListener('pause', updateUI);

  vol.addEventListener('input', (e) => {
    const v = Math.max(0, Math.min(100, parseInt(e.target.value,10)));
    audio.volume = v/100;
    try { localStorage.setItem(KEY, String(v)); } catch(e){}
    // notify opener (launcher) if present
    try { window.opener && window.opener.postMessage({ from:'shreePlayer', state:{ volume: v } }, location.origin); } catch(e){}
  });

  // receive commands from opener via postMessage
  window.addEventListener('message', (ev) => {
    // accept only same origin messages (safer)
    if (!ev || ev.origin !== location.origin) return;
    const d = ev.data || {};
    const cmd = d.cmd;
    if (!cmd) return;
    if (cmd === 'play') audio.play().catch(()=>{});
    else if (cmd === 'pause') audio.pause();
    else if (cmd === 'toggle') { if (audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
    else if (cmd === 'setVolume' && typeof d.value !== 'undefined') {
      const v = Math.max(0, Math.min(100, parseInt(d.value,10)));
      audio.volume = v/100;
      vol.value = v;
      try { localStorage.setItem(KEY, String(v)); } catch(e){}
    }
    // reply current state
    try {
      const state = { playing: !audio.paused, volume: Math.round(audio.volume*100) };
      window.opener && window.opener.postMessage({ from:'shreePlayer', state }, location.origin);
    } catch(e){}
  }, false);

  // tell opener we're ready
  try { if (window.opener) window.opener.postMessage({ from:'shreePlayer', ready:true }, location.origin); } catch(e){}

  // try autoplay (will be blocked until user interacts on many browsers)
  audio.play().then(()=>{}).catch(()=>{ updateUI(); });
  updateUI();
})();
</script>
</body>
</html>
