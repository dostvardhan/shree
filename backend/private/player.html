<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Shree Music Player</title>
<style>
  body{margin:12px;font-family:system-ui,Segoe UI,Roboto;display:flex;align-items:center;gap:12px}
  button{padding:8px 12px;border-radius:8px;border:none;background:#6e2430;color:white;cursor:pointer}
  input[type=range]{width:160px}
  .label{font-size:13px;color:#333}
</style>
</head>
<body>
  <button id="playBtn">Play</button>
  <input id="vol" type="range" min="0" max="1" step="0.01" value="0.6">
  <span class="label" id="status">Stopped</span>

  <audio id="bg" loop preload="auto"></audio>

<script>
  // Set the audio src here; server should serve /api/music
  const audio = document.getElementById('bg');
  audio.src = '/api/music';
  const playBtn = document.getElementById('playBtn');
  const vol = document.getElementById('vol');
  const status = document.getElementById('status');

  // restore volume
  const savedVol = parseFloat(localStorage.getItem('shree_bg_vol'));
  audio.volume = !isNaN(savedVol) ? savedVol : 0.6;
  vol.value = audio.volume;

  function updateUI(){
    status.textContent = audio.paused ? 'Paused' : 'Playing';
    playBtn.textContent = audio.paused ? 'Play' : 'Pause';
  }
  playBtn.addEventListener('click', ()=> {
    if (audio.paused) audio.play().catch(()=>{});
    else audio.pause();
    updateUI();
  });
  audio.addEventListener('play', updateUI);
  audio.addEventListener('pause', updateUI);

  vol.addEventListener('input', (e) => {
    audio.volume = Number(e.target.value);
    localStorage.setItem('shree_bg_vol', String(audio.volume));
  });

  // receive commands from opener via postMessage
  window.addEventListener('message', (ev) => {
    const cmd = ev.data && ev.data.cmd;
    if (!cmd) return;
    if (cmd === 'play') audio.play().catch(()=>{});
    else if (cmd === 'pause') audio.pause();
    else if (cmd === 'toggle') { if (audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
    else if (cmd === 'setVol') { audio.volume = Number(ev.data.v); vol.value = audio.volume; localStorage.setItem('shree_bg_vol', String(audio.volume)); }
  }, false);

  // when ready, tell opener that we're ready
  if (window.opener) window.opener.postMessage({ from:'shreePlayer', ready:true }, '*');

  // try to auto-play if allowed (will be blocked until user interacts)
  audio.play().catch(()=>{ updateUI(); });
  updateUI();
</script>
</body>
</html>
