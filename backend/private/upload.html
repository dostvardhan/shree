<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Upload — Sweet Memories</title>

  <!-- Auth protection -->
  <script src="/auth0-spa-js.production.js" defer></script>
  <script src="/auth-init.js" defer></script>
  <script src="/guard-auth.js" defer></script>

  <style>
    :root{
      --bg: url("/assets/img/upload-bg-final-new.jpg");
      --ink:#3a1b1d;
      --btn:#bb7a39;
      --card: rgba(255,255,255,0.55);   /* thinner transparency */
      --border: rgba(255,255,255,0.35);
      --shadow: 0 12px 28px rgba(0,0,0,0.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      color:var(--ink);
      font-family: "Playfair Display", Georgia, serif;
      background-color:#f6efe8;
      overflow-x:hidden;
    }

    /* === Single clear background === */
    .bg-img{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      object-fit:contain;           /* full painting visible */
      object-position:center center;
      z-index:-1;
      user-select:none; pointer-events:none;
    }

    header{ text-align:center; padding:20px 10px 6px; position:relative; z-index:3; }
    nav a{
      display:inline-block; margin:0 6px; padding:6px 12px; border-radius:18px;
      background:rgba(255,255,255,.85); color:var(--ink); text-decoration:none;
      box-shadow:0 6px 14px rgba(0,0,0,.15); font-size:14px;
    }
    h1{
      margin:14px 0 10px;
      font-size:clamp(28px,4.2vw,50px);
      color:var(--ink);
      text-shadow:0 6px 14px rgba(0,0,0,.2);
    }

    /* === Upload + Preview Panels === */
    main{
      display:flex; justify-content:center; flex-wrap:wrap;
      gap:22px;
      max-width:980px; margin:24px auto 100px; padding:0 14px;
      position:relative; z-index:3;
    }
    .card{
      flex:1 1 420px;
      background:var(--card);
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px) saturate(120%);
      padding:18px;
      transition:transform .3s ease;
    }
    .card:hover{ transform:translateY(-3px); }

    .drop{
      border:2px dashed rgba(0,0,0,.2);
      border-radius:10px; padding:14px; text-align:center;
      background:rgba(255,255,255,.4);
    }
    .drop input[type="file"]{ display:block; margin:8px auto }
    label{font-weight:700}
    textarea{
      width:100%; min-height:90px;
      border-radius:8px; border:1px solid rgba(0,0,0,.12);
      padding:10px; resize:vertical;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background:rgba(255,255,255,.75);
    }

    .actions{display:flex;gap:10px;align-items:center;margin-top:10px;}
    .btn{
      background:var(--btn); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 16px rgba(0,0,0,.25);
    }
    .btn.secondary{ background:rgba(0,0,0,.1); color:var(--ink); }
    .muted{font-size:12px;opacity:.85}

    #protectedContent{visibility:hidden;opacity:0;transition:opacity .3s ease;}
  </style>
</head>
<body>
  <img src="/assets/img/upload-bg-final-new.jpg" alt="Painting background" class="bg-img"/>

  <header>
    <nav>
      <a href="/life.html">Life</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/logout.html">Logout</a>
    </nav>
    <h1>Upload a Sweet Memory</h1>
  </header>

  <main id="protectedContent">
    <!-- Upload form -->
    <section class="card">
      <div class="drop">
        <div style="font-weight:700">Drag & drop a photo here or</div>
        <input id="photo" name="photo" type="file" accept="image/*" required>
        <div class="muted">JPG/PNG • Max 8 MB</div>
      </div>

      <div style="margin-top:12px">
        <label for="caption">Caption (short)</label>
        <textarea id="caption" name="caption" placeholder="Write a short caption (max 150 chars)"></textarea>
      </div>

      <div class="actions">
        <button id="uploadBtn" class="btn">Upload</button>
        <button id="clearBtn" class="btn secondary" type="button">Clear</button>
        <span id="msg" class="muted"></span>
      </div>
    </section>

    <!-- Preview -->
    <aside class="card">
      <div style="min-height:200px;display:flex;align-items:center;justify-content:center;text-align:center;">
        <div>
          <div class="muted">Preview</div>
          <div id="previewSub" class="muted">No photo selected</div>
          <img id="previewImg" style="display:none;max-width:100%;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.18)"/>
        </div>
      </div>
    </aside>
  </main>

  <!-- Auth show -->
  <script>
    (function(){
      const root=document.getElementById('protectedContent');
      const show=()=>{root.style.visibility='visible';root.style.opacity='1';};
      if(window.__shreeAuthReady)show();
      else window.addEventListener('shree:auth-ready',show,{once:true});
    })();
  </script>

  <!-- Upload logic -->
  <script>
    (function(){
      const f=document.getElementById('photo');
      const c=document.getElementById('caption');
      const b=document.getElementById('uploadBtn');
      const clr=document.getElementById('clearBtn');
      const m=document.getElementById('msg');
      const p=document.getElementById('previewImg');
      const ps=document.getElementById('previewSub');

      f.addEventListener('change',()=>{
        const file=f.files[0];
        if(!file){p.style.display='none';p.removeAttribute('src');ps.textContent='No photo selected';return;}
        const url=URL.createObjectURL(file);
        p.src=url;p.style.display='inline-block';ps.textContent='';
      });

      clr.addEventListener('click',()=>{
        f.value='';c.value='';p.style.display='none';p.removeAttribute('src');
        ps.textContent='No photo selected';m.textContent='';
      });

      b.addEventListener('click',async()=>{
        if(!f.files[0]){m.textContent='Please choose a photo';return;}
        m.textContent='Uploading…';
        const fd=new FormData();
        fd.append('photo',f.files[0]);
        if(c.value.trim())fd.append('caption',c.value.trim());
        try{
          let res;
          if(window.authFetch){
            res=await window.authFetch('/api/upload',{method:'POST',body:fd});
          }else{
            let token=null;if(window.getAuthToken)token=await window.getAuthToken();
            const headers=token?{'Authorization':'Bearer '+token}:{};
            res=await fetch('/api/upload',{method:'POST',body:fd,headers,credentials:'include'});
          }
          if(!res.ok)throw new Error('HTTP '+res.status);
          m.textContent='Uploaded ✓';
          setTimeout(()=>location.href='/gallery.html',750);
        }catch(e){
          console.error(e);m.textContent='Upload failed: '+e.message;
        }
      });
    })();
  </script>
</body>
</html>
