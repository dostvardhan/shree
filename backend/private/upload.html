<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Sweet Memories</title>

  <!-- Auth guard (your project uses these static paths) -->
  <script src="/static/guard-auth.js" defer></script>
  <script src="/static/auth-init.js" defer></script>

  <style>
    :root{
      --accent: #b96a3f;
      --muted: #4b3b2b;
      --card-bg: rgba(255,255,255,0.86);
      font-family: "Playfair Display", serif;
    }

    html,body{height:100%;margin:0;padding:0}
    body{
      color: var(--muted);
      background:
        radial-gradient(1000px 700px at 25% 20%, rgba(255,243,233,0.9), rgba(255,230,210,0.6), transparent 80%),
        radial-gradient(1200px 900px at 80% 85%, rgba(255,218,190,0.7), rgba(255,205,175,0.45), transparent 80%),
        linear-gradient(160deg, #fff7f0 0%, #ffe3c9 45%, #ffd0b7 80%, #ffc2a7 100%);
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-size: cover;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
    }

    /* subtle vignette & painterly feel */
    body::before{
      content:""; position:fixed; inset:0;
      background: radial-gradient(circle at 50% 50%, transparent 65%, rgba(0,0,0,0.07) 100%);
      pointer-events:none;
    }

    .wrap{
      width:980px; max-width:94%; margin:36px auto; padding:32px;
      display:grid; grid-template-columns:1fr 420px; gap:28px; align-items:start;
      position:relative; z-index:1;
    }

    .card{
      background: linear-gradient(135deg, rgba(255,255,255,0.78), rgba(255,255,255,0.70));
      border-radius:16px; padding:22px;
      box-shadow:0 12px 40px rgba(16,24,32,0.25);
      backdrop-filter: blur(6px) saturate(120%);
      border:1px solid rgba(255,255,255,0.36);
    }

    h1{margin:0 0 8px; font-size:28px; color:#5a0013; text-align:center; text-shadow:0 3px 6px rgba(0,0,0,0.1);}
    p.lead{margin:0 0 18px; color:var(--muted); text-align:center;}

    .form-row{display:flex; flex-direction:column; gap:10px}
    input[type="text"], textarea, input[type="file"]{
      width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.1);
      font-size:14px; background: rgba(255,255,255,0.85);
    }
    textarea{min-height:110px; resize:vertical}

    .actions{display:flex; gap:10px; margin-top:12px; align-items:center; justify-content:center;}
    .btn{
      padding:10px 18px; border-radius:10px; border:none; font-weight:700; cursor:pointer;
      background: linear-gradient(90deg,#c0764f,#b27b3a); color:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,0.15); transition:all .15s ease;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05);}
    .btn.secondary{background:transparent; border:1px solid rgba(0,0,0,0.1); color:#333}

    .preview{
      border-radius:12px; overflow:hidden; min-height:320px;
      background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.45));
      display:flex; align-items:center; justify-content:center; position:relative; padding:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
    }
    .preview img{max-width:100%; max-height:100%; object-fit:contain; border-radius:8px}

    .preview .caption{
      position:absolute; left:12px; right:12px; bottom:12px;
      background:rgba(0,0,0,0.35); color:#fff; padding:8px; border-radius:8px;
      font-size:13px; text-align:center; backdrop-filter: blur(2px);
    }

    @media (max-width:980px){ .wrap{grid-template-columns:1fr} .preview{min-height:260px} }
  </style>
</head>
<body>
  <main class="wrap" id="protectedContent" style="visibility:hidden;opacity:0;transition:opacity .25s">
    <section class="card">
      <h1>Upload a Sweet Memory</h1>
      <p class="lead">Choose a photo and a short caption — your uploads remain private.</p>

      <form id="uploadForm" class="form-row" enctype="multipart/form-data" autocomplete="off">
        <label>
          <input id="fileInput" name="photo" type="file" accept="image/*" required />
        </label>

        <input id="title" name="title" type="text" placeholder="Short title (optional)" maxlength="60" />
        <textarea id="caption" name="caption" placeholder="Write a short caption (max 150 chars)"></textarea>

        <div class="actions">
          <button type="submit" class="btn">Upload</button>
          <button type="button" id="clearBtn" class="btn secondary">Clear</button>
          <div id="status" style="margin-left:8px;color:var(--muted);font-size:13px"></div>
        </div>
      </form>

      <p style="margin-top:14px;font-size:13px;color:var(--muted);text-align:center;">
        Tip: crop your photo to square for best fit in the 3×3 grid.
      </p>
    </section>

    <aside class="preview card" id="previewBox" aria-live="polite">
      <div id="previewInner" style="text-align:center;color:#666">
        <div style="font-weight:700;color:#2a3b20">Preview</div>
        <div style="margin-top:10px;font-size:13px">No image selected</div>
      </div>
      <div class="caption" id="previewCaption" style="display:none"></div>
    </aside>
  </main>

  <script>
    // Show content only after auth guard is ready
    (function waitForAuth(){
      const show = () => {
        const el = document.getElementById('protectedContent');
        if (el) { el.style.visibility = 'visible'; el.style.opacity = '1'; }
      };
      if (window.__shreeAuthReady) show();
      else {
        window.addEventListener('shree:auth-ready', show, { once: true });
        setTimeout(() => { if (window.__shreeAuthReady) show(); }, 1500);
      }
    })();

    // Upload + live preview
    (function(){
      const fileInput = document.getElementById('fileInput');
      const caption = document.getElementById('caption');
      const title = document.getElementById('title');
      const previewInner = document.getElementById('previewInner');
      const previewCaption = document.getElementById('previewCaption');
      const status = document.getElementById('status');
      const form = document.getElementById('uploadForm');
      const clearBtn = document.getElementById('clearBtn');

      fileInput.addEventListener('change', () => {
        const f = fileInput.files[0];
        if (!f) {
          previewInner.innerHTML = '<div style="font-size:13px;color:#666">No image selected</div>';
          previewCaption.style.display = 'none';
          return;
        }
        const url = URL.createObjectURL(f);
        previewInner.innerHTML = '<img src="'+url+'" alt="preview" />';
        previewCaption.textContent = caption.value.trim();
        previewCaption.style.display = caption.value.trim() ? 'block' : 'none';
      });

      caption.addEventListener('input', () => {
        previewCaption.textContent = caption.value.trim();
        previewCaption.style.display = caption.value.trim() ? 'block' : 'none';
      });

      clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        caption.value = '';
        title.value = '';
        previewInner.innerHTML = '<div style="font-size:13px;color:#666">No image selected</div>';
        previewCaption.style.display = 'none';
        status.textContent = '';
      });

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (!fileInput.files[0]) { status.textContent = 'Please select an image first.'; return; }
        status.textContent = 'Uploading...';

        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        if (title.value.trim()) fd.append('title', title.value.trim());
        if (caption.value.trim()) fd.append('caption', caption.value.trim());

        try {
          // If your auth-init exposes authFetch, prefer it (adds JWT automatically)
          if (window.authFetch) {
            const res = await window.authFetch('/api/upload', { method: 'POST', body: fd });
            if (!res.ok) throw new Error('Upload failed: ' + res.status);
            status.textContent = 'Uploaded ✓';
            setTimeout(() => status.textContent = '', 1800);
          } else {
            // Fallback: attach Bearer token if available
            let token = null;
            if (window.getAuthToken) token = await window.getAuthToken();
            const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
            const res = await fetch('/api/upload', { method: 'POST', body: fd, headers, credentials: 'include' });
            if (!res.ok) throw new Error('Upload failed: ' + res.status);
            status.textContent = 'Uploaded ✓';
          }
        } catch (err) {
          console.error(err);
          status.textContent = 'Upload error — check console';
          alert('Upload failed. See console for details.');
        }
      });
    })();
  </script>
</body>
</html>
