<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Shreshtha</title>

  <!-- CSP meta MUST be inside head (if used) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; media-src 'self';">

  <!-- Auth / guard scripts (defer so DOM loads first) -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="/auth-init.js?v=6" defer></script>
  <script src="/guard-auth.js?v=6" defer></script>

  <style>
    :root{--cream:#FFE7DA;--peach:#FFB59E;--red:#FF6B6B;--text:#6e2430}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Playfair Display",serif;color:var(--text);background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));min-height:100vh}
    header{text-align:center;padding:24px 12px}
    .logo{font-family:"Italianno",cursive;font-size:38px;text-shadow:0 2px 10px rgba(0,0,0,.15)}
    main{max-width:720px;margin:20px auto;padding:0 18px}
    form.card{background:rgba(255,255,255,.14);padding:18px;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.22)}
    input[type="file"], input[type="text"], textarea{width:100%;padding:10px 12px;margin:0 0 12px;border:0;border-radius:12px}
    button.primary{background:#6e2430;color:#fff;border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer}
    .msg{margin-top:14px;font-size:14px;color:#3d1b1f}
    nav{text-align:center;margin-top:12px}nav a{margin:0 12px; color:inherit; text-decoration:underline}
    .page-links{position:relative; z-index:999; text-align:center; margin:8px 0 18px; font-size:15px}
    #fxCanvas{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:95;}
  </style>
</head>

<body>
  <div class="page-links">
    <a href="/life.html">Life</a> |
    <a href="/gallery.html">Gallery</a> |
    <!-- Prefer server logout route; see server.js below -->
    <a href="/auth/logout">Logout</a>
  </div>

  <header>
    <div class="logo">Upload a Sweet Memory</div>
  </header>

  <main>
    <form id="upForm" class="card" enctype="multipart/form-data" novalidate>
      <label for="photo">Choose photo</label>
      <input type="file" id="photo" name="photo" accept="image/*" required />
      <label for="caption">Caption</label>
      <textarea id="caption" name="caption" placeholder="Write a short caption" rows="2"></textarea>

      <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
        <button id="uploadBtn" class="primary" type="button">Upload</button>
        <div id="msg" class="msg" aria-live="polite"></div>
      </div>
    </form>
  </main>

  <!-- Minimal client-side auth guard stub (safe) -->
  <script>
    // If you have a real requireAuth from guard-auth.js, it will override this stub.
    window.requireAuth = window.requireAuth || function() {
      // stub returns "logged in" like object so code relying on requireAuth doesn't throw
      return Promise.resolve({ email: 'guest@local' });
    };
  </script>

  <!-- Single upload handler (fetch to /api/upload). Keeps UI friendly and prevents accidental form.submit -->
  <script>
    (function () {
      const form = document.getElementById('upForm');
      const btn = document.getElementById('uploadBtn');
      const msg = document.getElementById('msg');

      async function doUpload() {
        msg.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Uploading…';

        const fileInput = document.getElementById('photo');
        if (!fileInput.files || fileInput.files.length === 0) {
          msg.textContent = 'Please choose a photo first.';
          btn.disabled = false;
          btn.textContent = 'Upload';
          return;
        }

        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        fd.append('caption', document.getElementById('caption').value || '');

        try {
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          });

          if (!res.ok) {
            // try to get JSON error if provided
            let txt = await res.text().catch(() => '');
            throw new Error(`${res.status} ${res.statusText} ${txt}`);
          }

          const j = await res.json().catch(() => ({}));
          if (j && j.ok === false) throw new Error(j.error || 'Upload failed');

          msg.textContent = 'Uploaded ✓ — redirecting…';
          setTimeout(() => window.location.href = '/gallery.html', 700);
        } catch (err) {
          console.error('Upload failed', err);
          msg.textContent = 'Upload failed — try again.';
          alert('Upload failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
          btn.textContent = 'Upload';
        }
      }

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        doUpload();
      });

      // Optional: allow Enter to submit (from caption)
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        doUpload();
      });

      // Run auth gate if present
      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (typeof requireAuth === 'function') {
            requireAuth().catch(e => console.warn('Auth check failed', e));
          }
        } catch (e) {
          console.warn('Auth guard error', e);
        }
      });
    })();
  </script>

  <!-- Canvas hearts animation (kept same as your original, pointer-events none) -->
  <div id="fxRoot" aria-hidden="true"><canvas id="fxCanvas"></canvas></div>
  <script>
  (function(){
    const c = document.getElementById('fxCanvas');
    if (!c) return;
    const ctx = c.getContext('2d');
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    let W = 0, H = 0, hearts = [];
    const COLORS = ['#dff7ff','#fff9d6','#ffe9d2','#ffdce6','#e9f7e9','#eae8ff','#fff0f6','#fff4de'];
    function R(a,b){ return Math.random()*(b-a)+a; }
    function resize(){ W = innerWidth * DPR; H = innerHeight * DPR; c.width = W; c.height = H; c.style.width='100vw'; c.style.height='100vh'; }
    function spawn(){ if(hearts.length>22) return; hearts.push({ x:R(0,W), y:H+R(8*DPR,160*DPR), s:R(12,34), vx:R(-6,6), vy:-R(12,32), a:R(.55,.98), r:R(-.5,.5), vr:R(-.012,.012), color: COLORS[Math.floor(Math.random()*COLORS.length)] }); }
    function drawHeart(px,py,scale,rot,alpha,color){ ctx.save(); ctx.translate(px,py); ctx.rotate(rot); ctx.scale(scale,scale); ctx.globalAlpha = Math.min(1, alpha * 1.05); ctx.shadowColor = color; ctx.shadowBlur = 14 * scale; const g = ctx.createRadialGradient(0,-0.12,0.05,0,0.12,1.0); g.addColorStop(0,color); g.addColorStop(0.6,color); g.addColorStop(1,'rgba(255,255,255,0.08)'); ctx.fillStyle = g; ctx.beginPath(); ctx.moveTo(0,-0.5); ctx.bezierCurveTo(0.45,-1.05,1.15,-0.05,0,0.8); ctx.bezierCurveTo(-1.15,-0.05,-0.45,-1.05,0,-0.5); ctx.fill(); ctx.globalAlpha = 0.55 * alpha; ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.ellipse(0.18,-0.28,0.12,0.06,-0.4,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.shadowBlur = 0; }
    function tick(){ ctx.clearRect(0,0,W,H); if(Math.random() < 0.11) spawn(); hearts.forEach(h => { h.x += h.vx * 0.016; h.y += h.vy * 0.016; h.r += h.vr; h.a -= 0.0009; }); hearts = hearts.filter(h => h.y > -120*DPR && h.a > 0.02); hearts.forEach(h => drawHeart(h.x,h.y,(h.s/50)*DPR,h.r,h.a,h.color)); requestAnimationFrame(tick); }
    addEventListener('resize', resize, { passive:true }); resize(); tick();
  })();
  </script>

</body>
</html>
