<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Sweet Memories</title>

  <!-- Auth (your project paths) -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <style>
    :root{
      --ink:#1e2a2a;
      --text:#2b1d15;
      --accent:#b57539;
      --chip:rgba(255,255,255,0.28);
      --card:rgba(255,255,255,0.76);
      --card2:rgba(255,255,255,0.62);
      font-family:"Playfair Display",serif;
    }

    /* ====== Painterly Background (teal + ochre abstract) ====== */
    html,body{height:100%;margin:0}
    body{
      color:var(--text);
      background:
        /* big soft sand sweep */
        radial-gradient(1200px 800px at 120% 40%, rgba(211,150,93,0.22), transparent 60%),
        radial-gradient(1000px 700px at -10% 85%, rgba(246,209,173,0.28), transparent 55%),
        /* teal wash */
        radial-gradient(1200px 900px at 18% 22%, rgba(40,104,106,0.35), transparent 58%),
        /* base warm */
        linear-gradient(165deg,#faf1e9 0%, #f3e2d3 28%, #edd6c4 52%, #e7cab2 76%, #e2c2a9 100%);
      background-attachment: fixed,fixed,fixed,fixed;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      position:relative;
    }

    /* textured “brush noise” overlay (SVG grain) */
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background-image:
        url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>\
<filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 0 .05 .09 .12 .15 .12 .09 .05 0 0 0 0 0'/></feComponentTransfer></filter>\
<rect width='120' height='120' filter='url(%23n)' opacity='.65' />\
</svg>");
      mix-blend-mode:multiply;
      opacity:.55;
    }

    /* directional “strokes” sweep (masked gradient ribbons) */
    body::after{
      content:"";
      position:fixed; inset:-8vw -8vw -8vw -8vw; pointer-events:none;
      background:
        linear-gradient(15deg, rgba(195,122,58,0.35), rgba(195,122,58,0.00) 60%),
        linear-gradient(-12deg, rgba(34,93,96,0.32), rgba(34,93,96,0.00) 58%),
        linear-gradient(185deg, rgba(255,255,255,0.18), rgba(255,255,255,0.00) 40%);
      -webkit-mask-image: repeating-linear-gradient(12deg, rgba(0,0,0,.12) 0 8px, rgba(0,0,0,0) 8px 22px);
              mask-image: repeating-linear-gradient(12deg, rgba(0,0,0,.12) 0 8px, rgba(0,0,0,0) 8px 22px);
      opacity:.8;
    }

    /* ====== Layout ====== */
    header{ text-align:center; padding:18px 12px 6px; }
    .page-links a{
      display:inline-block; padding:6px 10px; margin:0 4px; border-radius:16px;
      background:var(--chip); color:#2c1a12; text-decoration:none;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
    }
    .page-links a:hover{ background:rgba(255,255,255,0.4) }

    h1{ margin:8px 0 16px; font-size:42px; color:#3a0e16; text-shadow:0 8px 18px rgba(0,0,0,.08) }

    main{ max-width:1000px; margin:12px auto 64px; padding:0 18px; position:relative; z-index:1; }
    .grid{ display:grid; grid-template-columns:1fr 420px; gap:24px; align-items:start; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    .card{
      background:linear-gradient(135deg, var(--card), var(--card2));
      border-radius:16px;
      box-shadow:0 18px 44px rgba(0,0,0,0.22);
      backdrop-filter: blur(6px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.38);
      padding:20px 18px 18px;
    }

    label{ display:block; font-size:16px; margin:10px 0 8px; color:#3b2117 }
    input[type="file"], input[type="text"], textarea{
      width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
      background:#fff; font-family:inherit; font-size:15px; color:#3a291f;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    }
    textarea{ min-height:110px; resize:vertical }

    .drop{
      margin-top:6px; border:1.5px dashed rgba(58,41,31,.22); border-radius:16px;
      padding:26px 16px; text-align:center; color:#4e3a2e; background:rgba(255,255,255,.64);
      transition: border-color .2s, background .2s, transform .1s;
    }
    .drop.dragover{ border-color:#2e6669; background:rgba(215,240,237,.62); transform:scale(1.005) }

    .btn{
      display:inline-block; margin-top:14px; padding:10px 16px; border:none; border-radius:12px; cursor:pointer;
      background:linear-gradient(92deg,#b57539,#d38f4c); color:#fff; font-weight:700;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
    .btn.secondary{ background:transparent; color:#3a291f; border:1px solid rgba(0,0,0,.1) }

    .meta{ font-size:13px; color:#4a3a32; opacity:.9 }

    .preview{
      border-radius:14px; overflow:hidden; min-height:320px;
      background:linear-gradient(180deg, rgba(255,255,255,.66), rgba(255,255,255,.48));
      display:flex; align-items:center; justify-content:center; position:relative; padding:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.24);
    }
    .preview img{ max-width:100%; max-height:100%; object-fit:contain; border-radius:10px }
    .pcaption{
      position:absolute; left:12px; right:12px; bottom:12px;
      background:rgba(0,0,0,.32); color:#fff; padding:8px 10px; font-size:13px;
      border-radius:8px; text-align:center; backdrop-filter: blur(2px); display:none;
    }

    .bar{ height:6px; background:rgba(0,0,0,.08); border-radius:10px; overflow:hidden; margin-top:10px }
    .bar > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#2a6e71,#b57539) }

  </style>
</head>
<body>
  <!-- header nav like life/gallery -->
  <header>
    <div class="page-links">
      <a href="life.html">Life</a>
      <a href="gallery.html">Gallery</a>
      <a href="/logout.html">Logout</a>
    </div>
    <h1>Upload a Sweet Memory</h1>
  </header>

  <main id="protectedContent" style="visibility:hidden;opacity:0;transition:opacity .25s">
    <div class="grid">
      <!-- Left: form -->
      <section class="card">
        <form id="uploadForm" autocomplete="off">
          <div class="drop" id="drop">
            <div style="font-weight:700">Drag & drop a photo here</div>
            <div style="margin:6px 0 10px;">or</div>
            <input id="file" name="photo" type="file" accept="image/*" style="display:none" />
            <button type="button" class="btn" id="chooseBtn">Choose file</button>
            <div class="meta" style="margin-top:10px">JPG/PNG • up to 8 MB • After upload you may be redirected to the gallery</div>
          </div>

          <label for="caption" style="margin-top:16px;">Caption (short)</label>
          <textarea id="caption" name="caption" maxlength="150" placeholder="Keep it sweet (max 150 chars)"></textarea>

          <div class="bar"><span id="prog"></span></div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button class="btn" type="submit">Upload</button>
            <button class="btn secondary" type="button" id="clearBtn">Clear</button>
            <span id="msg" class="meta"></span>
          </div>
        </form>
      </section>

      <!-- Right: preview -->
      <aside class="card preview" id="previewBox" aria-live="polite">
        <div id="previewInner" class="meta" style="text-align:center;">
          <div style="font-weight:700;color:#1f332f">Preview</div>
          <div style="margin-top:8px;">No photo selected</div>
        </div>
        <div class="pcaption" id="pcaption"></div>
      </aside>
    </div>
  </main>

  <script>
    /* Reveal only after auth is ready (guard-auth sets window.__shreeAuthReady).
       If your redirects already protect the route, the 2s fallback still keeps it private. */
    (function waitForAuth(){
      const show = ()=>{ const el = document.getElementById('protectedContent'); if(el){ el.style.visibility='visible'; el.style.opacity='1'; } };
      if (window.__shreeAuthReady) show();
      else { window.addEventListener('shree:auth-ready', show, {once:true}); setTimeout(()=>{ if(window.__shreeAuthReady) show(); }, 2000); }
    })();

    (function(){
      const drop = document.getElementById('drop');
      const file = document.getElementById('file');
      const chooseBtn = document.getElementById('chooseBtn');
      const caption = document.getElementById('caption');
      const pcap = document.getElementById('pcaption');
      const pinner = document.getElementById('previewInner');
      const prog = document.getElementById('prog');
      const clearBtn = document.getElementById('clearBtn');
      const msg = document.getElementById('msg');
      const form = document.getElementById('uploadForm');

      function setPreview(f){
        if(!f){ pinner.innerHTML = '<div class="meta">No photo selected</div>'; pcap.style.display='none'; return; }
        const url = URL.createObjectURL(f);
        pinner.innerHTML = '<img src="'+url+'" alt="preview"/>';
        pcap.textContent = caption.value.trim();
        pcap.style.display = pcap.textContent ? 'block' : 'none';
      }

      chooseBtn.addEventListener('click', ()=> file.click());
      file.addEventListener('change', ()=> setPreview(file.files[0]));
      caption.addEventListener('input', ()=> {
        pcap.textContent = caption.value.trim();
        pcap.style.display = caption.value.trim() ? 'block' : 'none';
      });

      ;['dragenter','dragover'].forEach(ev=>{
        drop.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          drop.classList.add('dragover');
        });
      });
      ;['dragleave','drop'].forEach(ev=>{
        drop.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          drop.classList.remove('dragover');
        });
      });
      drop.addEventListener('drop', e=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(f){ file.files = e.dataTransfer.files; setPreview(f); }
      });

      clearBtn.addEventListener('click', ()=>{
        file.value = ''; caption.value = ''; setPreview(null);
        prog.style.width='0%'; msg.textContent='';
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = file.files[0];
        if(!f){ msg.textContent = 'Please select a photo first.'; return; }
        msg.textContent = 'Uploading…';
        prog.style.width = '0%';

        const fd = new FormData();
        fd.append('photo', f);
        if(caption.value.trim()) fd.append('caption', caption.value.trim());

        try{
          // fetch doesn’t give real upload progress; we fake a smooth ramp to 85%, finish on success.
          let fake = 0;
          const tick = setInterval(()=>{ fake = Math.min(fake + 3, 85); prog.style.width = fake + '%'; }, 80);

          let res;
          if(window.authFetch){
            res = await window.authFetch('/api/upload', { method:'POST', body:fd });
          } else {
            let token = null;
            if(window.getAuthToken) token = await window.getAuthToken();
            const headers = token ? { 'Authorization': 'Bearer '+token } : {};
            res = await fetch('/api/upload', { method:'POST', body:fd, headers, credentials:'include' });
          }

          clearInterval(tick);
          if(!res.ok) throw new Error('HTTP '+res.status);
          prog.style.width = '100%';
          msg.textContent = 'Uploaded ✔';
          setTimeout(()=>{ msg.textContent=''; prog.style.width='0%'; /* location.href='gallery.html'; */ }, 900);
        }catch(err){
          prog.style.width = '0%';
          msg.textContent = 'Upload failed: '+err.message;
          console.error(err);
        }
      });
    })();
  </script>
</body>
</html>
