<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Sweet Memories</title>

  <!-- Auth -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <style>
    :root{
      --text:#2a1810;
      --accent:#b97c3c;
      --glass:rgba(255,255,255,0.75);
      font-family:"Playfair Display",serif;
    }
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden;}

    /* 🎨 Oil-Painted Background */
    body{
      background:
        radial-gradient(900px 700px at 85% 15%, rgba(33,94,96,0.45), transparent 65%),
        radial-gradient(1200px 1000px at 15% 85%, rgba(199,137,82,0.55), transparent 65%),
        linear-gradient(180deg,#f8e9d6 0%,#f3ddc4 40%,#e8ccb0 70%,#e3c3a5 100%);
      background-attachment: fixed;
      background-size: cover;
      position: relative;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* Brush texture overlay */
    body::before{
      content:"";
      position:fixed;inset:0;
      background:
        linear-gradient(22deg, rgba(36,105,107,0.25), transparent 60%),
        linear-gradient(-14deg, rgba(184,112,54,0.3), transparent 65%),
        repeating-linear-gradient(18deg, rgba(0,0,0,0.04) 0 6px, transparent 6px 20px);
      mix-blend-mode:multiply;
      pointer-events:none;
      opacity:.9;
    }

    header{text-align:center;padding:18px 12px 10px;}
    .page-links a{
      display:inline-block; margin:0 6px; padding:6px 12px;
      border-radius:18px; background:rgba(255,255,255,0.3);
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
      color:#3b0d14; text-decoration:none; font-size:14px;
    }
    .page-links a:hover{background:rgba(255,255,255,0.45);}
    h1{margin:18px 0 14px;font-size:44px;color:#3b0d14;text-shadow:0 5px 10px rgba(0,0,0,0.12);}

    main{
      max-width:960px; margin:28px auto 90px; padding:0 20px;
      display:grid; grid-template-columns:1fr 420px; gap:26px;
    }
    @media(max-width:950px){main{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(135deg,var(--glass),rgba(255,255,255,0.65));
      border-radius:18px;
      box-shadow:0 16px 44px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px) saturate(120%);
      border:1px solid rgba(255,255,255,0.4);
      padding:20px 22px 24px;
    }

    label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;}
    input[type="file"],textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);
      background:#fff;font-size:15px;color:#3a2a20;
    }
    textarea{min-height:100px;resize:vertical;}

    .drop{
      border:2px dashed rgba(0,0,0,0.15);
      border-radius:16px;padding:28px;text-align:center;
      background:rgba(255,255,255,0.65);
      margin-bottom:14px;transition:all .2s ease;
    }
    .drop.dragover{background:rgba(228,247,246,0.65);border-color:#2d7477;}

    .btn{
      background:linear-gradient(90deg,#b97c3c,#d59756);
      color:#fff;font-weight:700;border:none;padding:10px 18px;
      border-radius:12px;cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);
      margin-top:10px;
    }
    .btn:hover{filter:brightness(1.05);}
    .btn.secondary{background:transparent;color:#3a2a20;border:1px solid rgba(0,0,0,0.12);}

    .preview{
      border-radius:14px;overflow:hidden;min-height:320px;
      background:rgba(255,255,255,0.6);
      display:flex;align-items:center;justify-content:center;
      position:relative;padding:10px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .preview img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;}
    .pcaption{
      position:absolute;left:12px;right:12px;bottom:12px;
      background:rgba(0,0,0,0.35);color:#fff;padding:8px;border-radius:8px;
      font-size:13px;text-align:center;backdrop-filter:blur(2px);display:none;
    }
    .meta{font-size:13px;opacity:.8;margin-top:8px;}
    .bar{height:6px;background:rgba(0,0,0,0.08);border-radius:10px;overflow:hidden;margin-top:10px;}
    .bar span{display:block;height:100%;width:0;background:linear-gradient(90deg,#2d7477,#b97c3c);}
  </style>
</head>
<body>
  <header>
    <div class="page-links">
      <a href="life.html">Life</a>
      <a href="gallery.html">Gallery</a>
      <a href="/logout.html">Logout</a>
    </div>
    <h1>Upload a Sweet Memory</h1>
  </header>

  <main id="protectedContent" style="visibility:hidden;opacity:0;transition:opacity .25s">
    <section class="card">
      <form id="uploadForm" autocomplete="off">
        <div class="drop" id="drop">
          <div style="font-weight:700">Drag & drop a photo here</div>
          <div style="margin:6px 0 10px;">or</div>
          <input id="file" name="photo" type="file" accept="image/*" style="display:none" />
          <button type="button" class="btn" id="chooseBtn">Choose file</button>
          <div class="meta">JPG/PNG • Max 8 MB</div>
        </div>

        <label for="caption">Caption (short)</label>
        <textarea id="caption" name="caption" maxlength="150" placeholder="Write a short caption (max 150 chars)"></textarea>

        <div class="bar"><span id="prog"></span></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn" type="submit">Upload</button>
          <button class="btn secondary" type="button" id="clearBtn">Clear</button>
          <span id="msg" class="meta"></span>
        </div>
      </form>
    </section>

    <aside class="card preview" id="previewBox">
      <div id="previewInner" class="meta" style="text-align:center;">
        <div style="font-weight:700;color:#1f332f;">Preview</div>
        <div style="margin-top:8px;">No photo selected</div>
      </div>
      <div class="pcaption" id="pcaption"></div>
    </aside>
  </main>

  <script>
    // reveal after auth ready
    (function waitForAuth(){
      const el=document.getElementById('protectedContent');
      const show=()=>{el.style.visibility='visible';el.style.opacity='1';};
      if(window.__shreeAuthReady)show();
      else window.addEventListener('shree:auth-ready',show,{once:true});
      setTimeout(()=>{if(window.__shreeAuthReady)show();},1500);
    })();

    (function(){
      const drop=document.getElementById('drop');
      const file=document.getElementById('file');
      const choose=document.getElementById('chooseBtn');
      const caption=document.getElementById('caption');
      const pcap=document.getElementById('pcaption');
      const pinner=document.getElementById('previewInner');
      const prog=document.getElementById('prog');
      const msg=document.getElementById('msg');
      const form=document.getElementById('uploadForm');
      const clear=document.getElementById('clearBtn');

      choose.onclick=()=>file.click();
      file.onchange=()=>setPreview(file.files[0]);
      caption.oninput=()=>{pcap.textContent=caption.value.trim();pcap.style.display=caption.value.trim()?'block':'none';};

      ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('dragover');}));
      ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('dragover');}));
      drop.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f){file.files=e.dataTransfer.files;setPreview(f);}});

      function setPreview(f){
        if(!f){pinner.innerHTML='<div class="meta">No photo selected</div>';pcap.style.display='none';return;}
        const url=URL.createObjectURL(f);
        pinner.innerHTML='<img src="'+url+'" alt="preview"/>';
        pcap.textContent=caption.value.trim();
        pcap.style.display=pcap.textContent?'block':'none';
      }

      clear.onclick=()=>{file.value='';caption.value='';setPreview(null);prog.style.width='0%';msg.textContent='';};

      form.onsubmit=async e=>{
        e.preventDefault();
        const f=file.files[0];
        if(!f){msg.textContent='Please select a photo first.';return;}
        msg.textContent='Uploading…';
        prog.style.width='0%';
        const fd=new FormData();
        fd.append('photo',f);
        if(caption.value.trim())fd.append('caption',caption.value.trim());

        let fake=0;const timer=setInterval(()=>{fake=Math.min(fake+3,85);prog.style.width=fake+'%';},80);
        try{
          let res;
          if(window.authFetch)res=await window.authFetch('/api/upload',{method:'POST',body:fd});
          else{
            let token=window.getAuthToken?await window.getAuthToken():null;
            const headers=token?{'Authorization':'Bearer '+token}:{};
            res=await fetch('/api/upload',{method:'POST',body:fd,headers,credentials:'include'});
          }
          clearInterval(timer);
          if(!res.ok)throw new Error('HTTP '+res.status);
          prog.style.width='100%';
          msg.textContent='Uploaded ✔';
          setTimeout(()=>{msg.textContent='';prog.style.width='0%';},1000);
        }catch(err){
          clearInterval(timer);
          prog.style.width='0%';
          msg.textContent='Upload failed: '+err.message;
          console.error(err);
        }
      };
    })();
  </script>
</body>
</html>
