<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Shreshtha</title>

  <!-- CSP meta MUST be inside head (if used) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; coect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; media-src 'self';">

  <!-- Auth / guard scripts (defer so DOM loads first) -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="/auth-init.js?v=6" defer></script>
  <script src="/guard-auth.js?v=6" defer></script>

  <style>
    :root{--cream:#FFE7DA;--peach:#FFB59E;--red:#FF6B6B;--text:#6e2430}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Playfair Display",serif;color:var(--text);background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));min-height:100vh}
    header{text-align:center;padding:24px 12px}
    .logo{font-family:"Italiao",cursive;font-size:38px;text-shadow:0 2px 10px rgba(0,0,0,.15)}
    main{max-width:720px;margin:20px auto;padding:0 18px}
    form.card{background:rgba(255,255,255,.14);padding:18px;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.22)}
    input[type="file"], input[type="text"], textarea{width:100%;padding:10px 12px;margin:0 0 12px;border:0;border-radius:12px}
    button.primary{background:#6e2430;color:#fff;border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer}
    .msg{margin-top:14px;font-size:14px;color:#3d1b1f}
    nav{text-align:center;margin-top:12px}nav a{margin:0 12px; color:inherit; text-decoration:underline}
    .page-links{position:relative; z-index:999; text-align:center; margin:8px 0 18px; font-size:15px}
    #fxCanvas{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:95;}
  </style>
</head>

<body>
  <div class="page-links">
    <a href="/life.html">Life</a> |
    <a href="/gallery.html">Gallery</a> |
    <!-- Prefer server logout route; see server.js below -->
    <a href="/auth/logout">Logout</a>
  </div>

  <header>
    <div class="logo">Upload a Sweet Memory</div>
  </header>

  <main>
    <form id="upForm" class="card" enctype="multipart/form-data" novalidate>
      <label for="photo">Choose photo</label>
      <input type="file" id="photo" name="photo" accept="image/*" required />
      <label for="caption">Caption</label>
      <textarea id="caption" name="caption" placeholder="Write a short caption" rows="2"></textarea>

      <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
        <button id="uploadBtn" class="primary" type="button">Upload</button>
        <div id="msg" class="msg" aria-live="polite"></div>
      </div>
    </form>
  </main>

  <!-- Minimal client-side auth guard stub (safe) -->
  <script>
    // If you have a real requireAuth from guard-auth.js, it will override this stub.
    window.requireAuth = window.requireAuth || function() {
      // stub returns "logged in" like object so code relying on requireAuth doesn't throw
      return Promise.resolve({ email: 'guest@local' });
    };
  </script>

  <!-- Single upload handler (fetch to /api/upload). Keeps UI friendly and prevents accidental form.submit -->
  <script>
    (function () {
      const form = document.getElementById('upForm');
      const btn = document.getElementById('uploadBtn');
      const msg = document.getElementById('msg');

      async function doUpload() {
        msg.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Uploading…';

        const fileInput = document.getElementById('photo');
        if (!fileInput.files || fileInput.files.length === 0) {
          msg.textContent = 'Please choose a photo first.';
          btn.disabled = false;
          btn.textContent = 'Upload';
          return;
        }

        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        fd.append('caption', document.getElementById('caption').value || '');

        try {
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          });

          if (!res.ok) {
            // try to get JSON error if provided
            let txt = await res.text().catch(() => '');
            throw new Error(`${res.status} ${res.statusText} ${txt}`);
          }

          const j = await res.json().catch(() => ({}));
          if (j && j.ok === false) throw new Error(j.error || 'Upload failed');

          msg.textContent = 'Uploaded ✓ — redirecting…';
          setTimeout(() => window.location.href = '/gallery.html', 700);
        } catch (err) {
          console.error('Upload failed', err);
          msg.textContent = 'Upload failed — try again.';
          alert('Upload failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
          btn.textContent = 'Upload';
        }
      }

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        doUpload();
      });

      // Optional: allow Enter to submit (from caption)
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        doUpload();
      });

      // Run auth gate if present
      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (typeof requireAuth === 'function') {
            requireAuth().catch(e => console.warn('Auth check failed', e));
          }
        } catch (e) {
          console.warn('Auth guard error', e);
        }
      });
    })();
  </script>

  <!-- Canvas hearts animation (kept same as your original, pointer-events none) -->
  <div id="fxRoot" aria-hidden="true"><canvas id="fxCanvas"></canvas></div>
  <script>
  (function(){
    const c = document.getElementById('fxCanvas');
    if (!c) return;
    const ctx = c.getContext('2d');
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    let W = 0, H = 0, hearts = [];
    const COLORS = ['#dff7ff','#fff9d6','#ffe9d2','#ffdce6','#e9f7e9','#eae8ff','#fff0f6','#fff4de'];
    function R(a,b){ return Math.random()*(b-a)+a; }
    function resize(){ W = ierWidth * DPR; H = ierHeight * DPR; c.width = W; c.height = H; c.style.width='100vw'; c.style.height='100vh'; }
    function spawn(){ if(hearts.length>22) return; hearts.push({ x:R(0,W), y:H+R(8*DPR,160*DPR), s:R(12,34), vx:R(-6,6), vy:-R(12,32), a:R(.55,.98), r:R(-.5,.5), vr:R(-.012,.012), color: COLORS[Math.floor(Math.random()*COLORS.length)] }); }
    function drawHeart(px,py,scale,rot,alpha,color){ ctx.save(); ctx.translate(px,py); ctx.rotate(rot); ctx.scale(scale,scale); ctx.globalAlpha = Math.min(1, alpha * 1.05); ctx.shadowColor = color; ctx.shadowBlur = 14 * scale; const g = ctx.createRadialGradient(0,-0.12,0.05,0,0.12,1.0); g.addColorStop(0,color); g.addColorStop(0.6,color); g.addColorStop(1,'rgba(255,255,255,0.08)'); ctx.fillStyle = g; ctx.beginPath(); ctx.moveTo(0,-0.5); ctx.bezierCurveTo(0.45,-1.05,1.15,-0.05,0,0.8); ctx.bezierCurveTo(-1.15,-0.05,-0.45,-1.05,0,-0.5); ctx.fill(); ctx.globalAlpha = 0.55 * alpha; ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.ellipse(0.18,-0.28,0.12,0.06,-0.4,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.shadowBlur = 0; }
    function tick(){ ctx.clearRect(0,0,W,H); if(Math.random() < 0.11) spawn(); hearts.forEach(h => { h.x += h.vx * 0.016; h.y += h.vy * 0.016; h.r += h.vr; h.a -= 0.0009; }); hearts = hearts.filter(h => h.y > -120*DPR && h.a > 0.02); hearts.forEach(h => drawHeart(h.x,h.y,(h.s/50)*DPR,h.r,h.a,h.color)); requestAnimationFrame(tick); }
    addEventListener('resize', resize, { passive:true }); resize(); tick();
  })();
  </script>

<!-- Improved Mini Music Player + Volume Popover (replaces older snippet) -->
<style>
  /* --- smoother global background for private pages --- */
  /* Replace old body background lines with this gradient to remove the visible seam */
  body {
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(255,236,240,0.25), transparent 20%),
      radial-gradient(900px 500px at 95% 85%, rgba(255,240,230,0.18), transparent 18%),
      linear-gradient(160deg, #fff0ef 0%, #ffd6d6 18%, #ffc0be 38%, #ffb3b3 60%, #ffb0b0 100%);
    background-attachment: fixed;
    color: #333;
  }

  /* --- compact heart player container --- */
  .music-btn {
    position: fixed;
    bottom: 22px;
    right: 22px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg,#fffafc 0%,#ffeef2 100%);
    box-shadow: 0 10px 22px rgba(230,100,140,0.18);
    display:flex;align-items:center;justify-content:center;
    z-index:160; border:none; cursor:pointer; transition:transform .18s ease,box-shadow .18s ease;
    backdrop-filter: blur(4px);
  }
  .music-btn:hover { transform: translateY(-4px); box-shadow: 0 16px 30px rgba(230,100,140,0.25); }

  .music-btn svg { width:26px; height:26px; display:block; }
  .music-btn .heart { fill:#ff6b81; transition: transform .18s ease, fill .22s ease; }
  .music-btn.playing .heart { transform: scale(1.08); fill:#ffd166; filter: drop-shadow(0 6px 12px rgba(255,170,80,0.20)); }

  /* little gold volume dot to the right of the heart (click to open volume popover) */
  .vol-dot {
    position: absolute;
    right: -6px;
    top: -6px;
    width:18px;
    height:18px;
    border-radius:50%;
    background: linear-gradient(150deg,#ffd76d,#ffc96a);
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 6px 10px rgba(255,170,100,0.24);
    border: 2px solid rgba(255,255,255,0.9);
    cursor:pointer;
  }
  .vol-dot:active { transform: scale(.96); }

  /* volume popover */
  .vol-pop {
    position: fixed;
    bottom: 84px;
    right: 18px;
    width: 214px;
    padding: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,250,248,0.95));
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    z-index: 170;
    display: none;
    align-items: center;
    gap: 12px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  .vol-pop.show { display: flex; }

  .vol-pop input[type="range"] {
    -webkit-appearance: none; width: 120px; height: 6px; border-radius: 999px;
    background: linear-gradient(90deg,#ffc1c1,#ffd88a);
    outline: none;
  }
  .vol-pop input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none; width:16px;height:16px;border-radius:50%;
    background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 3px solid #ffb0a0;
  }
  .vol-label { font-size:13px; color:#6b2b2b; margin-right:6px; }

  /* small mute button */
  .vol-btn {
    width:30px;height:30px;border-radius:8px;border:none;
    background:#fff;border:1px solid rgba(0,0,0,0.06); cursor:pointer;
    display:flex;align-items:center;justify-content:center;
  }
  .vol-btn svg { width:14px; height:14px; fill:#b04a4a; opacity:.95; }

  /* accessible focus */
  .music-btn:focus, .vol-dot:focus, .vol-btn:focus { outline: 3px solid rgba(255,200,200,0.6); outline-offset:3px; }
</style>

<button id="musicButton" class="music-btn" aria-pressed="false" aria-label="Play background music" title="Play / Pause music">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path class="heart" d="M12 21s-7.33-4.94-9.33-7.02C.8 11.9 2.1 7.9 5.5 6.3 7.2 5.4 9.1 6 10 7.3c.9-1.3 2.8-1.9 4.5-1 3.4 1.6 4.7 5.6 2.8 7.68C19.33 16.06 12 21 12 21z"/>
  </svg>

  <span class="vol-dot" id="volDot" role="button" aria-label="Volume control" title="Open volume control"></span>
</button>

<div id="volPop" class="vol-pop" role="dialog" aria-hidden="true">
  <div class="vol-label" aria-hidden="true">Vol</div>
  <input id="volRange" type="range" min="0" max="100" step="1" value="60" aria-label="Volume slider" />
  <button id="muteBtn" class="vol-btn" aria-pressed="false" title="Mute / unmute" aria-label="Mute or unmute">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M4 10v4h4l5 4V6L8 10H4z"/></svg>
  </button>
</div><script>
(() => {
  const btn = document.getElementById('musicButton');
  const volDot = document.getElementById('volDot');
  const volPop = document.getElementById('volPop');
  const volRange = document.getElementById('volRange');
  const muteBtn = document.getElementById('muteBtn');
  const music = document.getElementById('bgMusic');

  // restore stored state
  let playing = false;
  try {
    const savedVol = localStorage.getItem('shree_music_volume');
    if (savedVol !== null) volRange.value = savedVol;
    const savedPlaying = localStorage.getItem('shree_music_playing');
    if (savedPlaying === '1') { playing = true; }
  } catch(e){}

  // set actual audio volume (0..1)
  function applyVolume() {
    const v = Math.max(0, Math.min(100, parseInt(volRange.value || 60,10)));
    music.volume = v/100;
    if (v === 0) { muteBtn.setAttribute('aria-pressed','true'); } else { muteBtn.setAttribute('aria-pressed','false'); }
    try { localStorage.setItem('shree_music_volume', String(v)); } catch(e){}
  }
  applyVolume();

  function setPlaying(state) {
    playing = !!state;
    btn.setAttribute('aria-pressed', playing ? 'true' : 'false');
    if (playing) {
      btn.classList.add('playing');
      music.play().catch(()=>{});
      try { localStorage.setItem('shree_music_playing','1'); } catch(e){}
      btn.setAttribute('title','Pause music');
    } else {
      btn.classList.remove('playing');
      music.pause();
      try { localStorage.setItem('shree_music_playing','0'); } catch(e){}
      btn.setAttribute('title','Play music');
    }
  }

  // initial play state (do not force autoplay; only restore visual if already allowed)
  if (playing) {
    // try resume playback if browser allows
    music.play().then(()=>{ setPlaying(true); }).catch(()=>{ setPlaying(false); });
  }

  // heart click toggles play/pause
  btn.addEventListener('click', (e) => {
    // if click target was the volDot, handled separately
    if (e.target && (e.target.id === 'volDot' || e.target.closest('#volDot'))) return;
    setPlaying(!playing);
  });

  // show/hide volume popover on volDot click
  volDot.addEventListener('click', (e) => {
    const showing = volPop.classList.toggle('show');
    volPop.setAttribute('aria-hidden', showing ? 'false' : 'true');
    if (showing) { // auto-hide after 6s
      setTimeout(()=>{ volPop.classList.remove('show'); volPop.setAttribute('aria-hidden','true'); }, 6000);
    }
    e.stopPropagation();
  });

  // volume slider changes
  volRange.addEventListener('input', () => {
    applyVolume();
  });

  // mute toggle
  muteBtn.addEventListener('click', () => {
    if (music.volume > 0) {
      volRange.dataset.prev = volRange.value;
      volRange.value = 0;
    } else {
      volRange.value = volRange.dataset.prev || 60;
    }
    applyVolume();
  });

  // close popover when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.vol-pop') && !e.target.closest('#volDot')) {
      volPop.classList.remove('show'); volPop.setAttribute('aria-hidden','true');
    }
  });

  // sync UI when audio events happen
  music.addEventListener('play', ()=> setPlaying(true));
  music.addEventListener('pause', ()=> setPlaying(false));

  // ensure keyboard accessibility
  volDot.tabIndex = 0;
  volDot.addEventListener('keydown', (e)=> { if (e.key==='Enter' || e.key===' ') { e.preventDefault(); volDot.click(); }});

})();
</script>


<!-- MUSIC HEART FIXED -->
<audio id="bgMusicHeart" loop preload="auto" style="display:none">
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>
<button id="musicHeartBtn" style="position:fixed;right:20px;bottom:20px;width:54px;height:54px;border-radius:50%;border:none;background:radial-gradient(circle at 30% 30%,#ffd6e0,#ff9fb0);box-shadow:0 6px 20px rgba(0,0,0,0.15);cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:22px;">♡</button>
<script>
(function(){
 const a=document.getElementById("bgMusicHeart"),b=document.getElementById("musicHeartBtn");
 if(!a||!b)return;
 function u(){b.textContent=a.paused?"♡":"❤";}
 b.onclick=()=>{a.paused?a.play():a.pause();};
 a.onplay=a.onpause=u;
 document.body.addEventListener("click",()=>{a.play().catch(()=>{})},{once:true});
 u();
})();
</script>
<!-- /MUSIC HEART FIXED -->
</body>
</html>





