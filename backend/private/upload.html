<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Sweet Memories</title>

  <!-- Auth (local files) -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <!-- Music (small heart) -->
  <link rel="stylesheet" href="/assets/css/music-heart.css">
  <script src="/assets/js/music-heart.js" defer></script>

  <style>
    :root{
      --text:#2b1410;
      --accent:#b97c3c;
      --glass:rgba(255,255,255,0.78);
      font-family:"Playfair Display",serif;
    }

    html,body{height:100%;margin:0;overflow-x:hidden;}

    /* =========================================================
       FORCE painterly teal–ochre background on this page only
       ========================================================= */
    body#uploadPage{
      color:var(--text);
      /* multi-layer painterly base */
      background:
        radial-gradient(1300px 900px at 16% 84%, rgba(203,138,82,0.46), transparent 60%),
        radial-gradient(1100px 820px at 86% 18%, rgba(33,104,106,0.52), transparent 62%),
        radial-gradient(900px 700px at 52% 42%, rgba(255,244,230,0.45), transparent 65%),
        linear-gradient(180deg, #f7eada 0%, #efd1b4 42%, #e7c3a0 70%, #e3b58d 100%) !important;
      background-attachment: fixed,fixed,fixed,fixed !important;
      background-blend-mode: multiply, normal, screen, normal !important;
      position: relative;
    }
    /* fine canvas stripes */
    body#uploadPage::before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background: repeating-linear-gradient(15deg, rgba(0,0,0,0.05) 0 7px, transparent 7px 22px);
      mix-blend-mode:multiply; opacity:.28;
      z-index:0;
    }
    /* sweeping painterly strokes */
    body#uploadPage::after{
      content:"";
      position:fixed; inset:-10vmax; pointer-events:none;
      background:
        conic-gradient(from 200deg at 0% 90%, rgba(199,137,82,0.0) 0 40deg, rgba(199,137,82,0.35) 40deg 55deg, rgba(199,137,82,0.0) 55deg 360deg),
        conic-gradient(from 210deg at 5% 92%, rgba(199,137,82,0.0) 0 38deg, rgba(199,137,82,0.32) 38deg 52deg, rgba(199,137,82,0.0) 52deg 360deg),
        conic-gradient(from 350deg at 70% 40%, rgba(255,246,233,0.0) 0 18deg, rgba(255,246,233,0.42) 18deg 34deg, rgba(255,246,233,0.0) 34deg 360deg),
        radial-gradient(1000px 700px at 90% 15%, rgba(24,86,91,0.38), transparent 65%),
        radial-gradient(800px 560px at 82% 20%, rgba(24,86,91,0.28), transparent 60%);
      filter: blur(18px) saturate(110%);
      opacity:.9; z-index:0;
    }

    header{text-align:center;padding:18px 12px 10px; position:relative; z-index:1;}
    .page-links a{
      display:inline-block;margin:0 6px;padding:6px 12px;border-radius:18px;
      background:rgba(255,255,255,0.35);box-shadow:0 6px 14px rgba(0,0,0,0.12);
      color:#3b0d14;text-decoration:none;font-size:14px;
    }
    .page-links a:hover{background:rgba(255,255,255,0.5);}
    h1{margin:18px 0 14px;font-size:44px;color:#3b0d14;text-shadow:0 5px 10px rgba(0,0,0,0.12);}

    main{
      max-width:960px;margin:28px auto 90px;padding:0 20px;
      display:grid;grid-template-columns:1fr 420px;gap:26px;
      visibility:hidden;opacity:0;transition:opacity .25s; position:relative; z-index:1;
    }
    @media (max-width:950px){ main{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(135deg,var(--glass),rgba(255,255,255,0.66));
      border-radius:18px;padding:20px 22px 24px;
      box-shadow:0 16px 44px rgba(0,0,0,0.25);
      backdrop-filter:blur(6px) saturate(120%);
      border:1px solid rgba(255,255,255,0.40);
    }

    label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;}
    input[type="file"],textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);
      background:#fff;font-size:15px;color:#3a2a20;
    }
    textarea{min-height:100px;resize:vertical;}

    .drop{
      border:2px dashed rgba(0,0,0,0.15);
      border-radius:16px;padding:28px;text-align:center;
      background:rgba(255,255,255,0.65);margin-bottom:14px;
      transition:all .2s ease;
    }
    .drop.dragover{background:rgba(228,247,246,0.65);border-color:#2d7477;}

    .btn{
      background:linear-gradient(90deg,#b97c3c,#d59756);
      color:#fff;font-weight:700;border:none;padding:10px 18px;border-radius:12px;cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);margin-top:10px;
    }
    .btn:hover{filter:brightness(1.05);}
    .btn.secondary{background:transparent;color:#3a2a20;border:1px solid rgba(0,0,0,0.12);}

    .preview{
      border-radius:14px;overflow:hidden;min-height:320px;background:rgba(255,255,255,0.6);
      display:flex;align-items:center;justify-content:center;position:relative;padding:10px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .preview img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;}
    .pcaption{
      position:absolute;left:12px;right:12px;bottom:12px;background:rgba(0,0,0,0.35);
      color:#fff;padding:8px;border-radius:8px;font-size:13px;text-align:center;backdrop-filter:blur(2px);display:none;
    }
    .meta{font-size:13px;opacity:.85;margin-top:8px;}
    .bar{height:6px;background:rgba(0,0,0,0.10);border-radius:10px;overflow:hidden;margin-top:10px;}
    .bar span{display:block;height:100%;width:0;background:linear-gradient(90deg,#2d7477,#b97c3c);}

    /* Music heart placement */
    #musicHeartWrap{ position:fixed; right:16px; bottom:16px; z-index:9; }
    #musicHeartBtn{ width:44px;height:44px;border-radius:14px; }
  </style>
</head>
<body id="uploadPage">
  <header>
    <div class="page-links">
      <a href="life.html">Life</a>
      <a href="gallery.html">Gallery</a>
      <a href="/logout.html">Logout</a>
    </div>
    <h1>Upload a Sweet Memory</h1>
  </header>

  <main id="protectedContent">
    <section class="card">
      <form id="uploadForm" autocomplete="off">
        <div class="drop" id="drop">
          <div style="font-weight:700">Drag & drop a photo here</div>
          <div style="margin:6px 0 10px;">or</div>
          <input id="file" name="photo" type="file" accept="image/*" style="display:none" />
          <button type="button" class="btn" id="chooseBtn">Choose file</button>
          <div class="meta">JPG/PNG • Max 8 MB</div>
        </div>

        <label for="caption">Caption (short)</label>
        <textarea id="caption" name="caption" maxlength="150" placeholder="Write a short caption (max 150 chars)"></textarea>

        <div class="bar"><span id="prog"></span></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn" type="submit">Upload</button>
          <button class="btn secondary" type="button" id="clearBtn">Clear</button>
          <span id="msg" class="meta"></span>
        </div>
      </form>
    </section>

    <aside class="card preview" id="previewBox">
      <div id="previewInner" class="meta" style="text-align:center;">
        <div style="font-weight:700;color:#1f332f;">Preview</div>
        <div style="margin-top:8px;">No photo selected</div>
      </div>
      <div class="pcaption" id="pcaption"></div>
    </aside>
  </main>

  <script>
    /* Reveal after auth; 2s fallback so UI never stays hidden */
    (function(){
      const el=document.getElementById('protectedContent');
      const show=()=>{el.style.visibility='visible';el.style.opacity='1';};
      if(window.__shreeAuthReady) show();
      else{
        window.addEventListener('shree:auth-ready', show, {once:true});
        setTimeout(()=>{ if(getComputedStyle(el).visibility==='hidden') show(); }, 2000);
      }
    })();

    (function(){
      const drop=document.getElementById('drop');
      const file=document.getElementById('file');
      const choose=document.getElementById('chooseBtn');
      const caption=document.getElementById('caption');
      const pcap=document.getElementById('pcaption');
      const pinner=document.getElementById('previewInner');
      const prog=document.getElementById('prog');
      const msg=document.getElementById('msg');
      const form=document.getElementById('uploadForm');

      choose.onclick=()=>file.click();
      file.onchange=()=>setPreview(file.files[0]);
      caption.oninput=()=>{pcap.textContent=caption.value.trim();pcap.style.display=caption.value.trim()?'block':'none';};

      ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('dragover');}));
      ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('dragover');}));
      drop.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f){file.files=e.dataTransfer.files;setPreview(f);}});

      function setPreview(f){
        if(!f){pinner.innerHTML='<div class="meta">No photo selected</div>';pcap.style.display='none';return;}
        const url=URL.createObjectURL(f);
        pinner.innerHTML='<img src="'+url+'" alt="preview"/>';
        pcap.textContent=caption.value.trim();
        pcap.style.display=pcap.textContent?'block':'none';
      }

      form.onsubmit=async e=>{
        e.preventDefault();
        const f=file.files[0];
        if(!f){msg.textContent='Please select a photo first.';return;}
        msg.textContent='Uploading…';
        prog.style.width='0%';
        const fd=new FormData();
        fd.append('photo',f);
        if(caption.value.trim()) fd.append('caption',caption.value.trim());

        let fake=0; const timer=setInterval(()=>{fake=Math.min(fake+3,85);prog.style.width=fake+'%';},80);

        try{
          let res;
          if(window.authFetch) res=await window.authFetch('/api/upload',{method:'POST',body:fd});
          else{
            let token=window.getAuthToken?await window.getAuthToken():null;
            const headers=token?{'Authorization':'Bearer '+token}:{};
            res=await fetch('/api/upload',{method:'POST',body:fd,headers,credentials:'include'});
          }
          clearInterval(timer);
          if(!res.ok) throw new Error('HTTP '+res.status);
          prog.style.width='100%';
          msg.textContent='Uploaded ✔';
          setTimeout(()=>{msg.textContent='';prog.style.width='0%';},900);
        }catch(err){
          clearInterval(timer);
          prog.style.width='0%';
          msg.textContent='Upload failed: '+err.message;
          console.error(err);
        }
      };

      document.getElementById('clearBtn').onclick=()=>{
        file.value=''; caption.value=''; pcap.style.display='none';
        pinner.innerHTML='<div class="meta">No photo selected</div>';
        msg.textContent=''; prog.style.width='0%';
      };
    })();
  </script>
</body>
</html>
