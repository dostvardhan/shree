<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' 'unsafe-eval';
                 connect-src 'self' https:;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 media-src 'self';">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Shreshtha</title>

  <!-- Auth (kept from your project) -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <link rel="stylesheet" href="/assets/css/music-heart.css">
  <style>
    :root{
      --text:#6e2430;
      --panel:rgba(255,255,255,0.16);
      --panel-solid:#ffe1db;
      --chip:rgba(255,255,255,0.30);
      --accent:#7a2430;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Playfair Display",serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,236,240,0.25), transparent 20%),
        radial-gradient(900px 500px at 95% 85%, rgba(255,240,230,0.18), transparent 18%),
        linear-gradient(160deg, #fff0ef 0%, #ffd6d6 18%, #ffc0be 38%, #ffb3b3 60%, #ffb0b0 100%);
      background-attachment: fixed; overflow-x:hidden;
    }

    header{ text-align:center; padding:18px 12px 0; position:relative; z-index:200; }
    .page-links{ margin:6px 0 10px; font-size:14px; }
    .page-links a{ display:inline-block; padding:6px 10px; margin:0 4px; border-radius:16px; background:var(--chip); color:#5a0013; text-decoration:none; box-shadow:0 4px 8px rgba(0,0,0,0.10); }

    h1{ margin:18px 0 6px; font-size:40px; color:#5a0013; text-shadow:0 6px 10px rgba(0,0,0,0.06); }
    main{ max-width:980px; margin:18px auto 80px; padding:0 18px; position:relative; z-index:110; }

    .card{ background:var(--panel); border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,0.14); padding:18px; max-width:820px; margin:0 auto; backdrop-filter: blur(4px); }

    .upload-grid{ display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start; }
    @media (max-width:880px){ .upload-grid{ grid-template-columns: 1fr; } }

    /* drop area */
    .drop{ border-radius:12px; border:2px dashed rgba(255,255,255,0.14); padding:18px; background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); min-height:260px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    .drop.hover{ border-color: rgba(250,120,150,0.9); box-shadow: 0 12px 30px rgba(250,120,150,0.06); }
    .drop input[type=file]{ display:none }
    .drop .hint{ font-size:15px; color:#6b2330 }
    .drop .btn-file{ margin-top:12px; padding:10px 14px; border-radius:10px; background:var(--accent); color:#fff; border:none; cursor:pointer }

    /* preview column */
    .meta{ padding:10px; display:flex; flex-direction:column; gap:12px }
    .thumb{ width:100%; border-radius:10px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; min-height:200px }
    .thumb img{ max-width:100%; max-height:240px; display:block }

    label{ display:block; font-size:15px; margin-bottom:6px }
    textarea{ width:100%; min-height:110px; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff; font-family:inherit; font-size:15px; color:#4b2b2b; box-shadow: inset 0 1px 3px rgba(0,0,0,0.03); }

    .small{ font-size:13px; color:rgba(0,0,0,0.6) }
    .btn{ display:inline-block; margin-top:8px; padding:10px 16px; border:none; border-radius:12px; cursor:pointer; background:var(--accent); color:#fff; font-weight:600; box-shadow:0 8px 18px rgba(0,0,0,0.12); }
    .btn:disabled{ opacity:0.6; transform:none; cursor:not-allowed }

    .progress{ height:10px; background:rgba(255,255,255,0.12); border-radius:6px; overflow:hidden }
    .progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff9aa8,#ff6f91); }

    #msg{ margin-top:10px; font-size:14px }

    /* hearts canvas */
    #fxCanvas{ position:fixed; inset:0; width:100vw; height:100vh; pointer-events:none; z-index:120; }

    /* music button overrides */
    #musicHeartWrap{ right:14px; bottom:14px; z-index:160; opacity:.97 }
  </style>
</head>
<body>
  <!-- Hearts canvas -->
  <canvas id="fxCanvas" aria-hidden="true"></canvas>

  <header>
    <div class="page-links">
      <a href="life.html">Life</a> |
      <a href="gallery.html">Gallery</a> |
      <a href="/logout.html">Logout</a>
    </div>
    <h1>Upload a Sweet Memory</h1>
  </header>

  <main>
    <div class="card">
      <div class="upload-grid">
        <div>
          <form id="uploadForm" enctype="multipart/form-data" autocomplete="off">
            <div class="drop" id="dropArea" aria-label="Drop photo here">
              <div class="hint">
                <strong>Drag & drop</strong> a photo here, or
                <div style="margin-top:8px">
                  <button type="button" class="btn-file" id="chooseBtn">Choose file</button>
                </div>
                <div class="small" style="margin-top:8px">Recommended: JPG/PNG, max 8MB. After upload you'll be redirected to the gallery.</div>
              </div>
              <input id="photo" name="photo" type="file" accept="image/*" required />
            </div>

            <label for="caption" style="margin-top:14px">Caption (short)</label>
            <textarea id="caption" name="caption" placeholder="Write a short caption (max 140 chars)" maxlength="140"></textarea>

            <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
              <button class="btn" id="submitBtn" type="submit" disabled>Upload</button>
              <div style="flex:1">
                <div class="progress" aria-hidden="true"><i id="progBar"></i></div>
                <div id="msg" aria-live="polite"></div>
              </div>
            </div>
          </form>
        </div>

        <aside class="meta">
          <div class="thumb" id="thumbBox"><span class="small">No photo selected</span></div>
          <div>
            <label>File info</label>
            <div id="fileInfo" class="small">—</div>
          </div>
          <div>
            <label>Tips</label>
            <div class="small">Use a clear close-up, short caption works best. The site keeps photos private to invited users only.</div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- floating hearts script (same as life/gallery) -->
  <script>
  (function(){
    const c = document.getElementById('fxCanvas'); if (!c) return;
    const ctx = c.getContext('2d'); const DPR = Math.max(1, window.devicePixelRatio || 1);
    let W=0,H=0, hearts=[]; const C=['#ffb3c6','#fff6a6','#ffd89e','#d6f5c6','#d6e0ff','#ffd1ea','#ffe3b8'];
    const R=(a,b)=>Math.random()*(b-a)+a;
    function resize(){ W=Math.floor(innerWidth*DPR); H=Math.floor(innerHeight*DPR); c.width=W; c.height=H; c.style.width='100vw'; c.style.height='100vh'; }
    function spawn(){ if(hearts.length>34) return; hearts.push({x:R(0,W),y:H+R(30*DPR,180*DPR),s:R(14,28),vx:R(-6,6),vy:-R(12,26),a:R(.6,.95),r:R(-.5,.5),vr:R(-.01,.01),col:C[(Math.random()*C.length)|0]}); }
    function draw(h){ const {x,y,s,r,a,col}=h; ctx.save(); ctx.translate(x,y); ctx.rotate(r); ctx.scale(s/50*DPR,s/50*DPR); ctx.globalAlpha=a; ctx.beginPath(); ctx.moveTo(0,-.5); ctx.bezierCurveTo(.45,-1.05,1.15,-.05,0,.8); ctx.bezierCurveTo(-1.15,-.05,-.45,-1.05,0,-.5); ctx.fillStyle=col; ctx.fill(); ctx.restore(); }
    function tick(){ ctx.clearRect(0,0,W,H); if(Math.random()<.16) spawn(); hearts.forEach(h=>{h.x+=h.vx*.016*DPR;h.y+=h.vy*.016*DPR;h.r+=h.vr;h.a-=.0009; draw(h)}); hearts=hearts.filter(h=>h.a>.02&&h.y>-140*DPR); requestAnimationFrame(tick); }
    addEventListener('resize',resize,{passive:true}); resize(); tick();
  })();
  </script>

  <!-- upload handler with preview + progress (uses XHR for upload progress) -->
  <script>
  (function(){
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('photo');
    const choose = document.getElementById('chooseBtn');
    const drop = document.getElementById('dropArea');
    const thumb = document.getElementById('thumbBox');
    const info = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    const prog = document.getElementById('progBar');
    const msg = document.getElementById('msg');

    function bytes(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(1)+' MB'; }

    choose.addEventListener('click', ()=> fileInput.click());

    // Drag & drop
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', e=>{ drop.classList.remove('hover'); });
    drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('hover'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) setFile(f); });

    fileInput.addEventListener('change', ()=>{ const f = fileInput.files && fileInput.files[0]; if(f) setFile(f); });

    function setFile(file){
      if(!file.type.startsWith('image/')){ msg.textContent='Please select an image file.'; return }
      if(file.size>8*1024*1024){ msg.textContent='File too large (max 8MB).'; return }
      // preview
      const url = URL.createObjectURL(file);
      thumb.innerHTML = '<img src="'+url+'" alt="preview">';
      info.textContent = file.name + ' — ' + bytes(file.size) + ' — ' + file.type;
      submitBtn.disabled = false;
      // ensure the input has the file (works when dropped): create DataTransfer
      try{ const dt = new DataTransfer(); dt.items.add(file); fileInput.files = dt.files; }catch(e){}
    }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const f = fileInput.files && fileInput.files[0];
      if(!f){ msg.textContent='Please choose a photo first.'; return }
      submitBtn.disabled = true; msg.textContent='Uploading...'; prog.style.width='0%';

      const xhr = new XMLHttpRequest();
      xhr.open('POST','/api/upload', true);
      xhr.withCredentials = true;
      xhr.upload.onprogress = function(ev){ if(ev.lengthComputable){ const p = Math.round(ev.loaded/ev.total*100); prog.style.width = p+'%'; } };
      xhr.onreadystatechange = function(){ if(xhr.readyState===4){
        if(xhr.status>=200 && xhr.status<300){ msg.textContent='Uploaded ✔'; setTimeout(()=> location.href='gallery.html',700); }
        else { msg.textContent='Upload failed: '+xhr.statusText+' ('+xhr.status+')'; submitBtn.disabled=false; }
      } };
      const fd = new FormData(form);
      xhr.send(fd);
    });

    // small accessibility: keyboard choose
    choose.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); fileInput.click(); } });
  })();
  </script>

  <script src="/assets/js/music-heart.js" defer></script>
</body>
</html>
