<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome • Shreshtha</title>

  <!-- CSP: allow our assets + Auth0 + API (render) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline';
          connect-src 'self' https://dev-zzhjbmtzoxtgoz31.us.auth0.com https://shree-drive.onrender.com;
          img-src 'self' data:;
          style-src 'self' 'unsafe-inline';
          media-src 'self';
        ">

  <!-- Auth0 SDK + our auth helpers -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="/auth-init.js" defer></script>
  <script src="/guard-auth.js" defer></script>

  <style>
    :root{
      --ink:#6e2430;
      --bg1:#FFE7DA; --bg2:#FFB59E; --bg3:#FF6B6B;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Playfair Display", serif;
      color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2) 48%,var(--bg3));
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; text-align:center;
      overflow-x:hidden;
    }
    .card{
      width:min(720px,92vw);
      background:rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 18px 40px rgba(0,0,0,.28);
      padding:28px 28px 34px;
      position:relative; z-index:5;
    }
    h1{font-size:42px; margin:6px 0 14px; text-shadow:0 2px 12px rgba(0,0,0,.25)}
    .lead{opacity:.92; margin:0 0 24px}
    .btn{
      display:inline-block; text-decoration:none;
      background:#6e2430; color:#fff; padding:14px 28px;
      border-radius:40px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      font-size:18px; transition:transform .2s ease;
    }
    .btn:hover{ transform:translateY(-2px); }
    .hint{margin-top:14px; font-size:13px; opacity:.8}

    /* auth gate overlay */
    #auth-gate{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(255,255,255,.55); backdrop-filter:blur(3px);
      z-index:20; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#5a1f2a;
    }
    #auth-gate .bubble{
      background:#fff; padding:14px 18px; border-radius:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.12); font-size:15px;
    }

    /* floating hearts (bg) */
    .heart{position:fixed; bottom:-10px; font-size:18px; opacity:.9; pointer-events:none;
           animation:rise linear forwards; z-index:1;}
    @keyframes rise { from{transform:translateY(0) scale(1);opacity:.95}
                      to{transform:translateY(-110vh) scale(1.4);opacity:0} }

    /* tiny music heart */
    #musicWrap{ position:fixed; right:18px; bottom:18px; z-index:30; display:flex; gap:8px; align-items:center; }
    #musicBtn{ width:56px; height:56px; border-radius:50%; border:0; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:22px;
      background:radial-gradient(circle at 30% 30%, #ffd6e0, #ff9fb0);
      box-shadow:0 8px 28px rgba(220,80,110,.14); transition:transform .16s ease, box-shadow .16s ease;
    }
    #musicBtn:active{ transform:scale(.96); }
    #musicBtn.playing{ box-shadow:0 14px 42px rgba(220,80,110,.24); transform:scale(1.04); }
    #musicBtn .sym{ user-select:none; }
    #volPop{ position:fixed; right:86px; bottom:20px; display:none; gap:10px; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,250,248,.95));
      border-radius:12px; padding:10px 12px; box-shadow:0 12px 30px rgba(0,0,0,.12); }
    #volPop.show{ display:flex; }
    #volRange{ -webkit-appearance:none; width:130px; height:7px; border-radius:999px;
      background:linear-gradient(90deg,#ffc1c1,#ffd88a); outline:none; }
    #volRange::-webkit-slider-thumb{
      -webkit-appearance:none; width:14px; height:14px; border-radius:50%;
      background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.12); border:3px solid #ffb0a0;
    }
    #volDot{ width:18px; height:18px; border-radius:50%; margin-left:-4px; cursor:pointer;
      background:linear-gradient(150deg,#ffd76d,#ffc96a); box-shadow:0 6px 10px rgba(255,170,100,.18);
      border:2px solid rgba(255,255,255,.9);
    }
  </style>
</head>
<body>

  <!-- auth gate shown until guard-auth.js allows -->
  <div id="auth-gate" aria-live="polite">
    <div class="bubble">Checking access…</div>
  </div>

  <main class="card" role="main">
    <h1>Welcome to Shreshtha’s Life of Happiness</h1>
    <p class="lead">All memories are private. You must be signed in.</p>
    <a class="btn" href="life.html">Enter Memories</a>
    <div class="hint">You’ll stay signed in unless you log out.</div>
  </main>

  <!-- warm-up ping to wake backend -->
  <script>
    (async () => { try { await fetch("/health", { mode:"no-cors" }); } catch(_){} })();
  </script>

  <!-- run auth guard then remove gate -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const clearGate = () => { const g = document.getElementById("auth-gate"); if (g) g.remove(); };
      try {
        if (typeof requireAuth === "function") {
          Promise.resolve(requireAuth()).then(clearGate).catch(e => { console.error("Auth failed:", e); clearGate(); });
        } else {
          console.error("requireAuth not found"); clearGate();
        }
      } catch(e){ console.error("Auth error:", e); clearGate(); }
    });
  </script>

  <!-- floating hearts background -->
  <script>
    (() => {
      const COLORS = ['#ffd6e0','#ffe8cc','#ffe9ec','#d6f5ff','#c6e5ff','#e5d6ff','#ffd1fa'];
      function spawnHeart(){
        const h = document.createElement('div');
        h.className = 'heart'; h.textContent = '❤';
        h.style.left = (Math.random()*100) + 'vw';
        h.style.color = COLORS[(Math.random()*COLORS.length)|0];
        h.style.fontSize = (16 + Math.random()*16) + 'px';
        h.style.animationDuration = (8 + Math.random()*6) + 's';
        document.body.appendChild(h);
        setTimeout(()=>h.remove(),15000);
      }
      for(let i=0;i<10;i++) spawnHeart();
      setInterval(spawnHeart, 900);
    })();
  </script>

  <!-- tiny music control -->
  <audio id="bgMusic" loop preload="auto" style="display:none">
    <source src="/music/bg.mp3" type="audio/mpeg" />
  </audio>

  <div id="musicWrap" aria-hidden="false">
    <button id="musicBtn" type="button" aria-label="Toggle background music" title="Play / Pause">
      <span class="sym" aria-hidden="true">♡</span>
    </button>
    <div id="volDot" title="Volume" aria-label="Volume control" role="button" tabindex="0"></div>

    <div id="volPop" role="dialog" aria-hidden="true">
      <div style="font-size:13px;color:#6b2b2b;">Vol</div>
      <input id="volRange" type="range" min="0" max="100" step="1" value="60" aria-label="Volume slider" />
      <button id="muteBtn" style="border:none;background:#fff;padding:6px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.06);cursor:pointer"
              aria-pressed="false" title="Mute/unmute">M</button>
    </div>
  </div>

  <script>
    (() => {
      const audio = document.getElementById('bgMusic');
      const btn   = document.getElementById('musicBtn');
      const sym   = btn.querySelector('.sym');
      const volDot   = document.getElementById('volDot');
      const volPop   = document.getElementById('volPop');
      const volRange = document.getElementById('volRange');
      const muteBtn  = document.getElementById('muteBtn');

      function setIcon(){ sym.textContent = audio.paused ? '♡' : '❤'; btn.classList.toggle('playing', !audio.paused); }
      function applyVol(v){ audio.volume = Math.max(0, Math.min(100, v))/100; try{localStorage.setItem('shree_music_volume', String(v));}catch{}; muteBtn.setAttribute('aria-pressed', audio.volume===0 ? 'true':'false'); }

      // restore
      try {
        const sv = localStorage.getItem('shree_music_volume');
        if (sv !== null) volRange.value = sv;
      } catch {}
      applyVol(parseInt(volRange.value, 10) || 60);

      // autostart if previously playing (best-effort)
      try {
        if (localStorage.getItem('shree_music_playing') === '1') {
          audio.play().catch(()=>{ /* ignored */ });
        }
      } catch {}

      btn.addEventListener('click', () => {
        if (audio.paused) {
          audio.play().then(()=>{ try{localStorage.setItem('shree_music_playing','1');}catch{}; setIcon(); }).catch(()=>{});
        } else {
          audio.pause(); try{localStorage.setItem('shree_music_playing','0');}catch{}; setIcon();
        }
      });

      volDot.addEventListener('click', (e) => {
        const show = !volPop.classList.contains('show');
        volPop.classList.toggle('show', show);
        volPop.setAttribute('aria-hidden', show ? 'false' : 'true');
        e.stopPropagation();
      });
      volDot.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); volDot.click(); }});

      volRange.addEventListener('input', () => applyVol(parseInt(volRange.value,10)||0));
      muteBtn.addEventListener('click', () => {
        if (audio.volume > 0) { volRange.dataset.prev = volRange.value; volRange.value = 0; }
        else { volRange.value = volRange.dataset.prev || 60; }
        volRange.dispatchEvent(new Event('input'));
      });
      document.addEventListener('click', (e)=>{ if(!e.target.closest('#volPop') && !e.target.closest('#volDot')) { volPop.classList.remove('show'); volPop.setAttribute('aria-hidden','true'); } });

      audio.addEventListener('play', setIcon);
      audio.addEventListener('pause', setIcon);
      setIcon();
    })();
  </script>
</body>
</html>
