<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shreshtha – Gallery</title>

<!-- Auth & guards -->
<script src="/auth0-spa-js.production.js"></script>
<script src="auth-init.js" defer></script>
<script src="guard-auth.js" defer></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Italianno&display=swap" rel="stylesheet">
<style>
  :root{
    --cream:#FFE7DA; --peach:#FFB59E; --red:#FF6B6B;
    --text:#6e2430; --panel:rgba(255,255,255,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Playfair Display",serif;
    color:var(--text);
    background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));
    overflow-x:hidden;
  }
  header{text-align:center;padding:24px 12px;position:relative;z-index:5}
  .logo{font-family:"Italianno",cursive;font-size:46px;text-shadow:0 2px 10px rgba(0,0,0,.25);}
  nav{margin-top:8px;}
  nav a{margin:0 12px;padding:8px 18px;background:rgba(255,255,255,.15);
        border-radius:999px;text-decoration:none;color:var(--text);
        box-shadow:0 4px 8px rgba(0,0,0,.18);}
  nav a:hover{background:rgba(255,255,255,.3);}
  main{max-width:1200px;margin:30px auto;padding:0 18px;position:relative;z-index:5}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;}

  .photo-card{
    background:var(--panel);
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 18px 40px rgba(0,0,0,.18);
    transition:transform .28s cubic-bezier(.2,.9,.3,1);
    display:flex;
    flex-direction:column;
  }
  .photo-card:hover{transform:translateY(-6px);}
  .photo-card a{display:block;flex:1}
  .photo-card img{
    width:100%;
    border-radius:12px;
    object-fit:contain;
    display:block;
    max-height:360px;
    background:#fff9f7;
  }
  .meta{padding:10px 12px 14px;text-align:center;font-style:italic;font-size:14px;color:#48242a;}
  .empty{text-align:center;font-size:18px;margin-top:80px;opacity:.9;color:#4b2b2b}

  /* floating hearts canvas base */
  #fxCanvas{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:0;}
  .heart{position:fixed;font-size:18px;opacity:.75;pointer-events:none;z-index:0;
         animation:floatUp linear infinite;}
  @keyframes floatUp{
    0%{transform:translateY(0) scale(1);opacity:.95;}
    100%{transform:translateY(-120vh) scale(1.4);opacity:0;}
  }

  /* pager */
  #pager{display:flex;justify-content:center;gap:12px;align-items:center;margin:18px 0;}
  #pager button{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);cursor:pointer;background:rgba(255,255,255,0.12)}
  #pager button:disabled{opacity:0.45;cursor:default}
</style>
</head>
<body>
<header>
  <div class="logo">Gallery of Sweet Memories</div>
  <nav>
    <a href="life.html">Back to Life</a>
    <a href="upload.html">Upload</a>
    <a href="/auth/logout">Logout</a>
  </nav>
</header>

<main>
  <section id="grid" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none;">No photos uploaded yet 🌸</div>

  <div id="pager">
    <button id="prevBtn" disabled>← Prev</button>
    <div id="pageInfo" style="font-weight:600;"></div>
    <button id="nextBtn">Next →</button>
  </div>
</main>

<script>
/* Reveal content only after auth check completes (if requireAuth exists) */
document.addEventListener("DOMContentLoaded", () => {
  const reveal = () => { const gate = document.getElementById("auth-gate"); if (gate) gate.remove(); };
  try {
    if (typeof requireAuth === "function") {
      Promise.resolve(requireAuth()).then(reveal).catch(e => { console.warn("Auth check failed, continuing:", e); reveal(); });
    } else { reveal(); }
  } catch(e){ console.error("Auth error:", e); reveal(); }
});
</script>

<script>
/* GALLERY: pagination + render (uses /api/photos + /api/file/:id streaming for full-quality images) */
(function(){
  const PAGE_SIZE = (() => {
    const w = window.innerWidth || 0;
    if (w >= 1400) return 40;
    if (w >= 1000) return 30;
    if (w >= 700)  return 24;
    return 20;
  })();

  const TRAIL_KEY = "gallery_token_trail_v1";
  const readTrail = () => { try{ return JSON.parse(sessionStorage.getItem(TRAIL_KEY)||"[]"); }catch(e){return [];} }
  const writeTrail = (arr) => { try{ sessionStorage.setItem(TRAIL_KEY, JSON.stringify(arr)); }catch(e){} }

  const url = new URL(location.href);
  const token = url.searchParams.get("pageToken") || null;
  const pageSize = Math.max(1, Number(url.searchParams.get("pageSize")||PAGE_SIZE));

  const grid = document.querySelector("#grid");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pageInfo = document.getElementById("pageInfo");
  const emptyEl = document.getElementById("empty");

  let trail = readTrail();
  if (token && (trail.length===0 || trail[trail.length-1] !== token)) trail.push(token);
  if (!token) trail = [];
  writeTrail(trail);

  function setStatus(t){ if(pageInfo) pageInfo.textContent = t; }

  async function loadPage(){
    setStatus("Loading…");
    if (prevBtn) prevBtn.disabled = (trail.length <= 1);
    if (nextBtn) nextBtn.disabled = true;

    try {
      const qs = new URLSearchParams({ pageSize: String(pageSize) });
      if (token) qs.set("pageToken", token);

      const resp = await fetch(`/api/photos?${qs.toString()}`, { credentials: "include" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const items = data.items || [];
      const nextToken = data.nextPageToken || null;

      grid.innerHTML = "";
      if (!items.length) { if (emptyEl) emptyEl.style.display = "block"; }
      else { if (emptyEl) emptyEl.style.display = "none"; }

      items.forEach((f) => {
        const anchor = document.createElement("a");
        anchor.href = f.driveWebViewLink || "#";
        anchor.target = "_blank";
        anchor.rel = "noopener";

        const img = document.createElement("img");

        // <<< IMPORTANT: use backend streaming endpoint for full-quality image bytes >>>
        // encodeURIComponent ensures special chars in id are safe
        const fileUrl = `/api/file/${encodeURIComponent(f.id)}`;
        img.src = fileUrl;
        // helpful srcset (backend currently streams original; srcset entries only help cache keys/responsive browsers)
        img.srcset = `${fileUrl}?w=1024 1024w, ${fileUrl}?w=640 640w`;
        img.sizes = "(max-width:700px) 100vw, 33vw";
        img.alt = f.name || 'photo';
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";

        anchor.appendChild(img);

        const card = document.createElement("div");
        card.className = "photo-card";
        card.appendChild(anchor);

        if (f.caption) {
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = f.caption;
          card.appendChild(meta);
        }
        grid.appendChild(card);
      });

      // pager handlers
      nextBtn.disabled = !nextToken;
      if (nextBtn) nextBtn.onclick = () => {
        const u = new URL(location.href);
        u.searchParams.set("pageSize", String(pageSize));
        if (nextToken) u.searchParams.set("pageToken", nextToken);
        let t = readTrail();
        if (token && (t.length===0 || t[t.length-1] !== token)) t.push(token);
        writeTrail(t);
        location.href = u.toString();
      };

      if (prevBtn) prevBtn.onclick = () => {
        let t = readTrail();
        if (t.length > 0) t.pop();
        const prevToken = (t.length > 0) ? t[t.length-1] : null;
        writeTrail(t);
        const u = new URL(location.href);
        u.searchParams.set("pageSize", String(pageSize));
        if (prevToken) u.searchParams.set("pageToken", prevToken); else u.searchParams.delete("pageToken");
        location.href = u.toString();
      };

      const pageNum = (trail.length>0) ? (trail.length + 1) : 1;
      setStatus(`Page ${pageNum} • ${pageSize} per page`);

    } catch (e) {
      console.error("Gallery load failed:", e);
      setStatus("Failed to load photos.");
      if (emptyEl) emptyEl.style.display = "block";
    }
  }

  loadPage();
})();
</script>

<!-- START: floating hearts (canvas) - slower + multi-color -->
<div id="fxRoot" aria-hidden="true"><canvas id="fxCanvas"></canvas></div>
<script>
(()=> {
  const c = document.getElementById("fxCanvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  let W,H;
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  let hs = [];
  const COLORS = ["#ff85a7","#ffd28f","#ffb3c6","#a6f0c6","#ffd1ea","#c6e7ff"];
  function R(a,b){ return Math.random()*(b-a)+a; }
  function resize(){ W = innerWidth * DPR; H = innerHeight * DPR; c.width = W; c.height = H; }
  function spawn(){
    if (hs.length > 18) return;
    hs.push({
      x: R(0, W),
      y: H + R(10*DPR, 120*DPR),
      s: R(10, 26),
      vx: R(-8, 8),
      vy: -R(20, 40),
      a: R(.35, .72),
      r: R(-.5, .5),
      vr: R(-.01, .01),
      color: COLORS[Math.floor(Math.random() * COLORS.length)]
    });
  }
  function heart(px,py,s,rot,a,color){
    ctx.save(); ctx.translate(px,py); ctx.rotate(rot); ctx.scale(s,s);
    ctx.globalAlpha = a; ctx.fillStyle = color;
    ctx.beginPath(); ctx.moveTo(0,-0.5);
    ctx.bezierCurveTo(0.5,-1.1,1.3,-0.1,0,0.8);
    ctx.bezierCurveTo(-1.3,-0.1,-0.5,-1.1,0,-0.5);
    ctx.fill(); ctx.restore();
  }
  function tick(){
    ctx.clearRect(0,0,W,H);
    if (Math.random() < 0.08) spawn();
    hs.forEach(h => { h.x += h.vx * 0.016; h.y += h.vy * 0.016; h.r += h.vr; h.a -= 0.0009; });
    hs = hs.filter(h => (h.y > -60*DPR) && (h.a > 0.03));
    hs.forEach(h => heart(h.x, h.y, h.s/50*DPR, h.r, h.a, h.color));
    requestAnimationFrame(tick);
  }
  addEventListener("resize", resize, { passive:true });
  resize(); tick();
})();
</script>
<!-- END: floating hearts -->

<!-- DOM hearts fallback (slower + color variety) -->
<script>
(function(){
  if (window.__heartsInjected) return; window.__heartsInjected = true;
  const COLORS = ['#ff85a7','#ffd28f','#ffb3c6','#a6f0c6','#ffd1ea','#c6e7ff'];
  function spawnHeart(){
    const h = document.createElement('div'); h.className = 'heart'; h.textContent = '❤️';
    h.style.left = (Math.random()*100) + 'vw';
    h.style.top = (82 + Math.random()*14) + 'vh';
    h.style.animationDuration = (8 + Math.random()*5) + 's';
    h.style.color = COLORS[Math.floor(Math.random()*COLORS.length)];
    h.style.fontSize = (14 + Math.random()*16) + 'px';
    h.style.opacity = 0.85; h.style.pointerEvents = 'none'; h.style.zIndex = 0;
    document.body.appendChild(h); setTimeout(()=> h.remove(), 14000);
  }
  for (let i=0;i<6;i++) spawnHeart();
  setInterval(spawnHeart, 1600);
})();
</script>
</body>
</html>
