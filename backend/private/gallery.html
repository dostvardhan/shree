<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; media-src 'self';">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shreshtha – Gallery</title>

  <!-- Auth & guards -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <style>
    :root{
      --cream:#FFE7DA; --peach:#FFB59E; --red:#FF6B6B;
      --text:#6e2430; --panel:rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Playfair Display",serif;
      color:var(--text);
      background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));
      overflow-x:hidden;
    }

    header { text-align:center; padding:24px 12px; position:relative; z-index:100; }
    .logo{ font-family:"Italiao",cursive; font-size:46px; text-shadow:0 2px 10px rgba(0,0,0,.25); }
    nav{ margin-top:8px; }
    nav a{
      margin:0 12px; padding:8px 18px; background:rgba(255,255,255,.15);
      border-radius:999px; text-decoration:none; color:var(--text);
      box-shadow:0 4px 8px rgba(0,0,0,.12);
    }
    nav a:hover{ background:rgba(255,255,255,.28); }

    main { max-width:1200px; margin:30px auto; padding:0 18px; position:relative; z-index:5; }
    .grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:22px; }

    .photo-card{
      background:var(--panel);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.14);
      transition:transform .28s cubic-bezier(.2,.9,.3,1);
      display:flex; flex-direction:column;
    }
    .photo-card:hover{ transform:translateY(-6px); }
    .photo-card a{ display:block; flex:1; }
    .photo-card img{
      width:100%;
      border-radius:12px;
      object-fit:contain;
      display:block;
      max-height:420px;
      background:#fff9f7;
      cursor:zoom-in;
    }
    .meta{ padding:10px 12px 14px; text-align:center; font-style:italic; font-size:14px; color:#48242a; }
    .meta:empty{ display:none; } /* hide empty captions */
    .empty{ text-align:center; font-size:18px; margin-top:80px; opacity:.95; color:#4b2b2b }

    /* Pager */
    #pager{ display:flex; justify-content:center; gap:12px; align-items:center; margin:18px 0; z-index:6; position:relative; }
    #pager button{ padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; background:rgba(255,255,255,0.12); }
    #pager button:disabled{ opacity:0.45; cursor:default; }

    /* Canvas hearts sits above photos but below header */
    #fxCanvas {
      position:fixed;
      left:0; top:0;
      width:100vw; height:100vh;
      pointer-events:none;
      z-index:60; /* above main/photos, below header (header=100) */
    }

    /* lightbox styles */
    #lightbox { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200; }
    #lbBack { position:absolute; inset:0; background:rgba(6,8,10,0.72); backdrop-filter: blur(6px); }
    #lbContent { position:relative; max-width:95vw; max-height:92vh; z-index:201; display:flex; flex-direction:column; align-items:center; }
    #lbContent img { max-width:100%; max-height:86vh; border-radius:12px; box-shadow:0 24px 60px rgba(0,0,0,.6); }
    #lbClose { position:absolute; right:-6px; top:-18px; background:rgba(255,255,255,0.9); border-radius:999px; border:none; padding:6px 8px; cursor:pointer; font-size:16px; z-index:202; }
    #lbCaption { margin-top:12px; color:#f6efe8; font-size:16px; text-align:center; max-width:90vw; }
    @media (max-width:600px){
      .logo{ font-size:34px; }
      #lbCaption { font-size:14px; }
      #lbClose{ right:6px; top:6px; }
    }
  </style>
</head>
<body>
  <header class="hero" style="text-align:center;margin-top:24px;margin-bottom:6px;">
    <h1 class="page-title" style="font-size:48px;margin:0;color:#5a0013;text-shadow:0 6px 10px rgba(0,0,0,0.08);">
      Gallery of Sweet Memories
    </h1>
    <div class="page-links" style="text-align:center;margin:8px 0 18px;font-size:15px;">
      <a href="life.html">Life</a> &nbsp;|&nbsp;
      <a href="upload.html">Upload</a> &nbsp;|&nbsp;
      <a href="logout.html">Logout</a>
    </div>
  </header>

  <main>
    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" style="display:none;">No photos uploaded yet 🌸</div>

    <div id="pager" aria-hidden="false">
      <button id="prevBtn" disabled>← Prev</button>
      <div id="pageInfo" style="font-weight:600;"></div>
      <button id="nextBtn">Next →</button>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" aria-hidden="true">
    <div id="lbBack"></div>
    <div id="lbContent" role="dialog" aria-modal="true">
      <button id="lbClose" aria-label="Close">✕</button>
      <img id="lbImage" alt="">
      <div id="lbCaption" class="meta"></div>
    </div>
  </div>

  <!-- Hearts canvas root -->
  <div id="fxRoot"><canvas id="fxCanvas"></canvas></div>
  <script src="/hearts.js" defer></script>

  <!-- GALLERY: pagination + render + lightbox -->
  <script>
  (function(){
    const PAGE_SIZE = (() => {
      const w = window.innerWidth || 0;
      if (w >= 1400) return 40;
      if (w >= 1000) return 30;
      if (w >= 700)  return 24;
      return 20;
    })();

    const TRAIL_KEY = "gallery_token_trail_v1";
    const readTrail = () => { try{ return JSON.parse(sessionStorage.getItem(TRAIL_KEY)||"[]"); }catch(e){return [];} }
    const writeTrail = (arr) => { try{ sessionStorage.setItem(TRAIL_KEY, JSON.stringify(arr)); }catch(e){} }

    const url = new URL(location.href);
    const token = url.searchParams.get("pageToken") || null;
    const pageSize = Math.max(1, Number(url.searchParams.get("pageSize")||PAGE_SIZE));

    const grid = document.querySelector("#grid");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");
    const emptyEl = document.getElementById("empty");

    let trail = readTrail();
    if (token && (trail.length===0 || trail[trail.length-1] !== token)) trail.push(token);
    if (!token) trail = [];
    writeTrail(trail);

    function setStatus(t){ if(pageInfo) pageInfo.textContent = t; }

    function makeCard(imgSrc, captionText){
      const caption = (captionText && captionText.trim()) ? captionText.trim() : '';

      const anchor = document.createElement("a");
      anchor.href = imgSrc;
      anchor.target = "_blank";
      anchor.rel = "noopener noreferrer";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = caption || 'photo';
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.addEventListener('click', (ev) => { ev.preventDefault(); openLightbox(imgSrc, caption); });

      anchor.appendChild(img);

      const card = document.createElement("div");
      card.className = "photo-card";
      card.appendChild(anchor);

      if (caption) {
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = caption;
        card.appendChild(meta);
      }
      return card;
    }

    // Lightbox
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImage');
    const lbCaption = document.getElementById('lbCaption');
    const lbClose = document.getElementById('lbClose');
    function openLightbox(src, caption){
      lbImg.src = src;
      lbCaption.textContent = (caption && caption.trim()) ? caption.trim() : '';
      lb.style.display = 'flex';
      lb.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeLightbox(){
      lbImg.src = '';
      lb.style.display = 'none';
      lb.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    if (lbClose) lbClose.addEventListener('click', closeLightbox);
    const lbBack = document.getElementById('lbBack');
    if (lbBack) lbBack.addEventListener('click', closeLightbox);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });

    // Fetch /api/photos (Drive-backed)
    async function loadFromApi(){
      try {
        const qs = new URLSearchParams({ pageSize: String(pageSize) });
        if (token) qs.set("pageToken", token);
        const resp = await fetch(`/api/photos?${qs.toString()}`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const items = data.items || [];
        const nextToken = data.nextPageToken || null;
        if (!items.length) throw new Error('no-items');

        // Render (no filename fallback)
        grid.innerHTML = '';
        items.forEach(f => {
          const src = `/api/file/${encodeURIComponent(f.id)}`;
          const caption = (f.caption && f.caption.trim()) ? f.caption.trim() : '';
          grid.appendChild(makeCard(src, caption));
        });

        emptyEl.style.display = 'none';
        setStatus(`Page ${ (trail.length>0) ? (trail.length+1) : 1 } • ${pageSize} per page (Drive)`);
        setupPager(nextToken);
        return true;
      } catch (err) {
        console.warn('Drive listing failed or returned empty:', err);
        return false;
      }
    }

    // Local fallback: try /private/photos.json then probe /private/photos/
    async function loadFromLocal(){
      try {
        let list = null;
        try {
          const j = await fetch('/private/photos.json', { cache: 'no-cache' });
          if (j.ok) {
            const parsed = await j.json();
            if (Array.isArray(parsed) && parsed.length) {
              list = parsed.map(it => {
                if (typeof it === 'string') return { url: `/private/photos/${it}`, name: it, caption: '' };
                if (it && it.url) return it;
                if (it && it.name) return { url: `/private/photos/${it.name}`, name: it.name, caption: (it.caption||'') };
                return null;
              }).filter(Boolean);
            }
          }
        } catch(e){ /* ignore */ }

        if (!list || list.length === 0) {
          list = [];
          const MAX = 60;
          const exts = ['jpg','jpeg','png','webp'];
          for (let i = 1; i <= MAX; i++){
            for (const ext of exts){
              const nm = `photo${i}.${ext}`;
              try {
                const h = await fetch(`/private/photos/${nm}`, { method: 'HEAD' });
                if (h.ok) { list.push({ url: `/private/photos/${nm}`, name: nm, caption: '' }); break; }
              } catch(e){ /* ignore */ }
            }
          }
        }

        if (!list || list.length === 0) throw new Error('no local photos found');

        grid.innerHTML = '';
        list.forEach(item => {
          const src = item.url || `/private/photos/${item.name}`;
          const caption = (item.caption && item.caption.trim()) ? item.caption.trim() : '';
          grid.appendChild(makeCard(src, caption));
        });

        emptyEl.style.display = 'none';
        setStatus(`Showing ${list.length} (Local)`);
        setupPager(null);
        return true;
      } catch (err) {
        console.warn('Local fallback failed:', err);
        return false;
      }
    }

    function setupPager(nextToken){
      if (nextBtn) {
        nextBtn.disabled = !nextToken;
        nextBtn.onclick = () => {
          const u = new URL(location.href);
          u.searchParams.set("pageSize", String(pageSize));
          if (nextToken) u.searchParams.set("pageToken", nextToken);
          let t = readTrail();
          if (token && (t.length===0 || t[t.length-1] !== token)) t.push(token);
          writeTrail(t);
          location.href = u.toString();
        };
      }
      if (prevBtn) {
        prevBtn.disabled = (trail.length <= 1);
        prevBtn.onclick = () => {
          let t = readTrail();
          if (t.length > 0) t.pop();
          const prevToken = (t.length > 0) ? t[t.length-1] : null;
          writeTrail(t);
          const u = new URL(location.href);
          u.searchParams.set("pageSize", String(pageSize));
          if (prevToken) u.searchParams.set("pageToken", prevToken); else u.searchParams.delete("pageToken");
          location.href = u.toString();
        };
      }
    }

    async function loadPage(){
      setStatus("Loading…");
      if (prevBtn) prevBtn.disabled = (trail.length <= 1);
      if (nextBtn) nextBtn.disabled = true;

      const okApi = await loadFromApi();
      if (okApi) return;
      const okLocal = await loadFromLocal();
      if (!okLocal) {
        grid.innerHTML = '';
        emptyEl.style.display = 'block';
        setStatus('');
      }
    }

    loadPage();
  })();
  </script>

  <!-- Music UI & logic already handled globally; keep your includes -->
  <link rel="stylesheet" href="/assets/css/music-heart.css">
  <script src="/assets/js/music-heart.js" defer></script>
</body>
</html>
