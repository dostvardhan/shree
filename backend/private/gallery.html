<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery</title>

<style>
  :root{
    --ink:#2d2326; --ring:rgba(0,0,0,.08); --accent:#ff6b8a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial;
    /* brighter layered background */
    background:
      radial-gradient(1100px 760px at 15% -10%, #fff1f8 0%, #ffd6e5 42%, #ffb5cc 100%),
      linear-gradient(180deg, #ffffff00 0%, #ffffff66 50%, #ffffff00 100%);
    overflow-x:hidden;
  }

  /* Hearts */
  .hearts{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.5}
  .hearts span{
    position:absolute; width:12px; height:12px; transform:rotate(45deg); border-radius:2px;
    background:#ffc0cbcc; box-shadow:0 0 14px #ff8aa655; animation:float 12s linear infinite;
  }
  .hearts span::before,.hearts span::after{content:""; position:absolute; width:12px; height:12px; background:#ffc0cbcc; border-radius:50%; left:-6px; top:0}
  .hearts span::after{left:0; top:-6px}
  @keyframes float{0%{transform:translateY(0) rotate(45deg) scale(.9);opacity:.3}100%{transform:translateY(-120vh) rotate(45deg) scale(1.05);opacity:0}}

  /* Grid (bigger cards) */
  .grid{
    max-width:1100px; margin:24px auto 100px; padding:0 18px;
    display:grid; gap:22px;
    grid-template-columns: repeat(3, 1fr);   /* bigger */
  }
  @media (max-width:900px){ .grid{grid-template-columns: repeat(2, 1fr)} }
  @media (max-width:560px){ .grid{grid-template-columns: 1fr} }

  .frame{
    position:relative; aspect-ratio:3/4; border-radius:24px; overflow:hidden;
    background:#f6eef1; border:1px solid var(--ring);
    box-shadow:0 30px 70px -40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.7);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .frame:hover{ transform: translateY(-2px); box-shadow:0 36px 90px -50px rgba(0,0,0,.65) }

  /* blurred fill */
  .fill{ position:absolute; inset:10px; border-radius:20px; z-index:0;
    background-position:center; background-size:cover; filter:blur(20px) saturate(1.05) brightness(.98); transform:scale(1.08) }
  /* photo plane */
  .photo{ position:absolute; inset:16px; border-radius:18px; z-index:2;
    display:flex; align-items:center; justify-content:center; background:#ffffffee; backdrop-filter:blur(2px);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
  }
  .photo img{ max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block; border-radius:14px }

  /* Minimal pager (icons only) */
  .pager{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:3; display:flex; gap:10px }
  .pbtn{
    width:42px; height:42px; border-radius:999px; border:1px solid #f0c8d4; background:#fff;
    box-shadow:0 12px 30px -18px rgba(0,0,0,.45); cursor:pointer; font-size:18px; font-weight:800;
    display:flex; align-items:center; justify-content:center;
  }
  .pbtn[disabled]{ opacity:.45; cursor:not-allowed }

  /* Music & Hearts FAB (right bottom) */
  .fab-wrap{ position:fixed; right:16px; bottom:16px; z-index:4; display:flex; flex-direction:column; gap:10px }
  .fab{
    width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    background:#ffffffd8; border:1px solid #f0c8d4; box-shadow:0 10px 28px -16px rgba(0,0,0,.45);
    cursor:pointer; user-select:none; font-weight:800;
  }
  .fab:hover{ transform:translateY(-1px) }

  /* Skeletons */
  .skeleton{ aspect-ratio:3/4; border-radius:24px; border:1px solid var(--ring);
    background:linear-gradient(90deg,#ffeef3,#fff7f9,#ffeef3); background-size:200% 100%; animation:sk 1.2s infinite }
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Hide any helper text visually (for screen readers only) */
  .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
</style>
</head>
<body>
  <!-- Hearts layer -->
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <!-- Grid -->
  <main class="grid" id="grid" aria-live="polite">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </main>

  <!-- Pager (icons only) -->
  <div class="pager">
    <button id="prevBtn" class="pbtn" title="Prev">‹</button>
    <button id="nextBtn" class="pbtn" title="Next">›</button>
    <span id="pinfo" class="sr" aria-live="polite"></span>
  </div>

  <!-- FABs -->
  <div class="fab-wrap">
    <button class="fab" id="musicFab" title="Play/Pause">♪</button>
    <button class="fab" id="heartsFab" title="Hearts">❤</button>
  </div>
  <!-- Multiple sources so 404 na aaye; browser jo mile woh play karega -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="/assets/audio/music.mp3" type="audio/mpeg">
    <source src="/assets/music.mp3" type="audio/mpeg">
    <source src="/audio/music.mp3" type="audio/mpeg">
    <source src="/music.mp3" type="audio/mpeg">
  </audio>

<script>
  /* Inline guard: if a protected endpoint 401 de, home bhej do (no external guard-auth.js needed) */
  (async function softGuard(){
    try{
      const r = await fetch('/api/diag', {credentials:'include'});
      if(!r.ok) location.href = '/index.html';
    }catch{ location.href = '/index.html'; }
  })();

  // Hearts spawn (visible)
  (function(){
    const root=document.getElementById('hearts'); const N=26;
    for(let i=0;i<N;i++){
      const s=document.createElement('span');
      s.style.left=Math.random()*100+'vw';
      s.style.bottom=(-10-Math.random()*40)+'vh';
      s.style.animationDelay=(Math.random()*9)+'s';
      const size=9+Math.random()*12; s.style.width=size+'px'; s.style.height=size+'px';
      s.style.opacity=(0.22+Math.random()*0.3).toFixed(2);
      root.appendChild(s);
    }
  })();

  // Gallery (16 per page) — RECENT FIRST
  (function(){
    const PAGE_SIZE=16;
    const grid=document.getElementById('grid');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const pinfo=document.getElementById('pinfo');

    const lbBox=document.createElement('div');
    lbBox.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:5;';
    lbBox.innerHTML = `
      <button id="lbClose" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
      <button id="lbPrev"  style="position:absolute;left:16px;top:50%;transform:translateY(-50%);background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">‹</button>
      <img id="lbImg" alt="" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);" />
      <button id="lbNext"  style="position:absolute;right:16px;top:50%;transform:translateY(-50%);background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">›</button>`;
    document.body.appendChild(lbBox);
    const lbImg=lbBox.querySelector('#lbImg'), lbPrev=lbBox.querySelector('#lbPrev'), lbNext=lbBox.querySelector('#lbNext'), lbClose=lbBox.querySelector('#lbClose');

    let all=[], page=getPage(), currentIndexOnPage=-1;
    function getPage(){ const u=new URL(location.href); const v=parseInt(u.searchParams.get('page')||'1',10); return (Number.isFinite(v)&&v>0)?v:1 }
    function setPage(p){ const u=new URL(location.href); u.searchParams.set('page',p); history.replaceState(null,'',u.toString()) }

    function clear(){ grid.innerHTML='' }

    function frame(item, index){
      const fig=document.createElement('figure'); fig.className='frame';
      const fill=document.createElement('div'); fill.className='fill';
      fill.style.backgroundImage=`url("/api/file/${encodeURIComponent(item.id)}")`;
      const plane=document.createElement('div'); plane.className='photo';
      const img=document.createElement('img'); img.loading='lazy'; img.alt=''; img.src=`/api/file/${encodeURIComponent(item.id)}`;
      plane.appendChild(img); fig.appendChild(fill); fig.appendChild(plane);
      fig.addEventListener('click',()=>open(index));
      return fig;
    }

    function render(){
      clear();
      const total=all.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
      if(page>pages) page=pages;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,total);
      const frag=document.createDocumentFragment();
      all.slice(start,end).forEach((it,i)=>frag.appendChild(frame(it,i)));
      grid.appendChild(frag);
      prevBtn.disabled=(page<=1); nextBtn.disabled=(page>=pages);
      pinfo.textContent=`${page}/${pages}`;
      setPage(page);
    }

    function open(i){
      currentIndexOnPage=i;
      const gi=(page-1)*PAGE_SIZE+i; lbImg.src=`/api/file/${encodeURIComponent(all[gi].id)}`;
      lbBox.style.display='flex';
    }
    function close(){ lbBox.style.display='none'; lbImg.src='' }
    function step(d){
      if(currentIndexOnPage<0) return;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, all.length);
      const gi=start+currentIndexOnPage+d;
      if(gi<start || gi>=end) return;
      currentIndexOnPage+=d; lbImg.src=`/api/file/${encodeURIComponent(all[start+currentIndexOnPage].id)}`;
    }
    lbClose.onclick=close; lbPrev.onclick=()=>step(-1); lbNext.onclick=()=>step(1);
    lbBox.addEventListener('click',e=>{ if(e.target===lbBox) close(); });
    window.addEventListener('keydown',e=>{ if(lbBox.style.display!=='flex') return; if(e.key==='Escape') close(); if(e.key==='ArrowLeft') step(-1); if(e.key==='ArrowRight') step(1); });

    function extractTime(o){
      const keys=['createdAt','uploadedAt','time','timestamp','ts','date'];
      for(const k of keys){ if(o[k]){ const d=new Date(o[k]); if(!isNaN(d)) return d.getTime(); } }
      if (typeof o.id==='string' && /^\d{10,}$/.test(o.id)) return parseInt(o.id,10);
      return 0;
    }

    prevBtn.onclick=()=>{ page=Math.max(1,page-1); render(); };
    nextBtn.onclick=()=>{ page=page+1; render(); };

    (async function fetchList(){
      try{
        const r=await fetch('/api/list',{credentials:'include'});
        if(!r.ok) throw new Error('list failed');
        const data=await r.json();
        all=(Array.isArray(data)?data.slice():[]);
        all.sort((a,b)=>extractTime(b)-extractTime(a)); // recent first
        render();
      }c
