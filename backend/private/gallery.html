<!doctype html>
<html lang="en">
<head>
  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https:;
                 connect-src 'self' https:;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline' https:;
                 media-src 'self';">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery — Sweet Memories</title>

  <!-- Auth -->
  <script src="/auth0-spa-js.production.js" defer></script>
  <script src="/auth-init.js" defer></script>
  <script src="/guard-auth.js" defer></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Music UI (same as life.html) -->
  <link rel="stylesheet" href="/assets/css/music-heart.css">
  <script src="/assets/js/music-heart.js" defer></script>

  <style>
  :root {
    --text:#5a3740;
    --muted:#7a5a5f;
    --bg-card:rgba(255,255,255,0.92);
    --shadow:0 14px 35px rgba(0,0,0,0.18);
    --radius:18px;
  }

  html.guard-hide body{visibility:hidden}

  body {
    margin:0;
    font-family:Inter,system-ui,sans-serif;
    color:var(--text);
    background:url("assets/img/gallery-bg-hearts.png") center/cover no-repeat fixed;
    overflow-x:hidden;
  }

  nav.topbar{
    display:flex;
    justify-content:center;
    gap:10px;
    position:sticky;
    top:14px;
    z-index:10;
  }

  nav.topbar a{
    text-decoration:none;
    font-weight:600;
    font-size:13px;
    color:var(--text);
    padding:8px 14px;
    border-radius:999px;
    background:linear-gradient(180deg,#ffeef2,#ffdee8);
    border:1px solid #f2c3d1;
    box-shadow:0 8px 20px -12px rgba(0,0,0,.3);
  }

  h1{
    font-family:"Playfair Display",serif;
    text-align:center;
    font-size:clamp(22px,3vw,34px);
    margin:26px 0 12px;
    text-shadow:0 1px 0 rgba(255,255,255,0.7);
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:22px;
    max-width:1150px;
    margin:0 auto;
    padding:10px 20px 60px;
  }

  .card{
    background: transparent;
    border-radius: 22px;
    padding: 10px;
    transition: transform .28s cubic-bezier(.2,.9,.25,1), box-shadow .28s;
    cursor:pointer;
    position:relative;
    box-shadow:0 20px 50px rgba(20,10,20,0.14), inset 0 1px 0 rgba(255,255,255,0.35);
  }

  .card::before{
    content:"";
    position:absolute;
    inset:0;
    border-radius:20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(250,246,245,0.55));
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    transform: translateY(2px);
  }

  .poster{
    position:relative;
    width:100%;
    aspect-ratio:3/4;
    border-radius:12px;
    overflow:hidden;
  }

  .poster .fill{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    filter: blur(12px) brightness(.92) saturate(.96);
    transform:scale(1.06);
    opacity:0.86;
  }

  .photo{
    position:absolute;
    inset:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:10px;
    overflow:hidden;
  }

  .photo img{
    max-width:100%;
    max-height:100%;
    transition:.3s;
    object-fit:contain;
    box-shadow:0 8px 30px rgba(60,30,40,0.06);
  }

  .pager{
    display:flex;
    justify-content:center;
    gap:10px;
    padding:20px 0 40px;
  }

  .pbtn{
    width:42px;height:42px;
    border-radius:50%;
    border:none;
    background:white;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 10px 24px -16px rgba(0,0,0,0.4);
  }

  /* small heart */
  .fab{
    width:48px;height:48px;
    border-radius:50%;
    position:fixed;
    right:16px;
    bottom:96px;
    background:#ffffffcc;
    border:1px solid #f0c4cc;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:9998;
  }

  #guardLoader{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-family:system-ui; color:#7a2a39; z-index:9999;
  }
  html:not(.guard-hide) #guardLoader{display:none}
  </style>

</head>
<body>

<div id="guardLoader">Loading…</div>

<script>
document.documentElement.classList.add('guard-hide');
window.addEventListener('shree:auth-ready',(e)=>{
  if(!e.detail.authenticated){location.href="/index.html";return;}
  document.documentElement.classList.remove('guard-hide');
});
setTimeout(()=>document.documentElement.classList.remove('guard-hide'),2000);
</script>

<nav class="topbar">
 <a href="/life.html">Life</a>
 <a href="/upload.html">Upload</a>
 <a href="/auth/logout">Logout</a>
</nav>

<h1>Sweet Memories of Shreshtha’s Life</h1>

<section id="grid" class="grid">
  <div class="card" style="opacity:.4;height:200px;"></div>
</section>

<div class="pager">
  <button id="prevBtn" class="pbtn">‹</button>
  <button id="nextBtn" class="pbtn">›</button>
</div>

<button class="fab" id="heartBtn">❤</button>

<script>
document.getElementById("heartBtn").onclick=()=>{
  const h=document.createElement("div");
  h.textContent="❤";
  h.style.position="fixed";
  h.style.right="22px";
  h.style.bottom="110px";
  h.style.fontSize="22px";
  h.style.opacity="0.95";
  h.style.zIndex=9999;
  document.body.appendChild(h);
  setTimeout(()=>h.remove(),900);
};
</script>

<!-- Lightbox -->
<script>
const Lightbox=(()=>{
  const c=document.createElement("div");
  c.style.cssText="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;align-items:center;justify-content:center;";
  c.innerHTML=`<div style="position:relative;max-width:98vw;max-height:96vh;">
    <button id="lbClose" style="position:absolute;top:8px;right:8px;background:#fff;padding:8px;border:none;border-radius:8px;">✕</button>
    <a id="lbDownload" download style="position:absolute;top:8px;left:8px;background:#fff;padding:8px;border-radius:8px;text-decoration:none;color:#222;">Download</a>
    <img id="lbImg" style="max-width:98vw;max-height:96vh;object-fit:contain;border-radius:8px;">
  </div>`;
  document.body.appendChild(c);
  c.querySelector("#lbClose").onclick=()=>c.style.display="none";
  return{
    open:(src,n)=>{
      c.querySelector("#lbImg").src=src;
      c.querySelector("#lbDownload").href=src;
      c.style.display="flex";
    }
  };
})();
</script>

<!-- Gallery Loader -->
<script>
(async()=>{
 const grid=document.getElementById('grid'),
       prev=document.getElementById('prevBtn'),
       next=document.getElementById('nextBtn');
 const PAGE=24;

 function getTime(i){
  for(let k of ['createdAt','uploadedAt','time','date','timestamp'])
    if(i?.[k]) return new Date(i[k]).getTime();
  return 0;
 }

 async function createCard(it){
   const el=document.createElement("div"); el.className="card";
   el.innerHTML=`<div class="frame-inner"></div>
     <div class="poster">
       <div class="fill"></div>
       <div class="photo"><img loading="lazy"></div>
     </div>`;

   const id=it.id||it._id;
   if(id){
     try{
       const res=await fetch("/api/file/"+id,{credentials:"include"});
       const blob=await res.blob();
       const url=URL.createObjectURL(blob);
       el.querySelector("img").src=url;
       el.querySelector(".fill").style.backgroundImage=`url('${url}')`;
       el.onclick=()=>Lightbox.open(url,it.name||"photo.jpg");
     }catch{}
   }
   return el;
 }

 function render(list,page){
   grid.innerHTML="";
   const pages=Math.ceil(list.length/PAGE)||1;
   if(page>pages)page=pages;
   list.slice((page-1)*PAGE,page*PAGE)
       .forEach(async i=>grid.appendChild(await createCard(i)));
   prev.disabled=page<=1;
   next.disabled=page>=pages;
 }

 try{
   const res=await fetch("/api/list",{credentials:"include"});
   const data=await res.json();
   let items=Array.isArray(data)?data:(data.items||[]);
   items=items.sort((a,b)=>getTime(b)-getTime(a));
   let page=1;
   render(items,page);
   prev.onclick=()=>{if(page>1){page--;render(items,page)}};
   next.onclick=()=>{page++;render(items,page)};
 }catch{
   grid.innerHTML="<p style='text-align:center;color:#603a3b;'>Unable to load photos.</p>";
 }
})();
</script>

</body>
</html>
