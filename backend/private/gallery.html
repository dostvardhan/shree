<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shreshtha – Gallery</title>

<!-- Auth & guards -->
<script src="/auth0-spa-js.production.js"></script>
<script src="auth-init.js" defer></script>
<script src="guard-auth.js" defer></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Italianno&display=swap" rel="stylesheet">
<style>
  :root{
    --cream:#FFE7DA; --peach:#FFB59E; --red:#FF6B6B;
    --text:#6e2430; --panel:rgba(255,255,255,.05);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Playfair Display",serif;
    color:var(--text);
    background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));
    overflow-x:hidden;
  }
  header{text-align:center;padding:24px 12px;}
  .logo{font-family:"Italianno",cursive;font-size:46px;text-shadow:0 2px 10px rgba(0,0,0,.25);}
  nav{margin-top:8px;}
  nav a{margin:0 12px;padding:8px 18px;background:rgba(255,255,255,.15);
        border-radius:999px;text-decoration:none;color:var(--text);
        box-shadow:0 4px 8px rgba(0,0,0,.18);}
  nav a:hover{background:rgba(255,255,255,.3);}
  main{max-width:1200px;margin:30px auto;padding:0 18px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;}

  /* CARD */
  .card{
    background:var(--panel);
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 18px 40px rgba(0,0,0,.25);
    position:relative;
    transition:transform .3s cubic-bezier(.2,.9,.3,1);
  }
  .card:hover{transform:translateY(-6px);}

  /* ✅ No-crop thumbnail: full image visible (letterbox) */
  .imgbox{
    height:320px;               /* thumbnail area height */
    background:#fff9f7;         /* soft backdrop behind transparent images */
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .imgbox img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;         /* <- show full image, no crop */
    display:block;
  }

  .meta{padding:12px 14px 16px;text-align:center;font-style:italic;font-size:15px;}
  .empty{text-align:center;font-size:18px;margin-top:80px;opacity:.8;}

  /* Floating hearts */
  .heart{position:fixed;font-size:18px;opacity:.75;
         animation:floatUp linear infinite;pointer-events:none;}
  @keyframes floatUp{
    0%{transform:translateY(0) scale(1);opacity:.9;}
    100%{transform:translateY(-120vh) scale(1.4);opacity:0;}
  }
</style>
</head>
<body>
<header>
  <div class="logo">Gallery of Sweet Memories</div>
  <nav>
    <a href="life.html">Back to Life</a>
    <a href="upload.html">Upload</a>
    <a href="/auth/logout">Logout</a>
  </nav>
</header>

<main>
  <section id="grid" class="grid"></section>
  <div id="empty" class="empty" style="display:none;">No photos uploaded yet 🌸</div>
<!-- Pagination Controls -->
<div id="pager" style="display:flex;justify-content:center;gap:12px;align-items:center;margin:18px 0;">
  <button id="prevBtn" disabled style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;cursor:pointer;">← Prev</button>
  <div id="pageInfo" style="font-weight:600;"></div>
  <button id="nextBtn" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;cursor:pointer;">Next →</button>
</div>
</main>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const reveal = () => { const gate = document.getElementById("auth-gate"); if (gate) gate.remove(); };
      try {
        if (typeof requireAuth === "function") {
          Promise.resolve(requireAuth()).then(reveal).catch(e => { console.error("Auth failed:", e); reveal(); });
        } else {
          console.error("requireAuth not found"); reveal();
        }
      } catch(e){ console.error("Auth error:", e); reveal(); }
    });
  </script>
<script>
/* GALLERY_PAGINATION_V3 */
(function(){
  const PAGE_SIZE = (function () {
  const w = window.innerWidth || 0;
  if (w >= 1400) return 40;
  if (w >= 1000) return 30;
  if (w >= 700)  return 24;
  return 20;
})();

  // We use Drive pageToken based paging. For Prev, keep a token trail in sessionStorage
  const TRAIL_KEY = "gallery_token_trail_v1";
  const readTrail = () => { try{ return JSON.parse(sessionStorage.getItem(TRAIL_KEY)||"[]"); }catch(e){return [];} }
  const writeTrail = (arr) => { try{ sessionStorage.setItem(TRAIL_KEY, JSON.stringify(arr)); }catch(e){} }

  const url = new URL(location.href);
  const token = url.searchParams.get("pageToken") || null;   // current token
  const pageSize = Math.max(1, Number(url.searchParams.get("pageSize")||PAGE_SIZE));

  const grid = document.querySelector("#grid, .grid, .photos-grid") || document.body; // fallback
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pageInfo = document.getElementById("pageInfo");

  // Keep trail (do not push null at start repeatedly)
  let trail = readTrail();
  // When navigating forward with a token, remember it so we can step back
  // Rule: trail stores the sequence of tokens used to reach current page.
  // if URL has a token and it's not last item, ensure trail ends with it
  if (token && (trail.length===0 || trail[trail.length-1] !== token)) trail.push(token);
  // But for page 1 (token=null) we reset
  if (!token) trail = [];

  writeTrail(trail);

  function setStatus(text){ if(pageInfo) pageInfo.textContent = text; }

  async function loadPage(){
    setStatus("Loading…");
    if (prevBtn) prevBtn.disabled = (trail.length <= 1); // can go back only if we have earlier token
    if (nextBtn) nextBtn.disabled = true;

    try {
      const qs = new URLSearchParams({ pageSize: String(pageSize) });
      if (token) qs.set("pageToken", token);
      const resp = await fetch(`/api/photos?${qs.toString()}`, { credentials: "include" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const items = data.items || [];
      const nextToken = data.nextPageToken || null;

      // Render items into grid – replace with your existing renderer if present
      // Basic clean:
      const container = grid;
      // Try to find a known container if exists
      const known = document.getElementById("photos") || document.querySelector(".gallery-grid");
      if (known) { known.innerHTML=""; }
      const target = known || container;

      // Simple grid style if none
      if (!target.style.display) {
        target.style.display = "grid";
        target.style.gridTemplateColumns = "repeat(auto-fill, minmax(220px, 1fr))";
        target.style.gap = "12px";
      } else {
        // clear
        target.innerHTML = "";
      }

      items.forEach((f) => {
        const a = document.createElement("a");
        a.href = f.webViewLink || f.webContentLink || "#";
        a.target = "_blank";
        a.rel = "noopener";

        const img = document.createElement("img");
        // Prefer thumbnailLink; fallback via Drive content link if needed
        img.src = (f.thumbnailLink || f.webContentLink || "").replace(/=s\d+/, "=s512");
        img.alt = f.name || "photo";
img.style.width = "100%";
img.style.height = "auto";
img.style.objectFit = "contain";
img.style.display = "block";

img.style.width = "100%";
img.style.height = "auto";
img.style.objectFit = "contain";
img.style.display = "block";

        img.loading = "lazy";
        img.style.width = "100%";
        
        
        img.style.borderRadius = "12px";
        img.referrerPolicy = "no-referrer";

        a.appendChild(img);
        const card = document.createElement("div");
card.className = "photo-card";
card.appendChild(a);
target.appendChild(card);
      });

      // Pager controls
      if (nextBtn) {
        nextBtn.disabled = !nextToken;
        nextBtn.onclick = () => {
          const u = new URL(location.href);
          u.searchParams.set("pageSize", String(pageSize));
          if (nextToken) u.searchParams.set("pageToken", nextToken);
          // Save current token in trail (if not present already)
          let t = readTrail();
          if (token && (t.length===0 || t[t.length-1] !== token)) t.push(token);
          if (!token && t.length===0) { /* first page */ }
          writeTrail(t);
          location.href = u.toString();
        };
      }

      if (prevBtn) {
        prevBtn.disabled = (trail.length <= 1);
        prevBtn.onclick = () => {
          let t = readTrail();
          // current token is last; previous page token is second last
          // pop current
          if (t.length > 0) t.pop();
          const prevToken = (t.length > 0) ? t[t.length-1] : null;
          // also set reduced trail
          writeTrail(t);
          const u = new URL(location.href);
          u.searchParams.set("pageSize", String(pageSize));
          if (prevToken) u.searchParams.set("pageToken", prevToken); else u.searchParams.delete("pageToken");
          location.href = u.toString();
        };
      }

      // Show page label (approx): "Page N (20 per page)"
      const pageNum = Math.max(1, trail.length || 1);
      setStatus(`Page ${pageNum} • ${pageSize} per page`);

    } catch (e) {
      console.error("Gallery load failed:", e);
      setStatus("Failed to load photos.");
    }
  }

  loadPage();
})();
</script>

<!-- START: floating hearts (overlay) -->
<div id="fxRoot" aria-hidden="true"><canvas id="fxCanvas"></canvas></div>
<script>
(()=>{const c=document.getElementById("fxCanvas");if(!c)return;const ctx=c.getContext("2d");
let W,H;const DPR=Math.max(1,window.devicePixelRatio||1);let hs=[];
function R(a,b){return Math.random()*(b-a)+a}
function resize(){W=innerWidth*DPR;H=innerHeight*DPR;c.width=W;c.height=H}
function spawn(){if(hs.length>28)return;hs.push({x:R(0,W),y:H+R(20,200),s:R(10,22),vx:R(-15,15),vy:-R(35,70),a:R(.25,.6),r:R(-.5,.5),vr:R(-.02,.02)})}
function heart(px,py,s,rot,a){ctx.save();ctx.translate(px,py);ctx.rotate(rot);ctx.scale(s,s);ctx.globalAlpha=a;ctx.fillStyle="#ff85a7";
ctx.beginPath();ctx.moveTo(0,-.5);ctx.bezierCurveTo(.5,-1.1,1.3,-.1,0,.8);ctx.bezierCurveTo(-1.3,-.1,-.5,-1.1,0,-.5);ctx.fill();ctx.restore()}
function tick(){ctx.clearRect(0,0,W,H);if(Math.random()<.12)spawn();hs.forEach(h=>{h.x+=h.vx*.016;h.y+=h.vy*.016;h.r+=h.vr;h.a-=.0012});
hs=hs.filter(h=>h.y>-60&&h.a>.02);hs.forEach(h=>heart(h.x,h.y,h.s/50,h.r,h.a));requestAnimationFrame(tick)}
addEventListener("resize",resize,{passive:true});resize();tick();})();
</script>
<!-- END: floating hearts -->
</body>
</html>







<script>
(function(){
  // avoid duplicates if already injected
  if (window.__heartsInjected) return; 
  window.__heartsInjected = true;

  function spawnHeart(){
    const heart=document.createElement('div');
    heart.className='heart';
    heart.style.left = (Math.random()*100) + 'vw';
    heart.style.animationDuration = (6 + Math.random()*4) + 's';
    document.body.appendChild(heart);
    setTimeout(()=>heart.remove(), 10000);
  }
  // make a bunch at start, then keep trickling in
  for(let i=0;i<16;i++) spawnHeart();
  setInterval(spawnHeart, 1200);
})();
</script>



