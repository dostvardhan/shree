<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Memories — Gallery</title>

  <!-- Auth Guard (keeps page private) -->
  <script src="/assets/js/guard-auth.js" defer></script>

  <style>
    :root{
      --bg:#f7f6f3;
      --ink:#222;
      --muted:#6d6d6d;
      --accent:#e34b6a;
      --card:#ffffff;
      --ring:rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color:var(--ink);
      background: radial-gradient(1200px 800px at 10% -10%, #f1efe7 0%, #faf9f7 35%, var(--bg) 100%);
    }

    /* Top bar */
    .topbar {
      position: sticky; top: 0; z-index: 30;
      backdrop-filter: blur(6px);
      background: color(from var(--bg) srgb 1 1 1 / .6);
      border-bottom: 1px solid var(--ring);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px 18px; }
    .brand {
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px;
    }
    .brand .dot { width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px color-mix(in oklab, var(--accent) 20%, transparent); }
    nav a {
      text-decoration:none; color:var(--muted); margin-right:16px; font-weight:600;
      padding:8px 12px; border-radius:999px;
    }
    nav a.active, nav a:hover { color: var(--ink); background: var(--card); box-shadow: 0 1px 0 var(--ring), 0 10px 24px -18px rgba(0,0,0,.35); }

    /* Page header */
    .pagehead {
      max-width: 1200px; margin: 18px auto 6px; padding: 0 18px;
      display:flex; align-items:end; justify-content:space-between; gap:16px;
    }
    .title { font-size: clamp(22px, 2.6vw, 30px); margin:0; }
    .hint { color: var(--muted); font-size: 14px; margin: 6px 0 0; }

    /* Gallery grid */
    .grid {
      max-width: 1200px; margin: 8px auto 80px; padding: 0 18px 18px;
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px -32px rgba(0,0,0,.4);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 22px 50px -28px rgba(0,0,0,.45); }

    /* Image wrapper: NO CROP (contain) */
    .imgwrap {
      position: relative;
      background: #fafafa;
      /* Keep natural aspect ratio — no fixed height */
    }
    .imgwrap img {
      display:block;
      width:100%;
      height:auto;           /* <-- preserves aspect ratio */
      object-fit: contain;   /* <-- no cropping, full image visible */
      background: #f7f7f7;
    }

    /* Caption */
    .caption {
      padding: 10px 12px 12px;
      font-size: 14px; line-height: 1.4;
      color: #333;
      display:flex; align-items:flex-start; gap:8px;
    }
    .caption .heart {
      flex:0 0 auto; width:14px; height:14px; margin-top:2px;
      background: var(--accent); clip-path: path("M12 4 C12 1.79 10.21 0 8 0 C6.73 0 5.6 0.59 4.86 1.5 C4.12 0.59 2.99 0 1.72 0 C-0.49 0 -2.28 1.79 -2.28 4 C-2.28 8 4.86 12 4.86 12 C4.86 12 12 8 12 4 Z");
      transform: scale(.9);
      opacity:.9;
    }
    .captext { flex:1; word-wrap:break-word; white-space:pre-wrap; }

    /* Skeletons */
    .skeleton {
      background: linear-gradient(90deg, #eee, #f6f6f6, #eee);
      background-size: 200% 100%;
      animation: sk 1.2s infinite;
      border-radius: 14px;
      border: 1px solid var(--ring);
      height: 240px;
    }
    @keyframes sk { 0%{background-position: 200% 0} 100%{background-position: -200% 0} }

    /* Load more sentinel */
    .sentinel { height: 1px; }

    /* Lightbox */
    .lightbox {
      position: fixed; inset:0; display:none; z-index:50;
      background: rgba(0,0,0,.85);
      align-items:center; justify-content:center;
    }
    .lightbox.open { display:flex; }
    .lightbox img {
      max-width: 95vw; max-height: 88vh; width:auto; height:auto; object-fit: contain;
      border-radius: 10px; box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 30px 80px -40px rgba(0,0,0,.9);
    }
    .lightbox .close, .lightbox .prev, .lightbox .next {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.2);
      color: #fff; font-weight: 700; font-size: 14px;
      padding: 10px 12px; border-radius: 999px; cursor: pointer;
      user-select: none;
    }
    .lightbox .close { top: 24px; right: 24px; transform:none; }
    .lightbox .prev { left: 16px; }
    .lightbox .next { right: 16px; }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between;">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <span>Sweet Memories</span>
      </div>
      <nav>
        <a href="/life.html">Life</a>
        <a href="/upload.html">Upload</a>
        <a class="active" href="/gallery.html">Gallery</a>
      </nav>
    </div>
  </header>

  <!-- Title row -->
  <section class="pagehead">
    <div>
      <h1 class="title">All Memories</h1>
      <p class="hint">No-crop gallery • Tap any photo to view full-size</p>
    </div>
    <div id="count" class="hint"></div>
  </section>

  <!-- Grid -->
  <main class="grid" id="grid" aria-live="polite">
    <!-- Skeleton placeholders (auto-removed after load) -->
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </main>

  <!-- Sentinel for infinite scroll -->
  <div class="sentinel" id="sentinel"></div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <button class="close" id="closeBtn">Close ✕</button>
    <button class="prev"  id="prevBtn">‹</button>
    <img id="lightImg" alt="Full view"/>
    <button class="next"  id="nextBtn">›</button>
  </div>

  <script>
  // -------- Auth Guard (graceful) --------
  document.addEventListener('DOMContentLoaded', () => {
    if (window.authGuard && typeof window.authGuard.protect === 'function') {
      window.authGuard.protect({ redirectTo: '/index.html' }); // hides content until verified
    }
  });

  // -------- Gallery logic --------
  (function(){
    const grid = document.getElementById('grid');
    const sentinel = document.getElementById('sentinel');
    const countEl = document.getElementById('count');

    /** Loaded list from backend: [{id, caption}] **/
    let all = [];
    let cursor = 0;
    const CHUNK = 18;  // items per page

    // Lightbox state
    let lbOpen = false;
    let current = -1; // index into all[]
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightImg');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const closeBtn = document.getElementById('closeBtn');

    function removeSkeletons(){
      [...grid.querySelectorAll('.skeleton')].forEach(el => el.remove());
    }

    function cardTemplate(item, index){
      const fig = document.createElement('figure');
      fig.className = 'card';
      fig.innerHTML = `
        <div class="imgwrap">
          <img
            loading="lazy"
            alt="${(item.caption||'Memory').replace(/"/g,'&quot;')}"
            src="/api/file/${encodeURIComponent(item.id)}"
          />
        </div>
        <figcaption class="caption">
          <span class="heart" aria-hidden="true"></span>
          <span class="captext">${(item.caption || '').replace(/</g,'&lt;')}</span>
        </figcaption>
      `;
      // Lightbox open on click
      fig.querySelector('img').addEventListener('click', () => openLightbox(index));
      return fig;
    }

    function renderMore(){
      if (cursor >= all.length) return;
      const end = Math.min(cursor + CHUNK, all.length);
      const frag = document.createDocumentFragment();
      for (let i = cursor; i < end; i++){
        frag.appendChild(cardTemplate(all[i], i));
      }
      grid.appendChild(frag);
      cursor = end;
      countEl.textContent = `${cursor}/${all.length} shown`;
      if (cursor >= all.length) observer.disconnect();
    }

    async function fetchList(){
      try{
        const res = await fetch('/api/list', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load list');
        const data = await res.json();

        // normalize + newest first (if you prefer chronological, remove reverse)
        all = Array.isArray(data) ? data.slice().reverse() : [];
        removeSkeletons();
        renderMore();
      }catch(err){
        console.error(err);
        removeSkeletons();
        const msg = document.createElement('div');
        msg.style.padding = '24px';
        msg.style.background = '#fff';
        msg.style.border = '1px solid var(--ring)';
        msg.style.borderRadius = '14px';
        msg.textContent = 'Could not load gallery. Please try again.';
        grid.appendChild(msg);
      }
    }

    // Infinite scroll (IntersectionObserver)
    const observer = new IntersectionObserver((entries) => {
      for (const e of entries){
        if (e.isIntersecting){ renderMore(); }
      }
    }, { rootMargin: '800px' });
    observer.observe(sentinel);

    // Lightbox controls
    function openLightbox(idx){
      current = idx;
      lbImg.src = `/api/file/${encodeURIComponent(all[current].id)}`;
      lb.classList.add('open');
      lbOpen = true;
    }
    function closeLightbox(){
      lbOpen = false;
      lb.classList.remove('open');
      lbImg.src = '';
    }
    function step(dir){
      if (!lbOpen) return;
      current = (current + dir + all.length) % all.length;
      lbImg.src = `/api/file/${encodeURIComponent(all[current].id)}`;
    }
    closeBtn.addEventListener('click', closeLightbox);
    prevBtn.addEventListener('click', () => step(-1));
    nextBtn.addEventListener('click', () => step(1));
    lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });
    window.addEventListener('keydown', (e) => {
      if (!lbOpen) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') step(-1);
      if (e.key === 'ArrowRight') step(1);
    });

    // Go
    fetchList();
  })();
  </script>
</body>
</html>
