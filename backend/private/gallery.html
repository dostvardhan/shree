<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery — Aurora Masonry</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --ink:#23181b;
    --glass:#ffffffcc;
    --ring:rgba(0,0,0,.10);
    --fab-bg:#ffffffd8;
    --fab-border:#e9c7d4;
    --gap:18px;
    --col-min:240px; /* minimum tile width */
    --row:8px;       /* masonry row height unit */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial;
    overflow-x:hidden;
    background: radial-gradient(1200px 800px at 20% -15%, #ffeef7 0%, #ffd6e6 45%, #ffc3d9 70%, #ffb6d1 100%);
  }
  /* aurora layer */
  .aurora{
    position:fixed; inset:-20vmax; z-index:0; pointer-events:none; filter: blur(80px) saturate(1.05);
    opacity:.65; mix-blend-mode:soft-light;
    background:
      conic-gradient(from 0deg at 30% 40%, #ffd7e6, #ffb4c9, #ffd7e6),
      conic-gradient(from 180deg at 70% 60%, #ffc6db, #ffe4f1, #ffc6db);
    animation: swirl 28s linear infinite;
  }
  @keyframes swirl{ to{ transform:rotate(360deg) } }

  /* super light grain */
  .grain{
    position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.06;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.25"/></svg>');
    background-size: 180px 180px;
  }

  /* top tiny nav */
  .topbar{
    position:sticky; top:0; z-index:5;
    display:flex; justify-content:center; gap:10px; padding:10px;
    background:#fff0f6c9; backdrop-filter:blur(10px); border-bottom:1px solid #f3c6d3;
  }
  .topbar a{
    text-decoration:none; color:#6d525c; font-weight:700; font-size:14px;
    padding:7px 12px; border-radius:999px; background:#ffe0ea; border:1px solid #f2c3d1;
    box-shadow:0 8px 20px -14px #0005;
  }
  .topbar a.active{ background:#fff }

  /* particles (clean alternative to hearts) */
  .particles{ position:fixed; inset:0; pointer-events:none; z-index:2; mix-blend-mode:screen }
  .dot{ position:absolute; width:6px; height:6px; border-radius:50%; background:radial-gradient(circle, #fff8, #fff0 60%); animation: drift var(--dur,18s) ease-in-out infinite }
  @keyframes drift{
    0%{ transform:translate(0,0) scale(.9); opacity:.6 }
    100%{ transform:translate(var(--dx,20px), var(--dy,-60px)) scale(1.1); opacity:0 }
  }

  /* Masonry container */
  .wrap{ max-width:1240px; margin:20px auto 120px; padding:0 18px; position:relative; z-index:3 }
  .grid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(var(--col-min),1fr));
    grid-auto-rows: var(--row); grid-auto-flow:dense; gap:var(--gap);
  }

  /* card */
  .card{
    position:relative; border-radius:20px; overflow:hidden; background:var(--glass);
    border:1px solid var(--ring);
    box-shadow: 0 24px 60px -36px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.85);
    transition: transform .18s ease, box-shadow .18s ease;
    will-change: transform;
  }
  .card:hover{ transform: translateY(-3px); box-shadow:0 36px 88px -48px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.95) }

  .ph{
    position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center;
    background:#fff; border-radius:16px; margin:10px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
  }
  .ph img{
    width:100%; height:100%; object-fit:contain; display:block; transform:scale(1); transition:transform .28s ease;
  }
  .card:hover .ph img{ transform:scale(1.06) } /* zoom */

  /* pager */
  .pager{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:4; display:flex; gap:10px }
  .pbtn{
    width:44px; height:44px; border-radius:999px; border:1px solid var(--fab-border); background:#fff;
    box-shadow:0 12px 30px -18px rgba(0,0,0,.45); cursor:pointer; font-size:18px; font-weight:800; display:flex; align-items:center; justify-content:center;
  }
  .pbtn[disabled]{ opacity:.45; cursor:not-allowed }

  /* FABs */
  .fab-wrap{ position:fixed; right:16px; bottom:16px; z-index:4; display:flex; flex-direction:column; gap:10px }
  .fab{
    width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    background:var(--fab-bg); border:1px solid var(--fab-border); box-shadow:0 10px 28px -16px rgba(0,0,0,.45);
    cursor:pointer; user-select:none; font-weight:800;
  }
  .fab:hover{ transform:translateY(-1px) }

  /* skeleton */
  .skel{ border-radius:20px; border:1px solid var(--ring); height:260px;
    background:linear-gradient(90deg,#ffeef3,#fff7f9,#ffeef3); background-size:200% 100%; animation:sk 1.2s infinite }
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
</style>
</head>
<body>
  <div class="aurora" aria-hidden="true"></div>
  <div class="grain"  aria-hidden="true"></div>

  <!-- nav -->
  <nav class="topbar">
    <a href="/life.html">Life</a>
    <a href="/upload.html">Upload</a>
    <a class="active" href="/gallery.html">Gallery</a>
    <a href="/auth/logout">Logout</a>
  </nav>

  <!-- particles -->
  <div class="particles" id="particles" aria-hidden="true"></div>

  <!-- content -->
  <div class="wrap">
    <div id="grid" class="grid" aria-live="polite">
      <div class="skel"></div><div class="skel"></div><div class="skel"></div>
    </div>
  </div>

  <!-- pager -->
  <div class="pager">
    <button id="prevBtn" class="pbtn" title="Prev">‹</button>
    <button id="nextBtn" class="pbtn" title="Next">›</button>
    <span id="pinfo" class="sr"></span>
  </div>

  <!-- FABs -->
  <div class="fab-wrap">
    <button class="fab" id="musicBtn" title="Play/Pause">♪</button>
    <button class="fab" id="fxBtn"    title="Effects">✦</button>
  </div>

  <!-- music -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="/music/bg.mp3" type="audio/mpeg">
  </audio>

<script>
  /* ---------- soft auth ---------- */
  (async function(){
    try{
      const r = await fetch('/api/diag',{credentials:'include',cache:'no-store'});
      if(!r.ok) location.href='/index.html';
    }catch{ location.href='/index.html'; }
  })();

  /* ---------- particles (bokeh dots) ---------- */
  (function spawnParticles(){
    const root=document.getElementById('particles');
    const N=42;
    for(let i=0;i<N;i++){
      const d=document.createElement('div'); d.className='dot';
      d.style.left = (Math.random()*100)+'vw';
      d.style.top  = (Math.random()*100)+'vh';
      d.style.setProperty('--dx', (Math.random()*80-40)+'px');
      d.style.setProperty('--dy', (-40 - Math.random()*100)+'px');
      d.style.setProperty('--dur', (16+Math.random()*18)+'s');
      d.style.animationDelay = (Math.random()*10)+'s';
      root.appendChild(d);
    }
  })();

  /* ---------- masonry helpers ---------- */
  function applyMasonrySpan(card, img){
    const row = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row')) || 8;
    const padding = 20 + 20; // .ph margins total (inset 10 + 10 each side)
    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    const columnWidth = card.clientWidth;
    if(!w || !h || !columnWidth) return;
    const displayHeight = (h * columnWidth) / w; // contain
    const rowSpan = Math.ceil((displayHeight + padding) / row);
    card.style.gridRowEnd = `span ${rowSpan}`;
  }

  /* ---------- gallery logic (18/page, recent-first) ---------- */
  (function(){
    const PAGE_SIZE=18;
    const grid=document.getElementById('grid');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const pinfo=document.getElementById('pinfo');

    // lightbox (minimal)
    const lb=document.createElement('div');
    lb.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:6;';
    lb.innerHTML=`<button id="lbClose" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
      <img id="lbImg" alt="" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);" />`;
    document.body.appendChild(lb);
    const lbImg=lb.querySelector('#lbImg'), lbClose=lb.querySelector('#lbClose');
    lbClose.onclick=()=>{ lb.style.display='none'; lbImg.src='' };
    lb.addEventListener('click',e=>{ if(e.target===lb) lbClose.onclick(); });
    window.addEventListener('keydown',e=>{ if(lb.style.display==='flex' && e.key==='Escape') lbClose.onclick(); });

    let all=[], page=getPage();

    function getPage(){ const u=new URL(location.href); const v=parseInt(u.searchParams.get('page')||'1',10); return (Number.isFinite(v)&&v>0)?v:1 }
    function setPage(p){ const u=new URL(location.href); u.searchParams.set('page',p); history.replaceState(null,'',u.toString()) }

    function clear(){ grid.innerHTML=''; }

    function makeCard(item){
      const fig=document.createElement('figure'); fig.className='card';
      const ph = document.createElement('div'); ph.className='ph';
      const img=document.createElement('img'); img.loading='lazy'; img.alt='Memory';
      img.src=`/api/file/${encodeURIComponent(item.id)}?v=${Date.now()}`;
      ph.appendChild(img); fig.appendChild(ph);

      img.addEventListener('load',()=>applyMasonrySpan(fig, img));
      fig.addEventListener('click',()=>{ lbImg.src=img.src; lb.style.display='flex'; });

      // temporary span in case load slow
      fig.style.gridRowEnd = `span ${Math.ceil(260 / (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row'))||8))}`;
      return fig;
    }

    function render(){
      clear();
      const total=all.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
      if(page>pages) page=pages;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,total);
      const frag=document.createDocumentFragment();
      all.slice(start,end).forEach(it=>frag.appendChild(makeCard(it)));
      grid.appendChild(frag);
      prevBtn.disabled=(page<=1); nextBtn.disabled=(page>=pages);
      pinfo.textContent=`${page}/${pages}`;
      setPage(page);
    }

    function extractTime(o){
      const keys=['createdAt','uploadedAt','time','timestamp','ts','date'];
      for(const k of keys){ if(o[k]){ const d=new Date(o[k]); if(!isNaN(d)) return d.getTime(); } }
      if (typeof o.id==='string' && /^\d{10,}$/.test(o.id)) return parseInt(o.id,10);
      return 0;
    }

    (async function load(){
      try{
        const r=await fetch('/api/list',{credentials:'include',cache:'no-store'});
        if(!r.ok) throw new Error('list failed');
        const data=await r.json();
        all = Array.isArray(data) ? data.slice() : [];
        all.sort((a,b)=>extractTime(b)-extractTime(a)); // recent first
        render();
        // Recalculate spans after first paint for safety
        setTimeout(()=>document.querySelectorAll('.card').forEach(c=>{
          const img=c.querySelector('img'); if(img && img.complete) applyMasonrySpan(c,img);
        }), 300);
      }catch(e){
        clear();
        const msg=document.createElement('div'); msg.style.padding='24px'; msg.style.background='#fff'; msg.style.border='1px solid #f0c8d4'; msg.style.borderRadius='14px';
        msg.textContent='Could not load gallery.'; grid.appendChild(msg);
        console.error(e);
      }
    })();

    prevBtn.onclick=()=>{ page=Math.max(1,page-1); render(); };
    nextBtn.onclick=()=>{ page=page+1; render(); };
  })();

  /* ---------- music + effects (persist state) ---------- */
  (function(){
    const audio=document.getElementById('bgMusic');
    const musicBtn=document.getElementById('musicBtn');
    const fxBtn=document.getElementById('fxBtn');
    const particles=document.getElementById('particles');

    let fxOn   = localStorage.getItem('fxOn')   !== 'false'; // default true
    let musicOn= localStorage.getItem('musicOn')=== 'true';

    particles.style.display = fxOn ? 'block' : 'none';

    fxBtn.addEventListener('click', ()=>{
      fxOn = !fxOn;
      particles.style.display = fxOn ? 'block' : 'none';
      localStorage.setItem('fxOn', fxOn);
    });

    const resume = () => { if(musicOn) audio.play().catch(()=>{}); document.removeEventListener('pointerdown', resume); };
    document.addEventListener('pointerdown', resume, {once:true});

    musicBtn.addEventListener('click', ()=>{
      if(audio.paused){ audio.play().then(()=>{ musicOn=true; localStorage.setItem('musicOn','true'); }).catch(()=>{}); }
      else { audio.pause(); musicOn=false; localStorage.setItem('musicOn','false'); }
    });
  })();
</script>
</body>
</html>
