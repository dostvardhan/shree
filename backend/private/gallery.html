<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gallery — Sweet Memories</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --text:#5a3740;
  --muted:#7a5a5f;
  --bg-card:rgba(255,255,255,0.92);
  --shadow:0 14px 35px rgba(0,0,0,0.18);
  --radius:18px;
}
body {
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  color:var(--text);
  background:url("assets/img/gallery-bg-hearts.png") center/cover no-repeat fixed;
  overflow-x:hidden;
}

/* 🔹 Navigation */
nav.topbar {
  display:flex;justify-content:center;gap:10px;
  position:sticky;top:14px;z-index:10;
}
nav.topbar a {
  text-decoration:none;
  font-weight:600;
  font-size:13px;
  color:var(--text);
  padding:8px 14px;
  border-radius:999px;
  background:linear-gradient(180deg,#ffeef2,#ffdee8);
  border:1px solid #f2c3d1;
  box-shadow:0 8px 20px -12px rgba(0,0,0,.3);
}
nav.topbar a.active { background:#fff; }

/* 🔹 Heading */
h1 {
  font-family:"Playfair Display",serif;
  text-align:center;
  font-size:clamp(22px,3vw,34px);
  margin:26px 0 12px;
  text-shadow:0 1px 0 rgba(255,255,255,0.7);
}

/* 🔹 Gallery Grid */
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:22px;
  max-width:1150px;
  margin:0 auto;
  padding:10px 20px 60px;
}

/* 🔹 Photo Card (new floating glass frame) */
.card {
  background:var(--bg-card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid rgba(0,0,0,0.05);
  overflow:hidden;
  cursor:pointer;
  position:relative;
  transition:transform .25s ease, box-shadow .25s ease;
}
.card:hover {
  transform:translateY(-8px);
  box-shadow:0 22px 45px rgba(0,0,0,0.25);
}

/* poster region */
.poster {
  position:relative;
  width:100%;
  aspect-ratio:3/4;
  overflow:hidden;
  border-radius:var(--radius);
}

/* blurred fill behind transparent or smaller photos */
.poster .fill {
  position:absolute;inset:0;
  background-size:cover;background-position:center;
  filter:blur(16px) brightness(0.95);
  transform:scale(1.05);
  opacity:0.8;
}

/* 🔹 Photo area */
.photo {
  position:absolute;inset:8px;
  background:linear-gradient(180deg,#fff,#fafafa);
  border-radius:calc(var(--radius) - 6px);
  box-shadow:inset 0 2px 6px rgba(255,255,255,0.8);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.photo img {
  max-width:100%;
  max-height:100%;
  object-fit:contain; /* ✅ no cropping now */
  transition:transform .35s ease, filter .3s ease;
  border-radius:10px;
}
.card:hover .photo img {
  transform:scale(1.06);
  filter:brightness(1.03) contrast(1.05);
}

/* hover light reflection */
.card::after {
  content:"";
  position:absolute;inset:0;
  border-radius:var(--radius);
  background:linear-gradient(145deg,rgba(255,255,255,0.05),rgba(255,255,255,0));
  opacity:0;
  transition:opacity .3s;
}
.card:hover::after { opacity:1; }

/* 🔹 Caption overlay */
.caption {
  position:absolute;bottom:10px;left:10px;right:10px;
  background:rgba(0,0,0,0.55);
  color:#fff;padding:6px 8px;
  border-radius:8px;
  font-size:13px;text-align:center;
  opacity:0;transform:translateY(6px);
  transition:opacity .25s, transform .25s;
}
.card:hover .caption {opacity:1;transform:translateY(0);}

/* 🔹 Pagination */
.pager {display:flex;justify-content:center;gap:10px;padding:20px 0 40px;}
.pbtn {
  width:42px;height:42px;border-radius:50%;
  border:none;background:white;cursor:pointer;
  font-weight:700;
  box-shadow:0 10px 24px -16px rgba(0,0,0,0.4);
}
.pbtn[disabled]{opacity:.5;cursor:not-allowed}

/* 🔹 Floating buttons */
.fab-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;}
.fab{
  width:48px;height:48px;border-radius:50%;
  background:#ffffffcc;
  border:1px solid #f0c4cc;
  box-shadow:0 10px 28px -16px rgba(0,0,0,0.45);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;cursor:pointer;
}
</style>
</head>
<body>

<!-- Auth Guard -->
<script>
(async()=>{
 try{
  const r=await fetch('/api/diag',{credentials:'include'});
  if(!r.ok)throw 0;
 }catch{location.href='/index.html';}
})();
</script>

<nav class="topbar">
 <a href="/life.html">Life</a>
 <a href="/upload.html">Upload</a>
 <a href="/auth/logout">Logout</a>
</nav>

<h1>Sweet Memories of Shreshtha’s Life</h1>

<section id="grid" class="grid">
  <div class="card" style="opacity:0.4;height:200px;"></div>
</section>

<div class="pager">
  <button id="prevBtn" class="pbtn">‹</button>
  <button id="nextBtn" class="pbtn">›</button>
</div>

<div class="fab-wrap">
  <button class="fab" id="musicBtn">♪</button>
  <button class="fab" id="heartBtn">❤</button>
</div>

<audio id="bgMusic" loop preload="auto"><source src="/music/bg.mp3" type="audio/mpeg"></audio>

<script>
/* Lightbox */
const lb=(()=>{const e=document.createElement("div");
e.style.cssText="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:99;";
e.innerHTML=`<button id='x' style='position:absolute;top:20px;right:20px;padding:8px 12px;color:white;background:#ffffff20;border:1px solid #ffffff40;border-radius:50%;font-size:20px;cursor:pointer;'>✕</button>
<img id='img' style='max-width:90vw;max-height:85vh;border-radius:12px;'>`;
document.body.appendChild(e);
const i=e.querySelector("#img"),c=e.querySelector("#x");
c.onclick=()=>{e.style.display="none";i.src=""};
e.addEventListener("click",t=>{if(t.target===e)c.onclick()});
return{open(s){i.src=s;e.style.display="flex"}}})();

/* Gallery */
(async()=>{
 const grid=document.getElementById('grid'),
 prev=document.getElementById('prevBtn'),
 next=document.getElementById('nextBtn');
 const PAGE=24;
 function getTime(i){for(let k of ['createdAt','uploadedAt','time','date','timestamp'])if(i?.[k])return new Date(i[k]).getTime();return 0;}
 async function createCard(it){
   const el=document.createElement('div');el.className='card';
   el.innerHTML=`<div class='poster'><div class='fill'></div><div class='photo'><img/></div><div class='caption'></div></div>`;
   const id=it.id||it._id;
   if(id){
     try{
       const res=await fetch('/api/file/'+id,{credentials:'include'});
       if(!res.ok)throw 0;
       const blob=await res.blob();
       const url=URL.createObjectURL(blob);
       const img=el.querySelector('img');
       img.src=url;
       el.querySelector('.fill').style.backgroundImage=`url('${url}')`;
       el.querySelector('.caption').textContent=it.caption||"";
       el.onclick=()=>lb.open(url);
     }catch{}
   }
   return el;
 }
 function render(list,page){
   grid.innerHTML='';
   const total=list.length,pages=Math.ceil(total/PAGE)||1;
   if(page>pages)page=pages;
   list.slice((page-1)*PAGE,page*PAGE).forEach(async i=>grid.appendChild(await createCard(i)));
   prev.disabled=page<=1;next.disabled=page>=pages;
 }
 try{
   const res=await fetch('/api/list',{credentials:'include'});
   const data=await res.json();
   let items=Array.isArray(data)?data:(data.items||[]);
   items=items.sort((a,b)=>getTime(b)-getTime(a));
   let page=1;render(items,page);
   prev.onclick=()=>{if(page>1){page--;render(items,page)}};
   next.onclick=()=>{page++;render(items,page)};
 }catch{grid.innerHTML='<p style="text-align:center;color:#603a3b;">Unable to load photos.</p>';}
})();

/* Music */
(()=>{
 const a=document.getElementById('bgMusic'),b=document.getElementById('musicBtn');
 let on=localStorage.getItem('musicOn')==='true';
 if(on)a.play().catch(()=>{});
 b.onclick=()=>{if(a.paused){a.play();on=true;}else{a.pause();on=false;}localStorage.setItem('musicOn',on)};
})();
</script>

</body>
</html>
