<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --ink:#2b2225;
    --ring:rgba(0,0,0,.10);
    --fab-bg:#ffffffd8;
    --fab-border:#f0c8d4;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial;
    /* smooth pink blend + micro noise */
    background:
      radial-gradient(1400px 900px at 12% -10%, #fff5fa 0%, #ffdbe9 40%, #ffc2d6 85%, #ffb2ca 100%),
      radial-gradient(1200px 750px at 85% 110%, #ffe6f0 0%, #ffd4e3 60%, #ffb7ce 100%),
      linear-gradient(180deg, #ffffff00 0%, #ffffff40 45%, #ffffff00 100%),
      repeating-linear-gradient(0deg, #0000, #0000 9px, #00000007 9px, #00000007 10px);
    background-blend-mode: normal, normal, soft-light, overlay;
    overflow-x:hidden;
  }

  /* top tiny nav */
  .topbar{
    position:sticky; top:0; z-index:6;
    display:flex; justify-content:center; gap:10px; padding:10px;
    background:#ffecf2c7; backdrop-filter:blur(8px);
    border-bottom:1px solid #f4c6d3;
  }
  .topbar a{
    text-decoration:none; color:#6f5560; font-weight:700; font-size:14px;
    padding:7px 12px; border-radius:999px; background:#ffdbe4; border:1px solid #f6c7d2;
    box-shadow:0 6px 18px -12px #00000033;
  }
  .topbar a.active{ background:#fff }

  /* rainbow hearts (bigger, slow, glow) */
  .hearts{ position:fixed; inset:0; pointer-events:none; z-index:3; mix-blend-mode:screen }
  .heart{
    position:absolute; transform:rotate(45deg);
    width: var(--size,16px); height: var(--size,16px); border-radius:3px;
    background: linear-gradient(145deg,
              hsl(var(--hue,330) 95% 65% / .95),
              hsl(var(--hue,330) 95% 55% / .95));
    filter: drop-shadow(0 0 6px hsl(var(--hue,330) 95% 60% / .85))
            drop-shadow(0 0 14px hsl(var(--hue,330) 95% 55% / .55));
    animation: float var(--dur,24s) linear infinite;
    will-change: transform;
  }
  .heart::before,.heart::after{
    content:""; position:absolute; width:100%; height:100%; border-radius:50%;
    background:inherit; left:-50%; top:0; filter:inherit;
  }
  .heart::after{ left:0; top:-50% }
  @keyframes float{
    0%   { transform: translate(var(--x,0), 0) rotate(45deg) scale(.95); opacity:.55 }
    50%  { transform: translate(calc(var(--x,0) * -1), -65vh) rotate(45deg) scale(1); opacity:.65 }
    100% { transform: translate(var(--x,0), -130vh) rotate(45deg) scale(1.05); opacity:0 }
  }

  /* grid */
  .grid{
    max-width:1200px; margin:18px auto 110px; padding:0 18px;
    display:grid; gap:22px;
    grid-template-columns: repeat(3, 1fr);
  }
  @media (max-width:1000px){ .grid{grid-template-columns: repeat(3, 1fr)} }
  @media (max-width:900px){ .grid{grid-template-columns: repeat(2, 1fr)} }
  @media (max-width:560px){ .grid{grid-template-columns: 1fr} }

  /* photo card with hover zoom */
  .card{
    position:relative; aspect-ratio:3/4; border-radius:26px; overflow:hidden;
    background:#fff; border:1px solid var(--ring);
    box-shadow:0 28px 70px -40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.9);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 34px 90px -50px rgba(0,0,0,.65), inset 0 0 0 1px rgba(255,255,255,1) }

  .paper{
    position:absolute; inset:12px; border-radius:20px;
    background: linear-gradient(180deg,#ffffff,#fff7fb);
    box-shadow: inset 0 2px 30px rgba(0,0,0,.06);
  }
  .photo{
    position:absolute; inset:20px; border-radius:16px; z-index:1;
    display:flex; align-items:center; justify-content:center;
    background:#fff; box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
    overflow:hidden;
  }
  .photo img{
    max-width:100%; max-height:100%;
    width:auto; height:auto; object-fit:contain; display:block; border-radius:12px;
    transform:scale(1); transition: transform .25s ease;
  }
  .card:hover .photo img{ transform:scale(1.05) }  /* HOVER ZOOM */

  /* pager */
  .pager{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:7;
    display:flex; gap:10px;
  }
  .pbtn{
    width:44px; height:44px; border-radius:999px;
    border:1px solid var(--fab-border); background:#fff;
    box-shadow:0 12px 30px -18px rgba(0,0,0,.45); cursor:pointer;
    font-size:18px; font-weight:800; display:flex; align-items:center; justify-content:center;
  }
  .pbtn[disabled]{ opacity:.45; cursor:not-allowed }

  /* FABs — same rounded style */
  .fab-wrap{ position:fixed; right:16px; bottom:16px; z-index:7; display:flex; flex-direction:column; gap:10px }
  .fab{
    width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    background:var(--fab-bg); border:1px solid var(--fab-border); box-shadow:0 10px 28px -16px rgba(0,0,0,.45);
    cursor:pointer; user-select:none; font-weight:800;
  }
  .fab:hover{ transform:translateY(-1px) }

  /* skeletons */
  .skeleton{ aspect-ratio:3/4; border-radius:26px; border:1px solid var(--ring);
    background:linear-gradient(90deg,#ffeef3,#fff7f9,#ffeef3); background-size:200% 100%; animation:sk 1.2s infinite }
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
</style>
</head>
<body>
  <!-- top nav -->
  <nav class="topbar">
    <a href="/life.html">Life</a>
    <a href="/upload.html">Upload</a>
    <a class="active" href="/gallery.html">Gallery</a>
    <a href="/auth/logout">Logout</a>
  </nav>

  <!-- hearts -->
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <!-- grid -->
  <main class="grid" id="grid" aria-live="polite">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </main>

  <!-- pager -->
  <div class="pager">
    <button id="prevBtn" class="pbtn" title="Prev">‹</button>
    <button id="nextBtn" class="pbtn" title="Next">›</button>
    <span id="pinfo" class="sr" aria-live="polite"></span>
  </div>

  <!-- FABs -->
  <div class="fab-wrap">
    <button class="fab" id="musicBtn" title="Play/Pause">♪</button>
    <button class="fab" id="heartsBtn" title="Hearts">❤</button>
  </div>

  <!-- music file -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="/music/bg.mp3" type="audio/mpeg">
  </audio>

<script>
  /* soft auth */
  (async function(){
    try{
      const r = await fetch('/api/diag',{credentials:'include',cache:'no-store'});
      if(!r.ok) location.href='/index.html';
    }catch{ location.href='/index.html'; }
  })();

  /* rainbow hearts spawn (dense, slow) */
  (function(){
    const root = document.getElementById('hearts');
    const N = 36;
    for(let i=0;i<N;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      const hue = Math.floor(Math.random()*360);
      const dur = 18 + Math.random()*14;     // 18–32s
      const size = 14 + Math.random()*12;
      const xDrift = (Math.random()*40 - 20) + 'px';
      h.style.setProperty('--hue', hue);
      h.style.setProperty('--dur', dur+'s');
      h.style.setProperty('--size', size+'px');
      h.style.setProperty('--x', xDrift);
      h.style.left = (Math.random()*100)+'vw';
      h.style.bottom = (-20 - Math.random()*50)+'vh';
      h.style.animationDelay = (Math.random()*10)+'s';
      root.appendChild(h);
    }
  })();

  /* gallery (18/page, recent-first) */
  (function(){
    const PAGE_SIZE=18;
    const grid=document.getElementById('grid');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const pinfo=document.getElementById('pinfo');

    // lightbox
    const lb=document.createElement('div');
    lb.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:8;';
    lb.innerHTML=`<button id="lbClose" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
      <button id="lbPrev" style="position:absolute;left:16px;top:50%;transform:translateY(-50%);background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">‹</button>
      <img id="lbImg" alt="" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);" />
      <button id="lbNext" style="position:absolute;right:16px;top:50%;transform:translateY(-50%);background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">›</button>`;
    document.body.appendChild(lb);
    const lbImg=lb.querySelector('#lbImg'), lbPrev=lb.querySelector('#lbPrev'), lbNext=lb.querySelector('#lbNext'), lbClose=lb.querySelector('#lbClose');

    let all=[], page=getPage(), currentIndexOnPage=-1;
    function getPage(){ const u=new URL(location.href); const v=parseInt(u.searchParams.get('page')||'1',10); return (Number.isFinite(v)&&v>0)?v:1 }
    function setPage(p){ const u=new URL(location.href); u.searchParams.set('page',p); history.replaceState(null,'',u.toString()) }
    function clear(){ grid.innerHTML='' }

    function card(item, index){
      const fig=document.createElement('figure'); fig.className='card';
      const paper=document.createElement('div'); paper.className='paper';
      const box=document.createElement('div'); box.className='photo';
      const image=document.createElement('img');
      image.loading='lazy'; image.alt='Memory';
      image.referrerPolicy='same-origin';
      image.src=`/api/file/${encodeURIComponent(item.id)}?v=${Date.now()}`; // cache-bust
      box.appendChild(image); fig.appendChild(paper); fig.appendChild(box);
      fig.addEventListener('click',()=>open(index));
      return fig;
    }

    function render(){
      clear();
      const total=all.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
      if(page>pages) page=pages;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,total);
      const frag=document.createDocumentFragment();
      all.slice(start,end).forEach((it,i)=>frag.appendChild(card(it,i)));
      grid.appendChild(frag);
      prevBtn.disabled=(page<=1); nextBtn.disabled=(page>=pages);
      pinfo.textContent=`${page}/${pages}`;
      setPage(page);
    }

    function open(i){
      currentIndexOnPage=i;
      const gi=(page-1)*PAGE_SIZE+i;
      lbImg.src=`/api/file/${encodeURIComponent(all[gi].id)}?v=${Date.now()}`;
      lb.style.display='flex';
    }
    function close(){ lb.style.display='none'; lbImg.src='' }
    function step(d){
      if(currentIndexOnPage<0) return;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, all.length);
      const gi=start+currentIndexOnPage+d;
      if(gi<start || gi>=end) return;
      currentIndexOnPage+=d;
      lbImg.src=`/api/file/${encodeURIComponent(all[start+currentIndexOnPage].id)}?v=${Date.now()}`;
    }
    lbClose.onclick=close; lbPrev.onclick=()=>step(-1); lbNext.onclick=()=>step(1);
    lb.addEventListener('click',e=>{ if(e.target===lb) close(); });
    window.addEventListener('keydown',e=>{ if(lb.style.display!=='flex') return; if(e.key==='Escape') close(); if(e.key==='ArrowLeft') step(-1); if(e.key==='ArrowRight') step(1); });

    function extractTime(o){
      const keys=['createdAt','uploadedAt','time','timestamp','ts','date'];
      for(const k of keys){ if(o[k]){ const d=new Date(o[k]); if(!isNaN(d)) return d.getTime(); } }
      if (typeof o.id==='string' && /^\d{10,}$/.test(o.id)) return parseInt(o.id,10);
      return 0;
    }

    (async function fetchList(){
      try{
        const r=await fetch('/api/list',{credentials:'include',cache:'no-store'});
        if(!r.ok) throw new Error('list failed');
        const data=await r.json();
        all=(Array.isArray(data)?data.slice():[]);
        all.sort((a,b)=>extractTime(b)-extractTime(a)); // recent first
        render();
      }catch(e){
        clear();
        const msg=document.createElement('div'); msg.style.padding='24px'; msg.style.background='#fff'; msg.style.border='1px solid #f0c8d4'; msg.style.borderRadius='14px';
        msg.textContent='Could not load gallery.'; grid.appendChild(msg);
        console.error('Gallery load error:', e);
      }
    })();

    prevBtn.onclick=()=>{ page=Math.max(1,page-1); render(); };
    nextBtn.onclick=()=>{ page=page+1; render(); };
  })();

  /* music + hearts (state persists across pages) */
  (function(){
    const audio=document.getElementById('bgMusic');
    const musicBtn=document.getElementById('musicBtn');
    const heartsBtn=document.getElementById('heartsBtn');
    const hearts=document.getElementById('hearts');

    let heartsOn = localStorage.getItem('heartsOn') !== 'false'; // default true
    let musicOn  = localStorage.getItem('musicOn') === 'true';

    hearts.style.display = heartsOn ? 'block' : 'none';
    heartsBtn.addEventListener('click', ()=>{
      heartsOn = !heartsOn; hearts.style.display = heartsOn ? 'block' : 'none';
      localStorage.setItem('heartsOn', heartsOn);
    });

    const tryResume = () => { if(musicOn) audio.play().catch(()=>{}); document.removeEventListener('pointerdown', tryResume); };
    document.addEventListener('pointerdown', tryResume, { once:true });

    musicBtn.addEventListener('click', ()=>{
      if(audio.paused){ audio.play().then(()=>{ musicOn = true; localStorage.setItem('musicOn','true'); }).catch(()=>{}); }
      else { audio.pause(); musicOn = false; localStorage.setItem('musicOn','false'); }
    });
  })();
</script>
</body>
</html>
