<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery — Sweet Memories</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --text: #603a3b;
    --card-bg: rgba(255, 255, 255, 0.9);
    --ring: rgba(0, 0, 0, 0.08);
    --shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; scroll-behavior: smooth; }

  body {
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--text);
    background: url("assets/img/gallery-bg-hearts.png") center/cover no-repeat fixed;
    overflow-x: hidden;
  }

  /* Soft overlay gradient for text visibility */
  body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(1000px 700px at 50% 35%, transparent 40%, rgba(0, 0, 0, 0.06) 100%);
    mix-blend-mode: multiply;
    z-index: 0;
  }

  /* Navigation bar */
  .topbar {
    position: sticky;
    top: 10px;
    z-index: 10;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .topbar a {
    text-decoration: none;
    padding: 8px 14px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 14px;
    color: #6d535b;
    background: #ffdfeb;
    border: 1px solid #f2c3d1;
    box-shadow: 0 8px 20px -12px rgba(0,0,0,0.35);
  }
  .topbar a.active { background: #fff; }

  /* Title */
  .title {
    font-family: "Playfair Display", serif;
    text-align: center;
    font-size: clamp(22px, 3.2vw, 34px);
    margin: 24px 0 18px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.7);
    z-index: 2;
    position: relative;
  }

  /* Grid container */
  .grid {
    display: grid;
    gap: 22px;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px 20px 60px;
    position: relative;
    z-index: 2; /* so it floats above hearts */
  }

  /* Cards (each photo box) */
  .card {
    position: relative;
    border-radius: 18px;
    background: var(--card-bg);
    border: 1px solid var(--ring);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }

  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 26px 60px -26px rgba(0, 0, 0, 0.4);
  }

  .poster {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
  }

  .fill {
    position: absolute;
    inset: 0;
    background-position: center;
    background-size: cover;
    filter: blur(14px) brightness(0.98);
    transform: scale(1.04);
    opacity: 0.9;
  }

  .photo {
    position: absolute;
    inset: 10px;
    border-radius: 12px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
  }

  .photo img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.24s ease;
  }

  .card:hover .photo img { transform: scale(1.04); }

  .cap {
    padding: 8px 10px 12px;
    font-size: 13px;
    color: #6b3a3c;
    background: #fff8f5;
    border-top: 1px solid var(--ring);
    text-align: center;
  }

  /* Pager */
  .pager {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px 0 40px;
  }

  .pbtn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 10px 24px -16px rgba(0,0,0,0.45);
  }

  .pbtn[disabled] { opacity: 0.45; cursor: not-allowed; }

  /* Floating buttons */
  .fab-wrap {
    position: fixed;
    right: 14px;
    bottom: 14px;
    z-index: 20;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .fab {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ffffffde;
    border: 1px solid #f0c4cc;
    box-shadow: 0 10px 28px -16px rgba(0,0,0,0.45);
    font-weight: 800;
    cursor: pointer;
  }

</style>

<script>
  // Simple guard (redirects to login if not logged in)
  (async function ensureSignedIn(){
    try {
      const r = await fetch('/api/diag', { credentials:'include', cache:'no-store' });
      if(!r.ok) throw 0;
    } catch {
      location.href='/index.html';
    }
  })();
</script>
</head>

<body>

<nav class="topbar">
  <a href="/life.html">Life</a>
  <a href="/upload.html">Upload</a>
  <a class="active" href="/gallery.html">Gallery</a>
  <a href="/auth/logout">Logout</a>
</nav>

<h1 class="title">Sweet Memories of Shreshtha’s Life</h1>

<section id="grid" class="grid" aria-live="polite">
  <div class="card" style="height:260px;opacity:.45"></div>
  <div class="card" style="height:260px;opacity:.45"></div>
  <div class="card" style="height:260px;opacity:.45"></div>
</section>

<div class="pager">
  <button id="prevBtn" class="pbtn">‹</button>
  <button id="nextBtn" class="pbtn">›</button>
</div>

<div class="fab-wrap">
  <button class="fab" id="musicBtn" title="Play/Pause">♪</button>
  <button class="fab" id="heartsBtn" title="Hearts">❤</button>
</div>

<audio id="bgMusic" preload="auto" loop>
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>

<script>
/* Lightbox for image preview */
const lb = (() => {
  const el = document.createElement('div');
  el.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:99;';
  el.innerHTML = `
    <button id="x" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
    <img id="im" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);">
  `;
  document.body.appendChild(el);
  const im = el.querySelector('#im'), x = el.querySelector('#x');
  x.onclick = () => { el.style.display='none'; im.src=''; };
  el.addEventListener('click', e => { if(e.target === el) x.onclick(); });
  addEventListener('keydown', e => { if(e.key==='Escape' && el.style.display==='flex') x.onclick(); });
  return { open: src => { im.src = src; el.style.display = 'flex'; } };
})();

/* Gallery logic */
(function(){
  const GRID = document.getElementById('grid');
  const PREV = document.getElementById('prevBtn');
  const NEXT = document.getElementById('nextBtn');
  const PAGE = 18;

  function when(i){
    for (const k of ['createdAt','uploadedAt','time','timestamp','ts','date']){
      if (i?.[k]) { const d = new Date(i[k]); if(!isNaN(d)) return d.getTime(); }
    } return 0;
  }

  function caption(i){ return i?.caption || i?.title || i?.name || ''; }

  function skeleton(){
    const fig = document.createElement('figure'); fig.className='card';
    const poster=document.createElement('div'); poster.className='poster';
    const fill=document.createElement('div'); fill.className='fill';
    const ph=document.createElement('div'); ph.className='photo';
    const img=document.createElement('img'); img.loading='lazy';
    ph.appendChild(img); poster.appendChild(fill); poster.appendChild(ph); fig.appendChild(poster);
    const cap=document.createElement('figcaption'); cap.className='cap'; fig.appendChild(cap);
    return {fig,fill,img,cap};
  }

  async function makeCard(item){
    const id=String(item?.id ?? item?._id ?? '');
    const {fig,fill,img,cap}=skeleton();
    cap.textContent = caption(item);
    fill.style.background='linear-gradient(135deg,#ffe3ea,#fff)';

    if(id){
      try{
        const r=await fetch(`/api/file/${encodeURIComponent(id)}`,{credentials:'include',cache:'no-store'});
        if(!r.ok) throw 0;
        const blob=await r.blob(); const url=URL.createObjectURL(blob);
        img.src=url; img.onload=()=>setTimeout(()=>URL.revokeObjectURL(url),2500);
        fill.style.backgroundImage=`url('${url}')`;
      }catch{}
    }
    fig.onclick=()=>{ if(img.src) lb.open(img.src); };
    return fig;
  }

  function render(items,page){
    GRID.innerHTML='';
    const total=items.length, pages=Math.max(1,Math.ceil(total/PAGE)); if(page>pages) page=pages;
    const s=(page-1)*PAGE, e=Math.min(s+PAGE,total);
    Promise.all(items.slice(s,e).map(makeCard)).then(nodes=>{
      const frag=document.createDocumentFragment(); nodes.forEach(n=>frag.appendChild(n)); GRID.appendChild(frag);
    });
    PREV.disabled=(page<=1); NEXT.disabled=(page>=pages);
    const u=new URL(location.href); u.searchParams.set('page',page); history.replaceState(null,'',u.toString());
  }

  let items=[], page=parseInt(new URL(location.href).searchParams.get('page')||'1',10); if(!(page>0)) page=1;

  (async()=>{
    try{
      const r=await fetch('/api/list',{credentials:'include',cache:'no-store'});
      if(!r.ok) throw 0;
      const data=await r.json();
      const arr=Array.isArray(data)?data:(Array.isArray(data?.items)?data.items:[]);
      items=arr.filter(Boolean).sort((a,b)=>when(b)-when(a));
      if(items.length===0){
        GRID.innerHTML='<div class="card" style="padding:14px;text-align:center">No photos yet. Try Upload page.</div>';
      }else{
        render(items,page);
      }
    }catch{
      GRID.innerHTML='<div class="card" style="padding:14px;text-align:center">Could not load gallery.</div>';
    }
  })();

  PREV.onclick=()=>{ page=Math.max(1,page-1); render(items,page); };
  NEXT.onclick=()=>{ page=page+1; render(items,page); };
})();

/* Music buttons */
(function(){
  const audio=document.getElementById('bgMusic');
  const musicBtn=document.getElementById('musicBtn');
  let musicOn=localStorage.getItem('musicOn')==='true';
  const resume=()=>{ if(musicOn) audio.play().catch(()=>{}); removeEventListener('pointerdown',resume); };
  addEventListener('pointerdown',resume,{once:true});
  musicBtn.onclick=()=>{ if(audio.paused){ audio.play().then(()=>{musicOn=true;localStorage.setItem('musicOn','true');}).catch(()=>{}); }
                         else { audio.pause(); musicOn=false; localStorage.setItem('musicOn','false'); } };
})();
</script>

</body>
</html>
