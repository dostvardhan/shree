<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery — Sweet Memories</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --text: #603a3b;
    --card-bg: rgba(255, 255, 255, 0.92);
    --ring: rgba(0, 0, 0, 0.08);
    --shadow: 0 18px 40px rgba(0, 0, 0, 0.15);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }

  /* ✅ Background with hearts */
  body {
    font-family: Inter, system-ui, sans-serif;
    color: var(--text);
    background: url("assets/img/gallery-bg-hearts.png") center/cover no-repeat fixed;
    overflow-x: hidden;
  }

  /* Title */
  .title {
    font-family: "Playfair Display", serif;
    text-align: center;
    font-size: clamp(22px, 3vw, 34px);
    margin: 25px 0 16px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.7);
  }

  /* Navigation */
  .topbar {
    position: sticky;
    top: 10px;
    z-index: 10;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .topbar a {
    text-decoration: none;
    padding: 8px 14px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 13px;
    color: #6d535b;
    background: #ffdfeb;
    border: 1px solid #f2c3d1;
    box-shadow: 0 8px 20px -12px rgba(0,0,0,0.3);
  }
  .topbar a.active { background: #fff; }

  /* Image Grid */
  .grid {
    display: grid;
    gap: 22px;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px 20px 40px;
    position: relative;
    z-index: 2;
  }

  /* Each card */
  .card {
    position: relative;
    border-radius: 18px;
    background: var(--card-bg);
    border: 1px solid var(--ring);
    box-shadow: var(--shadow);
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 26px 60px -26px rgba(0,0,0,0.4);
  }

  .poster {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
  }

  /* Blurred fill behind actual photo */
  .fill {
    position: absolute;
    inset: 0;
    background-position: center;
    background-size: cover;
    filter: blur(14px) brightness(0.98);
    transform: scale(1.04);
    opacity: 0.9;
  }

  .photo {
    position: absolute;
    inset: 10px;
    background: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
  }
  .photo img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.24s ease;
  }
  .card:hover .photo img { transform: scale(1.04); }

  .cap {
    padding: 8px 10px;
    font-size: 13px;
    color: #6b3a3c;
    background: #fff7f5;
    border-top: 1px solid var(--ring);
    text-align: center;
  }

  /* Pagination */
  .pager {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px 0 40px;
  }
  .pbtn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 10px 24px -16px rgba(0,0,0,0.4);
  }
  .pbtn[disabled] { opacity: 0.5; cursor: not-allowed; }

  /* Floating Music/heart buttons */
  .fab-wrap {
    position: fixed;
    bottom: 14px;
    right: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 20;
  }
  .fab {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: #ffffffde;
    border: 1px solid #f0c4cc;
    box-shadow: 0 10px 28px -16px rgba(0,0,0,0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: 800;
  }
</style>

<script>
  /* ✅ Login guard */
  (async function(){
    try {
      const r = await fetch('/api/diag', { credentials:'include' });
      if(!r.ok) throw 0;
    } catch {
      location.href = '/index.html';
    }
  })();
</script>

</head>
<body>

<!-- ✅ Navigation -->
<nav class="topbar">
  <a href="/life.html">Life</a>
  <a href="/upload.html">Upload</a>
  <a class="active" href="/gallery.html">Gallery</a>
  <a href="/auth/logout">Logout</a>
</nav>

<h1 class="title">Sweet Memories of Shreshtha’s Life</h1>

<!-- ✅ Image Grid -->
<section id="grid" class="grid">
  <div class="card" style="height:250px;opacity:0.5"></div>
  <div class="card" style="height:250px;opacity:0.5"></div>
</section>

<!-- ✅ Pagination -->
<div class="pager">
  <button id="prevBtn" class="pbtn">‹</button>
  <button id="nextBtn" class="pbtn">›</button>
</div>

<!-- ✅ Floating buttons -->
<div class="fab-wrap">
  <button class="fab" id="musicBtn">♪</button>
  <button class="fab" id="heartsBtn">❤</button>
</div>

<audio id="bgMusic" preload="auto" loop>
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>

<script>
const lb = (() => {
  const el = document.createElement('div');
  el.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:100;';
  el.innerHTML = `
    <button id="close" style="position:absolute;top:20px;right:20px;padding:10px 14px;color:white;background:#ffffff25;border:1px solid #ffffff33;border-radius:50%;font-size:20px;cursor:pointer;">✕</button>
    <img id="img" style="max-width:90vw;max-height:85vh;border-radius:12px;">
  `;
  document.body.appendChild(el);

  const img = el.querySelector('#img');
  el.querySelector('#close').onclick = () => { el.style.display='none'; img.src=''; };
  el.addEventListener('click', e => { if(e.target === el) el.querySelector('#close').onclick(); });

  return {
    open(src){ img.src = src; el.style.display = 'flex'; }
  };
})();

/* ✅ Gallery logic */
(function(){
  const GRID=document.getElementById('grid');
  const PREV=document.getElementById('prevBtn');
  const NEXT=document.getElementById('nextBtn');
  const PAGE=18;

  function getTime(i){
    for(const k of ['createdAt','uploadedAt','timestamp','time','date']){
      if(i?.[k]) return new Date(i[k]).getTime();
    }
    return 0;
  }

  async function addCard(item){
    const id=item?.id || item?._id;
    const fig=document.createElement('div'); fig.className='card';

    const cap=item?.caption || item?.name || '';
    fig.innerHTML = `
      <div class="poster">
        <div class="fill"></div>
        <div class="photo"><img/></div>
      </div>
      <div class="cap">${cap}</div>
    `;

    GRID.appendChild(fig);

    if(!id) return;
    try{
      const r=await fetch('/api/file/'+id,{credentials:'include'});
      const blob=await r.blob();
      const url=URL.createObjectURL(blob);
      const img=fig.querySelector('img');
      const fill=fig.querySelector('.fill');
      img.src=url;
      fill.style.backgroundImage=`url('${url}')`;

      fig.onclick=()=> lb.open(url);
    }catch{}
  }

  function render(items,page){
    GRID.innerHTML='';
    const total=items.length;
    const pages=Math.ceil(total/PAGE)||1;
    if(page>pages) page=pages;

    items.slice((page-1)*PAGE,page*PAGE).forEach(addCard);

    PREV.disabled = page<=1;
    NEXT.disabled = page>=pages;
  }

  (async()=>{
    try{
      const r=await fetch('/api/list',{credentials:'include'});
      const data=await r.json();
      let items=Array.isArray(data)?data:data.items||[];
      items=items.sort((a,b)=>getTime(b)-getTime(a));
      let page=parseInt(new URL(location).searchParams.get('page'))||1;
      render(items,page);

      PREV.onclick=()=>{ if(page>1){page--; render(items,page);} };
      NEXT.onclick=()=>{ if(page*PAGE<items.length){page++; render(items,page);} };
    }catch{
      GRID.innerHTML='<p style="text-align:center;padding:20px">Unable to load photos.</p>';
    }
  })();
})();

/* ✅ Music toggle */
(function(){
  const audio=document.getElementById('bgMusic');
  const btn=document.getElementById('musicBtn');
  let on=localStorage.getItem('musicOn')==='true';

  const start=()=>{ if(on) audio.play().catch(()=>{}); removeEventListener('click',start); };
  addEventListener('click',start,{once:true});

  btn.onclick=()=> {
    if(audio.paused){ audio.play(); on=true; }
    else{ audio.pause(); on=false; }
    localStorage.setItem('musicOn',on);
  };
})();
</script>

</body>
</html>
