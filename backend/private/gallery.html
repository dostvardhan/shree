<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shreshtha – Gallery</title>

  <!-- Auth0 -->
  <script src="/auth0-spa-js.production.js"></script>
  <script src="auth-init.js" defer></script>
  <script src="guard-auth.js" defer></script>

  <!-- Page Style -->
  <style>
    :root { --text:#6e2430; }

    body {
      margin:0;
      font-family:"Playfair Display",serif;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 8% 12%, rgba(255,236,240,0.42), transparent 40%),
        radial-gradient(1000px 620px at 92% 84%, rgba(255,230,220,0.36), transparent 38%),
        radial-gradient(900px 520px at 50% -10%, rgba(255,210,210,0.28), transparent 45%),
        linear-gradient(160deg, #ffe9e6 0%, #ffcdc8 42%, #ffb7b2 70%, #ffa9a9 100%);
      background-attachment:fixed;
    }

    header { text-align:center; padding:24px 12px; }
    .page-title { font-size:48px; margin:0; color:#5a0013; }
    .page-links a {
      text-decoration:none; 
      color:#5a0013; 
      margin:0 10px;
      padding:8px 16px;
      background:rgba(255,255,255,0.2);
      border-radius:20px;
    }

    main { max-width:1200px; margin:auto; padding:20px; }

    .grid { 
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:20px;
    }

    .photo-card {
      background:rgba(255,255,255,0.1);
      border-radius:16px;
      padding:10px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
      transition:transform .3s;
    }
    .photo-card:hover { transform:translateY(-5px); }
    .photo-card img {
      width:100%;
      max-height:380px;
      object-fit:contain;
      border-radius:12px;
    }
    .meta {
      text-align:center;
      margin-top:8px;
      font-style:italic;
      font-size:14px;
    }
    .meta:empty { display:none; }

    /* pager */
    #pager {
      text-align:center;
      margin-top:25px;
    }
    #pager button {
      padding:10px 18px;
      margin:0 8px;
      border:none;
      background:rgba(255,255,255,0.25);
      border-radius:8px;
      cursor:pointer;
      font-size:15px;
    }
    #pager button:disabled { opacity:0.3; cursor:default; }

    /* Hearts Canvas */
    #fxCanvas {
      position:fixed;
      left:0;
      top:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:50;
    }
  </style>
</head>

<body>
  <header>
    <h1 class="page-title">Gallery of Sweet Memories</h1>
    <div class="page-links">
      <a href="life.html">Life</a> |
      <a href="upload.html">Upload</a> |
      <a href="logout.html">Logout</a>
    </div>
  </header>

  <main>
    <section id="grid" class="grid"></section>
    <div id="empty" style="display:none;text-align:center;margin-top:40px;">No photos yet 🌸</div>

    <div id="pager">
      <button id="prevBtn" disabled>← Prev</button>
      <button id="nextBtn">Next →</button>
    </div>
  </main>

  <!-- Hearts Canvas -->
  <canvas id="fxCanvas"></canvas>

  <!-- Floating Hearts Script -->
  <script>
  (function () {
    function initHearts(){
      const c = document.getElementById('fxCanvas');
      const ctx = c.getContext('2d');
      const DPR = window.devicePixelRatio || 1;
      let W, H;
      let hearts = [];
      const COLORS = ['#ffd1ea','#fff6a6','#ffd89e','#d6f5c6','#d6e0ff','#ffe3b8'];

      function resize(){
        W = window.innerWidth * DPR;
        H = window.innerHeight * DPR;
        c.width = W;
        c.height = H;
      }

      function spawn(){
        if (hearts.length > 30) return;
        hearts.push({
          x: Math.random()*W,
          y: H + Math.random()*200,
          size: 12 + Math.random()*18,
          vx: (Math.random()*2-1)*0.5,
          vy: - (1 + Math.random()*2),
          alpha: 0.6 + Math.random()*0.4,
          rot: Math.random()*2*Math.PI,
          color: COLORS[Math.floor(Math.random()*COLORS.length)]
        });
      }

      function draw(h){
        ctx.save();
        ctx.translate(h.x, h.y);
        ctx.rotate(h.rot);
        ctx.scale(h.size/50, h.size/50);
        ctx.globalAlpha = h.alpha;

        ctx.beginPath();
        ctx.moveTo(0, -0.5);
        ctx.bezierCurveTo(0.45,-1.05,1.15,-0.05,0,0.8);
        ctx.bezierCurveTo(-1.15,-0.05,-0.45,-1.05,0,-0.5);
        ctx.fillStyle = h.color;
        ctx.fill();
        ctx.restore();
      }

      function tick(){
        ctx.clearRect(0,0,W,H);
        if (Math.random() < 0.1) spawn();
        hearts.forEach(h=>{
          h.x += h.vx;
          h.y += h.vy;
          h.alpha -= 0.003;
          draw(h);
        });
        hearts = hearts.filter(h=> h.alpha > 0 && h.y > -100);
        requestAnimationFrame(tick);
      }

      window.addEventListener('resize',resize);
      resize(); tick();
    }
    document.addEventListener('DOMContentLoaded', initHearts);
  })();
  </script>

  <!-- Gallery Logic -->
  <script>
  (function(){
    const PAGE_SIZE = 24;
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');

    const url = new URL(location.href);
    const token = url.searchParams.get("pageToken") || null;
    let trail = JSON.parse(sessionStorage.getItem("trail") || "[]");

    if(token && !trail.includes(token)){ trail.push(token); }
    if(!token) trail = [];
    sessionStorage.setItem("trail", JSON.stringify(trail));

    function makeCard(src, captionText){
      const caption = captionText?.trim() || "";

      const card = document.createElement('div');
      card.className="photo-card";

      const a = document.createElement('a');
      a.href = src; a.target="_blank";
      const img = document.createElement('img');
      img.src = src;
      img.alt = caption || "photo";
      a.appendChild(img);

      card.appendChild(a);
      if(caption){
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = caption;
        card.appendChild(meta);
      }
      return card;
    }

    async function loadPage(){
      try{
        const qs = new URLSearchParams({ pageSize:PAGE_SIZE });
        if(token) qs.set("pageToken", token);

        const r = await fetch(`/api/photos?${qs.toString()}`,{credentials:'include'});
        const data = await r.json();

        const items = data.items || [];
        const nextToken = data.nextPageToken || null;

        grid.innerHTML = "";
        items.forEach(f=>{
          const src = `/api/file/${f.id}`;
          grid.appendChild(makeCard(src, f.caption));
        });

        empty.style.display = items.length ? "none" : "block";

        // next & prev button logic
        nextBtn.disabled = !nextToken;
        if(nextToken){
          nextBtn.onclick = ()=>{
            const u = new URL(location.href);
            u.searchParams.set("pageToken", nextToken);
            if(token && !trail.includes(token)) trail.push(token);
            sessionStorage.setItem("trail", JSON.stringify(trail));
            location.href = u.toString();
          };
        }

        prevBtn.disabled = trail.length <= 1;
        prevBtn.onclick = ()=>{
          trail.pop();
          const prevToken = trail[trail.length-1] || null;
          sessionStorage.setItem("trail", JSON.stringify(trail));
          const u = new URL(location.href);
          if(prevToken) u.searchParams.set("pageToken", prevToken);
          else u.searchParams.delete("pageToken");
          location.href = u.toString();
        };
      }
      catch(e){
        empty.style.display="block";
      }
    }

    loadPage();
  })();
  </script>

  <!-- Music Player (unchanged, already working globally) -->
  <link rel="stylesheet" href="/assets/css/music-heart.css">
  <script src="/assets/js/music-heart.js" defer></script>
</body>
</html>
