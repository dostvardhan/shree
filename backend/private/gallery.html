<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery — Vintage Floral Canvas</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --ink:#2b2225;
    --ring:rgba(0,0,0,.10);
    --gap:22px;
    --frame:#fff8f1;
    --shadow:0 30px 90px -55px rgba(0,0,0,.65);
    --fab-bg:#ffffffda;
    --fab-border:#e7c3cf;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial;
    overflow-x:hidden;
    background:#f3e4d3; /* warm parchment base */
  }

  /* ====== BACKGROUND LAYERS (no external image) ====== */
  .bg-canvas{position:fixed; inset:0; z-index:0; pointer-events:none}
  /* parchment gradients + noise + faint scratches */
  .bg-canvas::before{
    content:""; position:absolute; inset:0;
    background:
      radial-gradient(1400px 900px at 10% -10%, #fff6ea 0%, #f7e6d3 45%, #edd6bf 90%),
      radial-gradient(1200px 800px at 90% 110%, #ffe9ef 0%, #f8dcd9 55%, #f1cbd0 100%),
      linear-gradient(180deg,#ffffff00 0%,#ffffff5a 50%,#ffffff00 100%);
    mix-blend-mode:normal;
  }
  /* subtle paper grain via inline SVG noise */
  .bg-canvas::after{
    content:""; position:absolute; inset:0; opacity:.09;
    background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160">\
        <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.95" numOctaves="2" stitchTiles="stitch"/></filter>\
        <rect width="160" height="160" filter="url(%23n)" opacity="0.45" />\
      </svg>');
    background-size:280px 280px;
    pointer-events:none;
  }

  /* watercolor florals — bottom-left & top-right */
  .bg-florals{position:fixed; inset:0; z-index:1; pointer-events:none}
  .floral{position:absolute; filter:blur(1px) saturate(1.05)}
  .floral svg{display:block}
  .floral.bl{left:-40px; bottom:-60px; width:min(48vw,760px); opacity:.95}
  .floral.tr{right:-40px; top:-40px; width:min(46vw,740px); opacity:.92}

  /* ===== TOP TINY NAV ===== */
  .topbar{
    position:sticky; top:0; z-index:5;
    display:flex; justify-content:center; gap:10px; padding:10px;
    background:#fff6edcc; backdrop-filter:blur(10px);
    border-bottom:1px solid #e3c5b5;
  }
  .topbar a{
    text-decoration:none; color:#6d535b; font-weight:700; font-size:14px;
    padding:7px 12px; border-radius:999px;
    background:#ffe0ea; border:1px solid #f2c3d1; box-shadow:0 8px 20px -14px #0005;
  }
  .topbar a.active{background:#fff}

  /* ===== HEARTS (soft rainbow, slow) ===== */
  .hearts{position:fixed; inset:0; z-index:2; pointer-events:none; mix-blend-mode:screen}
  .heart{
    position:absolute; transform:rotate(45deg);
    width:var(--size,14px); height:var(--size,14px); border-radius:3px;
    background:linear-gradient(145deg,hsl(var(--hue,330) 92% 68%/.9),hsl(var(--hue,330) 92% 58%/.9));
    filter:drop-shadow(0 0 6px hsl(var(--hue,330) 92% 60%/.7)) drop-shadow(0 0 14px hsl(var(--hue,330) 92% 55%/.45));
    animation:rise var(--dur,26s) linear infinite; opacity:.48
  }
  .heart::before,.heart::after{content:""; position:absolute; width:100%; height:100%; border-radius:50%; background:inherit; left:-50%; top:0; filter:inherit}
  .heart::after{left:0; top:-50%}
  @keyframes rise{
    0%{transform:translate(var(--x,0),0) rotate(45deg) scale(.95); opacity:.4}
    50%{transform:translate(calc(var(--x,0)*-1),-65vh) rotate(45deg) scale(1); opacity:.62}
    100%{transform:translate(var(--x,0),-130vh) rotate(45deg) scale(1.05); opacity:0}
  }

  /* ===== CONTENT WRAP + GRID ===== */
  .wrap{max-width:1240px; margin:22px auto 120px; padding:0 18px; position:relative; z-index:3}
  .grid{display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}

  /* ===== VINTAGE FRAMES (4:5 poster, no-crop with blurred fill) ===== */
  .card{
    position:relative; border-radius:18px; background:var(--frame);
    border:1px solid var(--ring); box-shadow:var(--shadow); overflow:hidden;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{transform:translateY(-3px); box-shadow:0 38px 110px -60px rgba(0,0,0,.72)}
  /* tiny random tilt for analog vibe */
  .card{ --tilt:0deg; transform:rotate(var(--tilt)) }
  .card:hover{ transform:rotate(0deg) translateY(-3px) }

  .poster{position:relative; width:100%; aspect-ratio:4/5}
  .fill{
    position:absolute; inset:0;
    background-position:center; background-size:cover;
    filter:blur(16px) saturate(1.05) brightness(.98); transform:scale(1.08)
  }
  .photo{
    position:absolute; inset:12px; border-radius:12px; background:#fff;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
    display:flex; align-items:center; justify-content:center; overflow:hidden
  }
  .photo img{max-width:100%; max-height:100%; object-fit:contain; display:block; transform:scale(1); transition:transform .28s ease}
  .card:hover .photo img{transform:scale(1.06)}

  /* ===== PAGER ===== */
  .pager{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:6; display:flex; gap:10px}
  .pbtn{width:44px; height:44px; border-radius:999px; border:1px solid var(--fab-border); background:#fff; box-shadow:0 12px 30px -18px rgba(0,0,0,.45); font-size:18px; font-weight:800; cursor:pointer}
  .pbtn[disabled]{opacity:.45; cursor:not-allowed}

  /* ===== FABs ===== */
  .fab-wrap{position:fixed; right:16px; bottom:16px; z-index:6; display:flex; flex-direction:column; gap:10px}
  .fab{width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:var(--fab-bg); border:1px solid var(--fab-border); box-shadow:0 10px 28px -16px rgba(0,0,0,.45); font-weight:800; cursor:pointer}
  .fab:hover{transform:translateY(-1px)}

  /* ===== Skeleton ===== */
  .skel{height:320px; border-radius:18px; border:1px solid var(--ring);
        background:linear-gradient(90deg,#fdeef3,#fff7f9,#fdeef3); background-size:200% 100%; animation:sk 1.2s infinite}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sr{position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden}
</style>
</head>
<body>

  <!-- BACKGROUND -->
  <div class="bg-canvas" aria-hidden="true"></div>
  <div class="bg-florals" aria-hidden="true">
    <!-- Bottom-left bouquet (watercolor) -->
    <div class="floral bl">
      <svg viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="bloomA"><feGaussianBlur stdDeviation="22"/></filter>
          <linearGradient id="leafA" x1="0" x2="1">
            <stop offset="0" stop-color="#70906a"/><stop offset="1" stop-color="#a8c19c"/>
          </linearGradient>
          <linearGradient id="petalA" x1="0" x2="1">
            <stop offset="0" stop-color="#f8a56e"/><stop offset="1" stop-color="#ff6f7f"/>
          </linearGradient>
        </defs>
        <!-- soft blooms -->
        <g filter="url(#bloomA)" opacity=".55">
          <circle cx="140" cy="520" r="140" fill="#ffb6c4"/>
          <circle cx="300" cy="580" r="150" fill="#ffcaa4"/>
          <circle cx="470" cy="530" r="120" fill="#ffd9b6"/>
        </g>
        <!-- stems -->
        <path d="M120,600 C210,510 300,470 380,420" stroke="url(#leafA)" stroke-width="22" fill="none" stroke-linecap="round" opacity=".35"/>
        <path d="M180,650 C260,570 340,530 430,500" stroke="url(#leafA)" stroke-width="16" fill="none" stroke-linecap="round" opacity=".4"/>
        <!-- petals -->
        <path d="M300,610 c-80,-60 -64,-150 22,-170 c86,-20 152,52 120,120 c-26,58 -78,82 -142,50z" fill="url(#petalA)" opacity=".95"/>
        <path d="M420,595 c-50,-30 -30,-90 22,-110 c60,-22 110,30 96,70 c-16,48 -78,68 -118,40z" fill="#ffa78a" opacity=".85"/>
      </svg>
    </div>

    <!-- Top-right spray -->
    <div class="floral tr">
      <svg viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="bloomB"><feGaussianBlur stdDeviation="18"/></filter>
        </defs>
        <g filter="url(#bloomB)" opacity=".55">
          <circle cx="650" cy="90" r="140" fill="#ffc7d7"/>
          <circle cx="480" cy="70" r="110" fill="#ffd8a6"/>
        </g>
        <path d="M520,120 C640,170 720,220 840,330" stroke="#ea6a86" stroke-width="14" fill="none" stroke-linecap="round" opacity=".55"/>
        <circle cx="760" cy="240" r="8" fill="#e65b76"/>
        <circle cx="790" cy="275" r="6" fill="#d9416a"/>
        <circle cx="710" cy="210" r="7" fill="#ff7a59"/>
      </svg>
    </div>
  </div>

  <!-- HEARTS -->
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <!-- NAV -->
  <nav class="topbar">
    <a href="/life.html">Life</a>
    <a href="/upload.html">Upload</a>
    <a class="active" href="/gallery.html">Gallery</a>
    <a href="/auth/logout">Logout</a>
  </nav>

  <!-- CONTENT -->
  <div class="wrap">
    <section id="grid" class="grid" aria-live="polite">
      <div class="skel"></div><div class="skel"></div><div class="skel"></div>
    </section>
  </div>

  <!-- PAGER -->
  <div class="pager">
    <button id="prevBtn" class="pbtn" title="Prev">‹</button>
    <button id="nextBtn" class="pbtn" title="Next">›</button>
    <span id="pinfo" class="sr"></span>
  </div>

  <!-- FABs -->
  <div class="fab-wrap">
    <button class="fab" id="musicBtn" title="Play/Pause">♪</button>
    <button class="fab" id="heartsBtn" title="Hearts">❤</button>
  </div>

  <!-- MUSIC -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="/music/bg.mp3" type="audio/mpeg">
  </audio>

<script>
  /* soft auth */
  (async function(){
    try{ const r=await fetch('/api/diag',{credentials:'include',cache:'no-store'}); if(!r.ok) location.href='/index.html'; }
    catch{ location.href='/index.html'; }
  })();

  /* rainbow hearts spawn */
  (function(){
    const root=document.getElementById('hearts'), N=26;
    for(let i=0;i<N;i++){
      const h=document.createElement('div'); h.className='heart';
      const hue=Math.floor(Math.random()*360);
      const dur=18+Math.random()*16;
      const size=12+Math.random()*10;
      const x=(Math.random()*40-20)+'px';
      h.style.setProperty('--hue',hue);
      h.style.setProperty('--dur',dur+'s');
      h.style.setProperty('--size',size+'px');
      h.style.setProperty('--x',x);
      h.style.left=(Math.random()*100)+'vw';
      h.style.bottom=(-20-Math.random()*50)+'vh';
      h.style.animationDelay=(Math.random()*10)+'s';
      root.appendChild(h);
    }
  })();

  /* Vintage Poster Grid (18/page, recent-first) */
  (function(){
    const PAGE_SIZE=18;
    const grid=document.getElementById('grid');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const pinfo=document.getElementById('pinfo');

    // lightbox
    const lb=document.createElement('div');
    lb.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:8;';
    lb.innerHTML=`<button id="lbClose" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
      <img id="lbImg" alt="" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);" />`;
    document.body.appendChild(lb);
    const lbImg=lb.querySelector('#lbImg'); lb.querySelector('#lbClose').onclick=()=>{ lb.style.display='none'; lbImg.src='' };
    lb.addEventListener('click',e=>{ if(e.target===lb) lb.querySelector('#lbClose').onclick(); });
    window.addEventListener('keydown',e=>{ if(lb.style.display==='flex' && e.key==='Escape') lb.querySelector('#lbClose').onclick(); });

    let all=[], page=getPage();
    function getPage(){ const u=new URL(location.href); const v=parseInt(u.searchParams.get('page')||'1',10); return (Number.isFinite(v)&&v>0)?v:1 }
    function setPage(p){ const u=new URL(location.href); u.searchParams.set('page',p); history.replaceState(null,'',u.toString()) }
    function clear(){ grid.innerHTML=''; }

    function tilt(i){ const arr=[-1.6,1.2,-0.8,0.8,-1.2,1.4,-0.6,0.6]; return arr[i%arr.length] }

    function card(item, idx){
      const id=encodeURIComponent(item.id);
      const url=`/api/file/${id}?v=${Date.now()}`;
      const fig=document.createElement('figure'); fig.className='card'; fig.style.setProperty('--tilt', tilt(idx)+'deg');

      const poster=document.createElement('div'); poster.className='poster';
      const fill=document.createElement('div'); fill.className='fill'; fill.style.backgroundImage=`url('${url}')`;
      const ph=document.createElement('div'); ph.className='photo';
      const img=document.createElement('img'); img.loading='lazy'; img.alt='Memory'; img.src=url;

      ph.appendChild(img); poster.appendChild(fill); poster.appendChild(ph); fig.appendChild(poster);
      fig.addEventListener('click',()=>{ lbImg.src=url; lb.style.display='flex'; });
      return fig;
    }

    function render(){
      clear();
      const total=all.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
      if(page>pages) page=pages;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,total);
      const frag=document.createDocumentFragment();
      all.slice(start,end).forEach((it,i)=>frag.appendChild(card(it,i)));
      grid.appendChild(frag);
      prevBtn.disabled=(page<=1); nextBtn.disabled=(page>=pages);
      pinfo.textContent=`${page}/${pages}`;
      setPage(page);
    }

    function extractTime(o){
      const keys=['createdAt','uploadedAt','time','timestamp','ts','date'];
      for(const k of keys){ if(o[k]){ const d=new Date(o[k]); if(!isNaN(d)) return d.getTime(); } }
      if(typeof o.id==='string' && /^\d{10,}$/.test(o.id)) return parseInt(o.id,10);
      return 0;
    }

    (async function load(){
      try{
        const r=await fetch('/api/list',{credentials:'include',cache:'no-store'});
        if(!r.ok) throw new Error('list failed');
        const data=await r.json();
        all = Array.isArray(data)?data.slice():[];
        all.sort((a,b)=>extractTime(b)-extractTime(a)); // recent first
        render();
      }catch(e){
        clear();
        const msg=document.createElement('div'); msg.style.padding='24px'; msg.style.background:'#fff'; msg.style.border:'1px solid #f0c8d4'; msg.style.borderRadius:'14px';
        msg.textContent='Could not load gallery.'; grid.appendChild(msg);
        console.error(e);
      }
    })();

    prevBtn.onclick=()=>{ page=Math.max(1,page-1); render(); };
    nextBtn.onclick=()=>{ page=page+1; render(); };
  })();

  /* music + hearts (persist) */
  (function(){
    const audio=document.getElementById('bgMusic');
    const musicBtn=document.getElementById('musicBtn');
    const heartsBtn=document.getElementById('heartsBtn');
    const hearts=document.getElementById('hearts');

    let heartsOn = localStorage.getItem('heartsOn') !== 'false';
    let musicOn  = localStorage.getItem('musicOn') === 'true';

    hearts.style.display = heartsOn ? 'block' : 'none';
    heartsBtn.addEventListener('click', ()=>{
      heartsOn = !heartsOn; hearts.style.display = heartsOn ? 'block' : 'none';
      localStorage.setItem('heartsOn', heartsOn);
    });

    const resume=()=>{ if(musicOn) audio.play().catch(()=>{}); document.removeEventListener('pointerdown',resume); };
    document.addEventListener('pointerdown', resume, {once:true});

    musicBtn.addEventListener('click', ()=>{
      if(audio.paused){ audio.play().then(()=>{ musicOn=true; localStorage.setItem('musicOn','true'); }).catch(()=>{}); }
      else { audio.pause(); musicOn=false; localStorage.setItem('musicOn','false'); }
    });
  })();
</script>
</body>
</html>
