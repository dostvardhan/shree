<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery — Floral Canvas</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --ink:#2a2124;
      --gap:22px;
      --frame:#fff7ee;
      --shadow:0 36px 110px -60px rgba(0,0,0,.7);
      --fab-bg:#ffffffdb;
      --fab-border:#e5c1cd;
      --bg-url: none; /* Background image dynamically loaded */
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      color:var(--ink);
      font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial;
      overflow-x:hidden;
      background: var(--bg-url, #e9d7bf) center/cover no-repeat fixed;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      background:
        radial-gradient(1400px 900px at 50% 115%, rgba(0,0,0,.18), transparent 60%),
        radial-gradient(1400px 900px at 50% -15%, rgba(0,0,0,.16), transparent 55%),
        linear-gradient(#fff0,#fff5 45%,#fff0 55%);
      mix-blend-mode:multiply;
      opacity:.4;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.12;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.95" numOctaves="2" stitchTiles="stitch"/><rect width="160" height="160" filter="url(%23n)" opacity="0.45"/></svg>');
      background-size:280px 280px;
    }
    .topbar{
      position:sticky;
      top:0; z-index:5;
      display:flex; justify-content:center; gap:10px;
      padding:10px;
      background:#fff6edcc;
      backdrop-filter:blur(10px);
      border-bottom:1px solid #e3c5b5;
    }
    .topbar a{
      text-decoration:none;
      color:#6d535b;
      font-weight:700;
      font-size:14px;
      padding:7px 12px;
      border-radius:999px;
      background:#ffe0ea;
      border:1px solid #f2c3d1;
      box-shadow:0 8px 20px -14px #0005;
    }
    .topbar a.active{background:#fff;}
    .hearts{position:fixed; inset:0; z-index:1; pointer-events:none; mix-blend-mode:screen;}
    .heart{
      position:absolute;
      transform:rotate(45deg);
      width:var(--size,14px);
      height:var(--size,14px);
      border-radius:3px;
      background:linear-gradient(145deg,hsl(var(--hue,330) 92% 68%/.9),hsl(var(--hue,330) 92% 58%/.9));
      filter:drop-shadow(0 0 6px hsl(var(--hue,330) 92% 60%/.7))
             drop-shadow(0 0 14px hsl(var(--hue,330) 92% 55%/.45));
      animation:float var(--dur,26s) linear infinite;
      opacity:.48;
    }
    .heart::before,.heart::after{
      content:"";
      position:absolute;
      width:100%; height:100%;
      border-radius:50%;
      background:inherit;
      left:-50%; top:0;
      filter:inherit;
    }
    .heart::after{
      left:0; top:-50%;
    }
    @keyframes float{
      0%{transform:translate(var(--x,0),0) rotate(45deg) scale(.95); opacity:.4;}
      50%{transform:translate(calc(var(--x,0)*-1),-65vh) rotate(45deg) scale(1); opacity:.62;}
      100%{transform:translate(var(--x,0),-130vh) rotate(45deg) scale(1.05); opacity:0;}
    }
    .wrap{
      max-width:1240px;
      margin:22px auto 120px;
      padding:0 18px;
      position:relative;
      z-index:2;
    }
    .grid{
      display:grid;
      gap:var(--gap);
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .card{
      position:relative;
      border-radius:18px;
      background:var(--frame);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow);
      overflow:hidden;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 44px 120px -60px rgba(0,0,0,.75);
    }
    .poster{
      position:relative;
      width:100%;
      aspect-ratio:4/5;
    }
    .fill{
      position:absolute;
      inset:0;
      background-position:center;
      background-size:cover;
      filter:blur(16px) saturate(1.05) brightness(.98);
      transform:scale(1.08);
    }
    .photo{
      position:absolute;
      inset:12px;
      border-radius:12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .photo img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      transition:transform .28s ease;
    }
    .card:hover img{
      transform:scale(1.06);
    }
    .pager{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      z-index:3;
      display:flex;
      gap:10px;
    }
    .pbtn{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid var(--fab-border);
      background:#fff;
      box-shadow:0 12px 30px -18px rgba(0,0,0,.45);
      font-size:18px;
      font-weight:800;
      cursor:pointer;
    }
    .pbtn[disabled]{opacity:.45; cursor:not-allowed;}
    .fab-wrap{
      position:fixed;
      right:16px; bottom:16px;
      z-index:3;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab{
      width:46px; height:46px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--fab-bg);
      border:1px solid var(--fab-border);
      box-shadow:0 10px 28px -16px rgba(0,0,0,.45);
      font-weight:800;
      cursor:pointer;
    }
  </style>
</head>
<body>
<!-- Floating Hearts Layer -->
<div class="hearts" id="hearts" aria-hidden="true"></div>

<!-- ✅ Top Navigation Bar -->
<nav class="topbar">
  <a href="/life.html">Life</a>
  <a href="/upload.html">Upload</a>
  <a class="active" href="/gallery.html">Gallery</a>
  <a href="/auth/logout">Logout</a>
</nav>

<!-- ✅ Image Grid Wrapper -->
<div class="wrap">
  <section id="grid" class="grid" aria-live="polite">
    <!-- These are skeleton loaders (visible before photos load) -->
    <div class="card skel"></div>
    <div class="card skel"></div>
    <div class="card skel"></div>
  </section>
</div>

<!-- ✅ Pagination Buttons -->
<div class="pager">
  <button id="prevBtn" class="pbtn" title="Previous Page">‹</button>
  <button id="nextBtn" class="pbtn" title="Next Page">›</button>
  <span id="pinfo" class="sr"></span> <!-- For screen readers -->
</div>

<!-- ✅ Music & Heart Floating Buttons (Bottom Right) -->
<div class="fab-wrap">
  <button class="fab" id="musicBtn" title="Play / Pause Music">♪</button>
  <button class="fab" id="heartsBtn" title="Toggle Floating Hearts">❤</button>
</div>

<!-- ✅ Background Music (Will Loop) -->
<audio id="bgMusic" preload="auto" loop>
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>
<!-- =========================
     PART 3 — JavaScript
========================= -->
<script>
/* ---------- 0) Use your floral canvas image as background (auto path) ---------- */
(function(){
  const candidates = [
    '/assets/bj/floral-canvas.jpg',
    'assets/bj/floral-canvas.jpg',
    '/backend/private/assets/bj/floral-canvas.jpg',
    '../assets/bj/floral-canvas.jpg'
  ];
  (function tryAt(i=0){
    if(i>=candidates.length) return; // fallback = parchment tint
    const src = candidates[i] + (candidates[i].includes('?')?'&':'?') + 'v=' + Date.now();
    const img = new Image();
    img.onload = () => document.documentElement.style.setProperty('--bg-url', `url("${src}")`);
    img.onerror = () => tryAt(i+1);
    img.src = src;
  })();
})();

/* ---------- 1) (Optional) soft auth ---------- */
(async function(){
  try{
    const r = await fetch('/api/diag', {credentials:'include', cache:'no-store'});
    if(!r.ok) throw 0;
  }catch{ /* location.href='/index.html'; */ }
})();

/* ---------- 2) Floating rainbow hearts (slow & soft) ---------- */
(function(){
  const root = document.getElementById('hearts');
  const N = 26;
  for(let i=0;i<N;i++){
    const h = document.createElement('div');
    h.className = 'heart';
    h.style.setProperty('--hue',  Math.floor(Math.random()*360));
    h.style.setProperty('--dur',  (18+Math.random()*16)+'s');
    h.style.setProperty('--size', (12+Math.random()*10)+'px');
    h.style.setProperty('--x',    (Math.random()*40-20)+'px');
    h.style.left   = (Math.random()*100)+'vw';
    h.style.bottom = (-20-Math.random()*50)+'vh';
    h.style.animationDelay = (Math.random()*10)+'s';
    root.appendChild(h);
  }
})();

/* ---------- 3) Lightbox ---------- */
const lb = (() => {
  const el = document.createElement('div');
  el.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:10;';
  el.innerHTML = `
    <button id="lbClose" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
    <img id="lbImg" alt="" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);" />
  `;
  document.body.appendChild(el);
  const img = el.querySelector('#lbImg');
  el.querySelector('#lbClose').onclick = () => { el.style.display='none'; img.src=''; };
  el.addEventListener('click', e => { if(e.target===el) el.querySelector('#lbClose').onclick(); });
  window.addEventListener('keydown', e => { if(e.key==='Escape' && el.style.display==='flex') el.querySelector('#lbClose').onclick(); });
  return { open:(src)=>{ img.src=src; el.style.display='flex'; } };
})();

/* ---------- 4) Gallery: 18/page, recent-first, robust URL handling ---------- */
(function(){
  const PAGE_SIZE = 18;
  const grid   = document.getElementById('grid');
  const prev   = document.getElementById('prevBtn');
  const next   = document.getElementById('nextBtn');
  const pinfo  = document.getElementById('pinfo');

  const ts = () => Date.now();

  function imageURL(item){
    const id = item?.id ?? item?._id;
    if (id) return `/api/file/${encodeURIComponent(String(id))}?v=${ts()}`;
    const p = item?.path ?? item?.url ?? item?.src;
    if (typeof p === 'string'){
      if(/^https?:\/\//i.test(p) || p.startsWith('/')) return `${p}${p.includes('?')?'&':'?'}v=${ts()}`;
      return `/${p}${p.includes('?')?'&':'?'}v=${ts()}`;
    }
    return null;
  }

  function timeOf(o){
    for (const k of ['createdAt','uploadedAt','time','timestamp','ts','date']){
      if(o && o[k]){ const d=new Date(o[k]); if(!isNaN(d)) return d.getTime(); }
    }
    if (o?.id && /^\d{10,}$/.test(String(o.id))) return parseInt(o.id,10);
    return 0;
  }

  function card(item, i){
    const url = imageURL(item);
    const fig = document.createElement('figure');
    fig.className = 'card';
    const tilts = [-1.6,1.2,-0.8,0.8,-1.2,1.4,-0.6,0.6];
    fig.style.setProperty('--tilt', (tilts[i%tilts.length])+'deg');

    const poster = document.createElement('div'); poster.className='poster';
    const fill   = document.createElement('div'); fill.className='fill';
    const photo  = document.createElement('div'); photo.className='photo';
    const img    = document.createElement('img'); img.loading='lazy'; img.alt='';

    if(url){ img.src = url; fill.style.backgroundImage = `url('${url}')`; }
    else { fill.style.background='linear-gradient(135deg,#ffe5ec,#fff)'; photo.innerHTML='<span style="color:#c66;font-weight:700">⚠︎</span>'; }

    img.onerror = () => { photo.style.opacity='.85'; photo.style.background='#fff4f6'; photo.title='Image failed to load'; };

    photo.appendChild(img); poster.appendChild(fill); poster.appendChild(photo); fig.appendChild(poster);
    fig.addEventListener('click', ()=>{ if(img.src) lb.open(img.src); });
    return fig;
  }

  function render(all, page){
    grid.innerHTML = '';
    const total = all.length;
    const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
    if (page>pages) page = pages;
    const start = (page-1)*PAGE_SIZE;
    const end   = Math.min(start+PAGE_SIZE, total);

    const frag  = document.createDocumentFragment();
    all.slice(start,end).forEach((it,i)=> frag.appendChild(card(it,i)));
    grid.appendChild(frag);

    prev.disabled = (page<=1);
    next.disabled = (page>=pages);
    pinfo.textContent = `${page}/${pages}`;

    const u = new URL(location.href);
    u.searchParams.set('page', page);
    history.replaceState(null,'',u.toString());
  }

  let items = [];
  let page = parseInt(new URL(location.href).searchParams.get('page')||'1',10);
  if(!(page>0)) page=1;

  (async function load(){
    try{
      const r = await fetch('/api/list', {credentials:'include', cache:'no-store'});
      if(!r.ok) throw new Error('list failed');
      const data = await r.json();
      const arr  = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
      items = arr.filter(Boolean);
      items.sort((a,b)=> timeOf(b)-timeOf(a));   // recent-first
      render(items,page);
    }catch(e){
      console.error('Gallery load error:', e);
      grid.innerHTML = '<div style="padding:24px;background:#fff;border:1px solid #f0c8d4;border-radius:14px">Could not load gallery.</div>';
    }
  })();

  prev.onclick = ()=>{ page=Math.max(1,page-1); render(items,page); };
  next.onclick = ()=>{ page=page+1;             render(items,page); };
})();

/* ---------- 5) Music + Hearts (persist state) ---------- */
(function(){
  const audio     = document.getElementById('bgMusic');
  const musicBtn  = document.getElementById('musicBtn');
  const heartsBtn = document.getElementById('heartsBtn');
  const hearts    = document.getElementById('hearts');

  let heartsOn = localStorage.getItem('heartsOn') !== 'false'; // default true
  let musicOn  = localStorage.getItem('musicOn') === 'true';

  hearts.style.display = heartsOn ? 'block' : 'none';
  heartsBtn.addEventListener('click', ()=>{
    heartsOn = !heartsOn;
    hearts.style.display = heartsOn ? 'block' : 'none';
    localStorage.setItem('heartsOn', heartsOn);
  });

  const resume = () => { if(musicOn) audio.play().catch(()=>{}); document.removeEventListener('pointerdown', resume); };
  document.addEventListener('pointerdown', resume, {once:true});

  musicBtn.addEventListener('click', ()=>{
    if (audio.paused){
      audio.play().then(()=>{ musicOn=true; localStorage.setItem('musicOn','true'); }).catch(()=>{});
    } else {
      audio.pause(); musicOn=false; localStorage.setItem('musicOn','false');
    }
  });
})();
</script>

</body>
</html>
