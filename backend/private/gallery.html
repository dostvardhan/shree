<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shreshtha – Gallery</title>

<!-- Auth & guards -->
<script src="/auth0-spa-js.production.js"></script>
<script src="auth-init.js" defer></script>
<script src="guard-auth.js" defer></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Italianno&display=swap" rel="stylesheet">
<style>
  :root{
    --cream:#FFE7DA; --peach:#FFB59E; --red:#FF6B6B;
    --text:#6e2430; --panel:rgba(255,255,255,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Playfair Display",serif;
    color:var(--text);
    background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));
    overflow-x:hidden;
  }

  /* Header / nav (keep above hearts) */
  header { text-align:center; padding:24px 12px; position:relative; z-index:100; }
  .logo{ font-family:"Italianno",cursive; font-size:46px; text-shadow:0 2px 10px rgba(0,0,0,.25); }
  nav{ margin-top:8px; }
  nav a{
    margin:0 12px; padding:8px 18px; background:rgba(255,255,255,.15);
    border-radius:999px; text-decoration:none; color:var(--text);
    box-shadow:0 4px 8px rgba(0,0,0,.12);
  }
  nav a:hover{ background:rgba(255,255,255,.28); }

  /* Main content (below header but under hearts) */
  main { max-width:1200px; margin:30px auto; padding:0 18px; position:relative; z-index:5; }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:22px; }

  .photo-card{
    background:var(--panel);
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 12px 30px rgba(0,0,0,.14);
    transition:transform .28s cubic-bezier(.2,.9,.3,1);
    display:flex; flex-direction:column;
  }
  .photo-card:hover{ transform:translateY(-6px); }
  .photo-card a{ display:block; flex:1; }
  .photo-card img{
    width:100%;
    border-radius:12px;
    object-fit:contain;
    display:block;
    max-height:360px;
    background:#fff9f7;
  }
  .meta{ padding:10px 12px 14px; text-align:center; font-style:italic; font-size:14px; color:#48242a; }
  .empty{ text-align:center; font-size:18px; margin-top:80px; opacity:.95; color:#4b2b2b }

  /* Pager */
  #pager{ display:flex; justify-content:center; gap:12px; align-items:center; margin:18px 0; z-index:6; position:relative; }
  #pager button{ padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; background:rgba(255,255,255,0.12); }
  #pager button:disabled{ opacity:0.45; cursor:default; }

  /* Hearts canvas sits above photos but under header */
  #fxCanvas {
    position:fixed;
    left:0;
    top:0;
    width:100vw;
    height:100vh;
    pointer-events:none;
    z-index:60; /* above main/photos, below header (header=100) */
  }

  /* DOM hearts fallback (above photos) */
  .heart {
    position:fixed;
    font-size:18px;
    opacity:.9;
    pointer-events:none;
    z-index:58;
    will-change: transform, opacity;
    animation:floatUp linear infinite;
  }
  @keyframes floatUp {
    0%{ transform: translateY(0) scale(1); opacity: .95; }
    100%{ transform: translateY(-120vh) scale(1.3); opacity: 0; }
  }

  /* lightbox styles */
  #lightbox { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200; }
  #lbBack { position:absolute; inset:0; background:rgba(6,8,10,0.72); backdrop-filter: blur(6px); }
  #lbContent { position:relative; max-width:95vw; max-height:92vh; z-index:201; display:flex; flex-direction:column; align-items:center; }
  #lbContent img { max-width:100%; max-height:86vh; border-radius:12px; box-shadow:0 24px 60px rgba(0,0,0,.6); }
  #lbClose { position:absolute; right:-6px; top:-18px; background:rgba(255,255,255,0.9); border-radius:999px; border:none; padding:6px 8px; cursor:pointer; font-size:16px; z-index:202; }
  #lbCaption { margin-top:12px; color:#f6efe8; font-size:16px; text-align:center; max-width:90vw; }

  /* music toggle button */
  #musicToggle {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 220;
    background: rgba(255,255,255,0.95);
    padding: 8px 10px;
    border-radius: 999px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    font-size: 14px;
    display: none;
    cursor: pointer;
  }

  @media (max-width:600px){
    .logo{ font-size:34px; }
    #lbCaption { font-size:14px; }
    #lbClose{ right:6px; top:6px; }
  }
</style>
</head>
<body>
<header>
  <div class="logo">Gallery of Sweet Memories</div>
  <nav>
    <a href="life.html">Back to Life</a>
    <a href="upload.html">Upload</a>
    <a href="/auth/logout">Logout</a>
  </nav>
</header>

<main>
  <section id="grid" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none;">No photos uploaded yet ??</div>

  <div id="pager">
    <button id="prevBtn" disabled>? Prev</button>
    <div id="pageInfo" style="font-weight:600;"></div>
    <button id="nextBtn">Next ?</button>
  </div>
</main>

<!-- Lightbox -->
<div id="lightbox" aria-hidden="true">
  <div id="lbBack"></div>
  <div id="lbContent" role="dialog" aria-modal="true">
    <button id="lbClose" aria-label="Close">?</button>
    <img id="lbImage" alt="">
    <div id="lbCaption" class="meta"></div>
  </div>
</div>

<!-- Background music source: protected endpoint (requires auth) -->
<audio id="bgMusic" loop preload="auto" src="/api/music"></audio>
<button id="musicToggle" aria-label="Play background music">?? Music</button>

<script>
/* Reveal content only after auth check completes (if requireAuth exists) */
document.addEventListener("DOMContentLoaded", () => {
  const reveal = () => { const gate = document.getElementById("auth-gate"); if (gate) gate.remove(); };
  try {
    if (typeof requireAuth === "function") {
      Promise.resolve(requireAuth()).then(reveal).catch(e => { console.warn("Auth check failed, continuing:", e); reveal(); });
    } else { reveal(); }
  } catch(e){ console.error("Auth error:", e); reveal(); }
});
</script>

<script>
/* GALLERY: pagination + render (uses /api/photos + /api/file/:id streaming for full-quality images) */
(function(){
  const PAGE_SIZE = (() => {
    const w = window.innerWidth || 0;
    if (w >= 1400) return 40;
    if (w >= 1000) return 30;
    if (w >= 700)  return 24;
    return 20;
  })();

  const TRAIL_KEY = "gallery_token_trail_v1";
  const readTrail = () => { try{ return JSON.parse(sessionStorage.getItem(TRAIL_KEY)||"[]"); }catch(e){return [];} }
  const writeTrail = (arr) => { try{ sessionStorage.setItem(TRAIL_KEY, JSON.stringify(arr)); }catch(e){} }

  const url = new URL(location.href);
  const token = url.searchParams.get("pageToken") || null;
  const pageSize = Math.max(1, Number(url.searchParams.get("pageSize")||PAGE_SIZE));

  const grid = document.querySelector("#grid");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pageInfo = document.getElementById("pageInfo");
  const emptyEl = document.getElementById("empty");

  let trail = readTrail();
  if (token && (trail.length===0 || trail[trail.length-1] !== token)) trail.push(token);
  if (!token) trail = [];
  writeTrail(trail);

  function setStatus(t){ if(pageInfo) pageInfo.textContent = t; }

  async function loadPage(){
    setStatus("Loading…");
    if (prevBtn) prevBtn.disabled = (trail.length <= 1);
    if (nextBtn) nextBtn.disabled = true;

    try {
      const qs = new URLSearchParams({ pageSize: String(pageSize) });
      if (token) qs.set("pageToken", token);

      const resp = await fetch(`/api/photos?${qs.toString()}`, { credentials: "include" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const items = data.items || [];
      const nextToken = data.nextPageToken || null;

      grid.innerHTML = "";
      if (!items.length) { if (emptyEl) emptyEl.style.display = "block"; }
      else { if (emptyEl) emptyEl.style.display = "none"; }

      items.forEach((f) => {
        // compute secure backend URL once
        const fileUrl = `/api/file/${encodeURIComponent(f.id)}`;

        const anchor = document.createElement("a");
        anchor.href = fileUrl;            // use backend stream, not Drive webview
        anchor.target = "_blank";
        anchor.rel = "noopener";
        anchor.setAttribute('aria-label', f.caption ? `Open photo: ${f.caption}` : `Open photo: ${f.name || 'photo'}`);

        const img = document.createElement("img");
        // use backend streaming endpoint for full-quality image bytes
        img.src = fileUrl;
        img.srcset = `${fileUrl}?w=1024 1024w, ${fileUrl}?w=640 640w`;
        img.sizes = "(max-width:700px) 100vw, 33vw";
        img.alt = f.name || 'photo';
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";

        anchor.appendChild(img);

        const card = document.createElement("div");
        card.className = "photo-card";
        card.appendChild(anchor);

        if (f.caption) {
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = f.caption;
          card.appendChild(meta);
        }
        grid.appendChild(card);
      });

      // pager handlers
      nextBtn.disabled = !nextToken;
      if (nextBtn) nextBtn.onclick = () => {
        const u = new URL(location.href);
        u.searchParams.set("pageSize", String(pageSize));
        if (nextToken) u.searchParams.set("pageToken", nextToken);
        let t = readTrail();
        if (token && (t.length===0 || t[t.length-1] !== token)) t.push(token);
        writeTrail(t);
        location.href = u.toString();
      };

      if (prevBtn) prevBtn.onclick = () => {
        let t = readTrail();
        if (t.length > 0) t.pop();
        const prevToken = (t.length > 0) ? t[t.length-1] : null;
        writeTrail(t);
        const u = new URL(location.href);
        u.searchParams.set("pageSize", String(pageSize));
        if (prevToken) u.searchParams.set("pageToken", prevToken); else u.searchParams.delete("pageToken");
        location.href = u.toString();
      };

      const pageNum = (trail.length>0) ? (trail.length + 1) : 1;
      setStatus(`Page ${pageNum} • ${pageSize} per page`);

    } catch (e) {
      console.error("Gallery load failed:", e);
      setStatus("Failed to load photos.");
      if (emptyEl) emptyEl.style.display = "block";
    }
  }

  loadPage();
})();
</script>

<!-- START: canvas hearts (vivid rainbow, above photos) -->
<div id="fxRoot" aria-hidden="true"><canvas id="fxCanvas"></canvas></div>
<script>
(()=> {
  const c = document.getElementById("fxCanvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  let W,H;
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  let hs = [];

  // vivid rainbow palette (brighter)
  const COLORS = [
    "#4fc3f7", // sky blue
    "#fff176", // bright yellow
    "#ff8a65", // coral / orange
    "#ff4081", // magenta
    "#81c784", // mint green
    "#9575cd", // purple
    "#ffd54f", // warm yellow
    "#29b6f6"  // blue
  ];

  function R(a,b){ return Math.random()*(b-a)+a; }
  function resize(){ W = innerWidth * DPR; H = innerHeight * DPR; c.width = W; c.height = H; }
  function spawn(){
    if (hs.length > 28) return; // allow a few more for a denser effect
    hs.push({
      x: R(0, W),
      y: H + R(10*DPR, 180*DPR),
      s: R(14, 40),
      vx: R(-6, 6),
      vy: -R(12, 34),    // somewhat slower upward speed
      a: R(.55, .98),
      r: R(-.6, .6),
      vr: R(-.015, .015),
      color: COLORS[Math.floor(Math.random()*COLORS.length)]
    });
  }

  function heart(px,py,s,rot,a,color){
    ctx.save(); ctx.translate(px,py); ctx.rotate(rot); ctx.scale(s,s);
    ctx.globalAlpha = a;
    // radial gradient to give softer look
    const g = ctx.createRadialGradient(0, -0.2, 0.1, 0, 0.1, 1.0);
    g.addColorStop(0, color);
    g.addColorStop(1, "rgba(255,255,255,0.05)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.moveTo(0,-0.5);
    ctx.bezierCurveTo(0.5,-1.1,1.3,-0.1,0,0.8);
    ctx.bezierCurveTo(-1.3,-0.1,-0.5,-1.1,0,-0.5);
    ctx.fill();
    ctx.restore();
  }

  function tick(){
    ctx.clearRect(0,0,W,H);
    if (Math.random() < 0.11) spawn();
    hs.forEach(h => {
      h.x += h.vx * 0.016;
      h.y += h.vy * 0.016;
      h.r += h.vr;
      h.a -= 0.00085;
    });
    hs = hs.filter(h => (h.y > -100*DPR) && (h.a > 0.02));
    hs.forEach(h => heart(h.x, h.y, h.s/50*DPR, h.r, h.a, h.color));
    requestAnimationFrame(tick);
  }

  addEventListener("resize", resize, { passive:true });
  resize(); tick();
})();
</script>
<!-- END: canvas hearts -->

<!-- DOM hearts fallback (vivid rainbow) -->
<script>
(function(){
  if (window.__heartsInjected) return; window.__heartsInjected = true;
  const COLORS = ["#4fc3f7","#fff176","#ff8a65","#ff4081","#81c784","#9575cd","#ffd54f","#29b6f6"];
  function spawnHeart(){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = '?';
    h.style.left = (Math.random()*100) + 'vw';
    h.style.top = (78 + Math.random()*20) + 'vh';
    h.style.animationDuration = (9 + Math.random()*6) + 's';
    h.style.color = COLORS[Math.floor(Math.random()*COLORS.length)];
    h.style.fontSize = (18 + Math.random()*28) + 'px';
    h.style.opacity = 0.96;
    h.style.pointerEvents = 'none';
    h.style.zIndex = 58;
    document.body.appendChild(h);
    setTimeout(()=> h.remove(), 22000);
  }
  for (let i=0;i<10;i++) spawnHeart();
  setInterval(spawnHeart, 1200);
})();
</script>

<!-- Lightbox script (delegated open) -->
<script>
(function(){
  const lightbox = document.getElementById('lightbox');
  const lbImage = document.getElementById('lbImage');
  const lbCaption = document.getElementById('lbCaption');
  const lbClose = document.getElementById('lbClose');

  function openLightbox(src, caption){
    lbImage.src = src;
    lbImage.alt = caption || '';
    lbCaption.textContent = caption || '';
    lightbox.style.display = 'flex';
    lightbox.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox(){
    lightbox.style.display = 'none';
    lightbox.setAttribute('aria-hidden','true');
    lbImage.src = '';
    document.body.style.overflow = '';
  }

  document.addEventListener('click', (e) => {
    const a = e.target.closest('.photo-card a');
    if (!a) return;
    const href = a.getAttribute('href');
    if (!href || !href.includes('/api/file/')) return;
    e.preventDefault();
    const captionEl = a.closest('.photo-card').querySelector('.meta');
    const caption = captionEl ? captionEl.textContent : '';
    openLightbox(href, caption);
  });

  lbClose.addEventListener('click', closeLightbox);
  document.getElementById('lbBack').addEventListener('click', closeLightbox);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
})();
</script>

<!-- Background music toggle logic -->
<script>
(function(){
  const audio = document.getElementById('bgMusic');
  const btn = document.getElementById('musicToggle');

  function tryPlay() {
    audio.play().then(()=> {
      btn.style.display = 'none';
    }).catch(() => {
      // Autoplay blocked — show toggle
      btn.style.display = 'block';
    });
  }

  btn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play().catch(()=>{});
      btn.textContent = '? Music';
    } else {
      audio.pause();
      btn.textContent = '?? Music';
    }
  });

  audio.addEventListener('play', ()=> btn.textContent = '? Music');
  audio.addEventListener('pause', ()=> btn.textContent = '?? Music');

  window.addEventListener('load', () => setTimeout(tryPlay, 500));
})();
</script>

<script src="/music-player.js" defer></script>
</body>
</html>

