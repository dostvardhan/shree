<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gallery — Sweet Memories</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --text: #603a3b;
    --card-bg: rgba(255,255,255,0.92);
    --ring: rgba(0,0,0,0.08);
    --shadow: 0 15px 35px rgba(0,0,0,0.20);
  }

  * { box-sizing: border-box; margin:0; padding:0; }

  body {
    font-family: Inter, sans-serif;
    color: var(--text);
    background: url("assets/img/gallery-bg-hearts.png") center/cover no-repeat fixed !important;
    min-height:100vh;
    overflow-x:hidden;
  }

  main, section, .grid, .wrap {
    background: transparent !important;
    box-shadow:none !important;
    border:none !important;
  }

  /* ✅ Top Navigation */
  .topbar {
    position:sticky; top:10px; z-index:10;
    display:flex; gap:10px; justify-content:center;
  }
  .topbar a {
    text-decoration:none; padding:7px 14px;
    border-radius:999px; font-size:13px; font-weight:600;
    background:#ffdfeb; color:#6d535b;
    border:1px solid #f2c3d1;
    box-shadow:0 8px 20px -12px rgba(0,0,0,0.3);
  }
  .topbar a.active { background:white; }

  /* ✅ Page Title */
  h1 {
    text-align:center;
    margin:22px 0 10px;
    font-family:"Playfair Display", serif;
    font-size:clamp(20px,3vw,32px);
    text-shadow:0 1px 0 rgba(255,255,255,0.7);
  }

  /* ===== DENSE GRID: more thumbnails per row, smaller gaps ===== */
  .grid {
    display:grid;
    gap:12px; /* narrower gap = denser look */
    grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); /* more columns */
    max-width: none;
    width: calc(100% - 60px);
    margin:0 auto;
    padding:8px 30px 40px;
  }

  .card {
    background:var(--card-bg);
    border:1px solid var(--ring);
    border-radius:14px;
    box-shadow:var(--shadow);
    overflow:hidden;
    transition:transform .2s ease, box-shadow .2s ease;
    cursor:pointer;
  }
  .card:hover {
    transform:translateY(-6px);
    box-shadow:0 24px 52px -20px rgba(0,0,0,0.42);
  }

  /* slightly squarer aspect ratio so more rows fit */
  .poster { position:relative; width:100%; aspect-ratio:4/5; }

  /* background blurred fill */
  .fill {
    position:absolute; inset:0;
    background-size:cover; background-position:center;
    filter: blur(12px) brightness(0.9) saturate(0.98);
    transform: scale(1.03); opacity:0.85;
  }

  /* photo container (inner polished frame) */
  .photo {
    position:absolute; inset:8px;
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, rgba(255,255,255,0.94), rgba(250,246,245,0.9));
    border-radius:10px;
    padding:6px;
    overflow:hidden;
    box-shadow: inset 0 3px 10px rgba(255,255,255,0.6);
  }

  /* photos fill the frame (cover), look richer */
  .photo img {
    width:100%; height:100%;
    object-fit:cover;
    border-radius:8px;
    transition: transform .28s ease, filter .22s ease;
    filter: saturate(1.04) contrast(1.02);
    display:block;
  }

  .card:hover .photo img {
    transform: scale(1.035);
    filter: saturate(1.07) contrast(1.04) brightness(1.01);
  }

  /* Hide captions/filenames */
  .cap { display:none !important; }

  /* Pagination */
  .pager {
    display:flex; justify-content:center; gap:10px; padding-bottom:30px;
    margin-top:12px;
  }
  .pbtn {
    width:40px; height:40px;
    border-radius:50%; font-weight:800;
    background:white; border:1px solid var(--ring);
    box-shadow:0 10px 24px -16px rgba(0,0,0,0.45);
    cursor:pointer;
  }
  .pbtn[disabled] { opacity:0.5; cursor:not-allowed; }

  /* Floating FABs */
  .fab-wrap {
    position:fixed; right:14px; bottom:14px;
    display:flex; flex-direction:column; gap:10px;
    z-index:20;
  }
  .fab {
    width:46px; height:46px;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    background:#ffffffdd;
    border:1px solid #f0c4cc;
    box-shadow:0 10px 28px -16px rgba(0,0,0,0.45);
    font-weight:800; cursor:pointer;
  }

  /* Responsive tweaks */
  @media (max-width: 880px) {
    .grid { grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); width: calc(100% - 40px); gap:10px; }
    .poster { aspect-ratio:3/4; }
  }
  @media (max-width: 480px) {
    .grid { grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); width: calc(100% - 24px); gap:8px; padding:8px 12px 30px; }
    .poster { aspect-ratio:3/4; }
  }
</style>

<script>
/* Auth Guard: redirect to index if unauthenticated */
(async function(){
  try {
    const r=await fetch('/api/diag',{credentials:'include'});
    if(!r.ok) throw 0;
  } catch {
    location.href='/index.html';
  }
})();
</script>
</head>
<body>

<!-- Navigation (Gallery removed) -->
<nav class="topbar">
  <a href="/life.html">Life</a>
  <a href="/upload.html">Upload</a>
  <a href="/auth/logout">Logout</a>
</nav>

<h1>Sweet Memories of Shreshtha’s Life</h1>

<!-- Gallery Grid -->
<section id="grid" class="grid">
  <!-- placeholder skeleton (optional) -->
  <div class="card" style="height:180px;opacity:0.25"></div>
  <div class="card" style="height:180px;opacity:0.25"></div>
</section>

<!-- Pagination -->
<div class="pager">
  <button id="prevBtn" class="pbtn">‹</button>
  <button id="nextBtn" class="pbtn">›</button>
</div>

<!-- Floating Controls -->
<div class="fab-wrap">
  <button class="fab" id="musicBtn">♪</button>
  <button class="fab" id="heartsBtn">❤</button>
</div>

<!-- Background Music -->
<audio id="bgMusic" preload="auto" loop>
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>

<script>
/* Lightbox */
const lb=(()=>{const el=document.createElement('div');
  el.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:99;';
  el.innerHTML=`
    <button id="x" style="position:absolute;top:20px;right:20px;padding:8px 12px;color:white;background:#ffffff20;border:1px solid #ffffff40;border-radius:50%;font-size:20px;cursor:pointer;">✕</button>
    <img id="img" style="max-width:90vw;max-height:85vh;border-radius:12px;">
  `;
  document.body.appendChild(el);
  const img=el.querySelector('#img'), close=el.querySelector('#x');
  close.onclick=()=>{el.style.display='none';img.src='';};
  el.addEventListener('click',e=>{if(e.target===el) close.onclick();});
  return {open(src){img.src=src;el.style.display='flex';}};
})();

/* Gallery Load Logic */
(async function(){
  const grid=document.getElementById('grid');
  const prev=document.getElementById('prevBtn');
  const next=document.getElementById('nextBtn');
  const PAGE=36; // increased so more photos show per page

  function getTime(i){
    for(let k of ['createdAt','uploadedAt','time','date','timestamp']){
      if(i?.[k]) return new Date(i[k]).getTime();
    }
    return 0;
  }

  async function createCard(item){
    const fig=document.createElement('div');
    fig.className='card';
    fig.innerHTML=`
      <div class="poster">
        <div class="fill"></div>
        <div class="photo"><img/></div>
      </div>
    `;
    const id=item.id || item._id;
    if(id){
      try{
        const res=await fetch('/api/file/'+id,{credentials:'include'});
        if(!res.ok) throw 0;
        const blob=await res.blob();
        const url=URL.createObjectURL(blob);
        const img = fig.querySelector('img');
        const fill = fig.querySelector('.fill');
        img.src=url;
        fill.style.backgroundImage=`url('${url}')`;
        // release objectURL when not needed: revoke on image load (keeps memory lower)
        img.onload = () => { try{ URL.revokeObjectURL(url); } catch(e){} };
        fig.onclick=()=> lb.open(url);
      }catch(e){
        // silently ignore a single file error
      }
    }
    return fig;
  }

  function render(items,page){
    grid.innerHTML='';
    const total=items.length;
    const pages=Math.ceil(total/PAGE)||1;
    if(page>pages) page=pages;
    items.slice((page-1)*PAGE, page*PAGE).forEach(async it=>{
      grid.appendChild(await createCard(it));
    });
    prev.disabled = page<=1;
    next.disabled = page>=pages;
  }

  try{
    const res=await fetch('/api/list',{credentials:'include'});
    if(!res.ok) throw 0;
    const data=await res.json();
    let items=Array.isArray(data)?data:(data.items||[]);
    items = items.sort((a,b)=>getTime(b)-getTime(a));

    let page=parseInt(new URL(location).searchParams.get('page'))||1;
    render(items,page);

    prev.onclick=()=>{ if(page>1){ page--; render(items,page); } };
    next.onclick=()=>{ page++; render(items,page); };
  }catch{
    grid.innerHTML='<p style="color:#603a3b;text-align:center;padding:20px;">Unable to load images.</p>';
  }
})();

/* Music Toggle */
(function(){
  const audio=document.getElementById('bgMusic');
  const btn=document.getElementById('musicBtn');
  let on=localStorage.getItem('musicOn')==='true';
  const start=()=>{ if(on) audio.play().catch(()=>{}); document.removeEventListener('click',start); };
  document.addEventListener('click',start,{once:true});
  btn.onclick=()=>{ if(audio.paused){ audio.play(); on=true; } else { audio.pause(); on=false; } localStorage.setItem('musicOn',on); };
})();
</script>

</body>
</html>
