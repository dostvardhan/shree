<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sweet Memories — Gallery</title>

<!-- Auth Guard -->
<script src="/assets/js/guard-auth.js" defer></script>

<style>
  :root{
    --bgA:#ffe6ee; --bgB:#ffd7e3; --bgC:#fff1f7;
    --ink:#2d2326; --muted:#6f5860; --ring:rgba(0,0,0,.10);
    --card:#fff; --accent:#ff6b8a; --gold:#d1b88f;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial;
    background:
      radial-gradient(1200px 780px at 15% -10%, var(--bgC) 0%, var(--bgA) 42%, var(--bgB) 100%),
      linear-gradient(180deg, #ffffff00 0%, #ffffff80 48%, #ffffff00 100%);
    overflow-x:hidden;
  }

  /* hearts */
  .hearts{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.45}
  .hearts span{
    position:absolute; width:10px; height:10px; transform:rotate(45deg); border-radius:2px;
    background:#ffc0cbcc; box-shadow:0 0 14px #ff8aa655; animation:float 12s linear infinite;
  }
  .hearts span::before,.hearts span::after{content:""; position:absolute; width:10px; height:10px; background:#ffc0cbcc; border-radius:50%; left:-6px; top:0}
  .hearts span::after{left:0; top:-6px}
  @keyframes float{0%{transform:translateY(0) rotate(45deg) scale(.9);opacity:.28}100%{transform:translateY(-120vh) rotate(45deg) scale(1.05);opacity:0}}

  /* topbar */
  .top{position:sticky; top:0; z-index:5; backdrop-filter:blur(8px); background:#ffe6ecdb; border-bottom:1px solid #f5c8d3}
  .wrap{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; justify-content:space-between}
  .brand{font-weight:800}
  .nav a{display:inline-block; text-decoration:none; color:#7a5e66; font-weight:700; padding:8px 12px; margin-left:8px; border-radius:999px; background:#ffdbe4; border:1px solid #f6c7d2; box-shadow:0 6px 18px -12px #00000055}
  .nav a.active{background:#fff}

  .titlebox{max-width:1200px; margin:18px auto 8px; padding:0 18px; text-align:center; position:relative; z-index:1}
  h1{margin:0; font-size:clamp(26px,3.5vw,36px); text-shadow:0 1px 0 #fff, 0 10px 24px #ffb7c84d}
  .hint{color:#6f5b60; margin:6px 0 0; font-size:14px}

  /* grid: tidy cinematic polaroid frames */
  .grid{
    max-width:1200px; margin:16px auto 84px; padding:0 18px;
    display:grid; gap:18px;
    grid-template-columns: repeat(4, 1fr);
  }
  @media (max-width:1100px){ .grid{grid-template-columns: repeat(3, 1fr)} }
  @media (max-width:780px){ .grid{grid-template-columns: repeat(2, 1fr)} }
  @media (max-width:520px){ .grid{grid-template-columns: 1fr} }

  .frame{
    position:relative; aspect-ratio:3/4; border-radius:22px;
    background:#f6eef1; border:1px solid var(--ring);
    box-shadow:
      0 30px 60px -36px rgba(0,0,0,.55),
      inset 0 0 0 1px rgba(255,255,255,.7);
    overflow:hidden; transition: transform .12s ease, box-shadow .12s ease;
  }
  .frame:hover{ transform: translateY(-2px); box-shadow:0 36px 76px -42px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.8) }

  /* thin metallic bevel */
  .bevel{
    position:absolute; inset:10px; border-radius:18px;
    background: linear-gradient(145deg, #ffffffaa, #c9c9c9aa);
    filter: blur(.2px);
  }
  /* blurred fill */
  .fill{
    position:absolute; inset:10px; border-radius:18px; z-index:0;
    background-position:center; background-size:cover; filter:blur(20px) saturate(1.05) brightness(.98);
    transform:scale(1.08);
  }
  /* inner photo plane */
  .photo{
    position:absolute; inset:16px; border-radius:16px; z-index:2;
    display:flex; align-items:center; justify-content:center;
    background:#ffffffee; backdrop-filter: blur(2px);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
  }
  .photo img{ max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block; border-radius:12px }

  /* caption on hover/tap */
  .cap{
    position:absolute; left:18px; right:18px; bottom:18px; z-index:3;
    background:#ffffffd9; border:1px solid #f0c8d4; color:#3c2f34;
    padding:8px 10px; border-radius:12px; font-size:12px; line-height:1.35;
    display:none; box-shadow:0 12px 24px -16px rgba(0,0,0,.35);
  }
  .frame:hover .cap{ display:block }

  /* pager */
  .pager{ max-width:1200px; margin:0 auto 40px; padding:0 18px; display:flex; align-items:center; justify-content:center; gap:10px }
  .pager button{ padding:10px 14px; border-radius:999px; border:1px solid #f0c8d4; background:#fff; cursor:pointer; font-weight:700; box-shadow:0 10px 24px -18px rgba(0,0,0,.4) }
  .pager button[disabled]{ opacity:.45; cursor:not-allowed }
  .pinfo{ padding:8px 12px; border:1px solid #f0c8d4; background:#ffeef2; border-radius:999px; font-weight:700; color:#6a5258 }

  /* skeletons */
  .skeleton{ aspect-ratio:3/4; border-radius:22px; border:1px solid var(--ring);
    background:linear-gradient(90deg,#ffeef3,#fff7f9,#ffeef3); background-size:200% 100%; animation:sk 1.2s infinite }
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* our single FAB set (inline logic, so no duplicates) */
  .fab-wrap{ position:fixed; right:16px; bottom:16px; z-index:6; display:flex; flex-direction:column; gap:10px }
  .fab{
    width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    background:#ffffffd8; border:1px solid #f0c8d4; box-shadow:0 10px 28px -16px rgba(0,0,0,.45);
    cursor:pointer; user-select:none; font-weight:800;
  }
  .fab:hover{ transform:translateY(-1px) }
</style>
</head>
<body>
  <!-- hearts -->
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <!-- topbar -->
  <header class="top">
    <div class="wrap">
      <div class="brand">Sweet Memories</div>
      <nav class="nav">
        <a href="/life.html">Life</a>
        <a href="/upload.html">Upload</a>
        <a class="active" href="/gallery.html">Gallery</a>
      </nav>
    </div>
  </header>

  <!-- title -->
  <section class="titlebox">
    <h1>All Memories</h1>
    <p class="hint">Polaroid cinematic • No-crop • 16 per page • Music + Hearts</p>
  </section>

  <!-- grid -->
  <main class="grid" id="grid" aria-live="polite">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </main>

  <!-- pager -->
  <div class="pager">
    <button id="prevBtn">‹ Prev</button>
    <span class="pinfo" id="pinfo">Page 1 / 1</span>
    <button id="nextBtn">Next ›</button>
  </div>

  <!-- lightbox -->
  <div id="lightbox" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); align-items:center; justify-content:center; z-index:7;">
    <button id="lbClose" style="position:absolute; top:20px; right:20px; background:#ffffff26; color:#fff; border:1px solid #ffffff33; border-radius:999px; padding:10px 12px; font-weight:700; cursor:pointer;">Close ✕</button>
    <button id="lbPrev"  style="position:absolute; left:16px; top:50%; transform:translateY(-50%); background:#ffffff26; color:#fff; border:1px solid #ffffff33; border-radius:999px; padding:10px 12px; font-weight:700; cursor:pointer;">‹</button>
    <img id="lbImg" alt="Full view" style="max-width:95vw; max-height:88vh; border-radius:12px; box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 30px 80px -40px rgba(0,0,0,.9);" />
    <button id="lbNext"  style="position:absolute; right:16px; top:50%; transform:translateY(-50%); background:#ffffff26; color:#fff; border:1px solid #ffffff33; border-radius:999px; padding:10px 12px; font-weight:700; cursor:pointer;">›</button>
  </div>

  <!-- single FAB set (inline; no duplicates) -->
  <div class="fab-wrap">
    <button class="fab" id="musicFab" title="Play/Pause Music">♪</button>
    <button class="fab" id="heartsFab" title="Toggle Hearts">❤</button>
  </div>
  <audio id="bgMusic" src="/assets/audio/music.mp3" preload="auto" loop></audio>

<script>
  // spawn hearts
  (function(){
    const root=document.getElementById('hearts'); const N=22;
    for(let i=0;i<N;i++){
      const s=document.createElement('span');
      s.style.left=Math.random()*100+'vw';
      s.style.bottom=(-10-Math.random()*40)+'vh';
      s.style.animationDelay=(Math.random()*9)+'s';
      const size=8+Math.random()*10; s.style.width=size+'px'; s.style.height=size+'px';
      s.style.opacity=(0.20+Math.random()*0.28).toFixed(2);
      root.appendChild(s);
    }
  })();

  // auth guard
  document.addEventListener('DOMContentLoaded', () => {
    if (window.authGuard?.protect) window.authGuard.protect({ redirectTo: '/index.html' });
  });

  // gallery (16 per page) + premium frames + RECENT FIRST by time
  (function(){
    const PAGE_SIZE=16;
    const grid=document.getElementById('grid');
    const pinfo=document.getElementById('pinfo');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');

    // lightbox
    const lb=document.getElementById('lightbox'), img=document.getElementById('lbImg');
    const lbPrev=document.getElementById('lbPrev'), lbNext=document.getElementById('lbNext'), lbClose=document.getElementById('lbClose');

    let all=[], page=getPageFromURL(), currentIndexOnPage=-1;

    function getPageFromURL(){ const u=new URL(location.href); const p=parseInt(u.searchParams.get('page')||'1',10); return (Number.isFinite(p)&&p>0)?p:1 }
    function setPageInURL(p){ const u=new URL(location.href); u.searchParams.set('page',p); history.replaceState(null,'',u.toString()) }

    function clearSkeleton(){ grid.innerHTML='' }

    function makeCard(item, index){
      const fig=document.createElement('figure'); fig.className='frame';
      // blur fill
      const fill=document.createElement('div'); fill.className='fill';
      fill.style.backgroundImage = `url("/api/file/${encodeURIComponent(item.id)}")`;
      fig.appendChild(fill);
      // bevel
      const bev=document.createElement('div'); bev.className='bevel'; fig.appendChild(bev);
      // photo plane (no-crop)
      const plane=document.createElement('div'); plane.className='photo';
      const image=document.createElement('img'); image.loading='lazy'; image.alt=(item.caption||'Memory');
      image.src=`/api/file/${encodeURIComponent(item.id)}`;
      plane.appendChild(image); fig.appendChild(plane);
      // caption
      if((item.caption||'').trim()){
        const cap=document.createElement('div'); cap.className='cap'; cap.textContent=item.caption; fig.appendChild(cap);
      }
      fig.addEventListener('click',()=>openLightbox(index));
      return fig;
    }

    function renderPage(){
      clearSkeleton();
      const total=all.length, totalPages=Math.max(1,Math.ceil(total/PAGE_SIZE));
      if(page>totalPages) page=totalPages;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,total);
      const slice=all.slice(start,end);
      const frag=document.createDocumentFragment();
      slice.forEach((it,i)=>frag.appendChild(makeCard(it,i)));
      grid.appendChild(frag);
      pinfo.textContent=`Page ${page} / ${totalPages} — ${slice.length} of ${total} photos`;
      prevBtn.disabled=(page<=1); nextBtn.disabled=(page>=totalPages);
      setPageInURL(page);
    }

    function openLightbox(i){
      currentIndexOnPage=i;
      const gi=(page-1)*PAGE_SIZE+i;
      img.src=`/api/file/${encodeURIComponent(all[gi].id)}`;
      lb.style.display='flex';
    }
    function closeLightbox(){ lb.style.display='none'; img.src='' }
    function step(dir){
      if(currentIndexOnPage<0) return;
      const start=(page-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, all.length);
      const gi=start+currentIndexOnPage+dir;
      if(gi<start || gi>=end) return;
      currentIndexOnPage+=dir;
      img.src=`/api/file/${encodeURIComponent(all[start+currentIndexOnPage].id)}`;
    }
    prevBtn.onclick=()=>{ page=Math.max(1,page-1); renderPage() };
    nextBtn.onclick=()=>{ page=page+1; renderPage() };
    lbClose.onclick=closeLightbox; lbPrev.onclick=()=>step(-1); lbNext.onclick=()=>step(1);
    lb.addEventListener('click',e=>{ if(e.target===lb) closeLightbox() });
    window.addEventListener('keydown',e=>{ if(lb.style.display!=='flex')return; if(e.key==='Escape')closeLightbox(); if(e.key==='ArrowLeft')step(-1); if(e.key==='ArrowRight')step(1) });

    // Sort helper: pick most likely timestamp field, desc
    function extractTime(o){
      const keys=['createdAt','uploadedAt','time','timestamp','ts','date'];
      for(const k of keys){
        if(o[k]){
          const d=new Date(o[k]);
          if(!isNaN(d)) return d.getTime();
        }
      }
      // fallback: if id looks like time-ish or monotonic, try parseInt
      if (typeof o.id==='string' && /^\d{10,}$/.test(o.id)) return parseInt(o.id,10);
      return 0;
    }

    async function fetchList(){
      try{
        const res=await fetch('/api/list',{credentials:'include'});
        if(!res.ok) throw new Error('Failed to load list');
        const data=await res.json();
        all = Array.isArray(data) ? data.slice() : [];
        // RECENT FIRST
        all.sort((a,b)=> extractTime(b) - extractTime(a));
        renderPage();
      }catch(e){
        console.error(e);
        clearSkeleton();
        const msg=document.createElement('div'); msg.textContent='Could not load gallery. Please try again.';
        grid.appendChild(msg);
      }
    }
    fetchList();
  })();

  // single, conflict-free music + hearts controls
  (function(){
    const musicBtn = document.getElementById('musicFab');
    const heartsBtn = document.getElementById('heartsFab');
    const audio = document.getElementById('bgMusic');
    const hearts = document.getElementById('hearts');

    let heartsOn = true;
    heartsBtn.addEventListener('click', ()=>{
      heartsOn = !heartsOn;
      hearts.style.display = heartsOn ? 'block' : 'none';
    });

    // Start music on first user tap of button (autoplay policy safe)
    musicBtn.addEventListener('click', ()=>{
      if (audio.paused) { audio.play().catch(()=>{}); }
      else { audio.pause(); }
    });
  })();
</script>
</body>
</html>
