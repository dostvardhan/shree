<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shreshtha â€“ Gallery</title>

<!-- Auth & guards -->
<script src="/auth0-spa-js.production.js"></script>
<script src="auth-init.js"></script>
<script src="guard-auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Italianno&display=swap" rel="stylesheet">
<style>
  :root{ --cream:#FFE7DA; --peach:#FFB59E; --red:#FF6B6B; --text:#6e2430; --panel:rgba(255,255,255,.05); }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Playfair Display",serif; color:var(--text);
    background:linear-gradient(135deg,var(--cream),var(--peach) 48%,var(--red));
    overflow-x:hidden;
  }
  header{text-align:center;padding:24px 12px;}
  .logo{font-family:"Italianno",cursive;font-size:46px;text-shadow:0 2px 10px rgba(0,0,0,.25);}
  nav{margin-top:8px;}
  nav a{margin:0 12px;padding:8px 18px;background:rgba(255,255,255,.15);
        border-radius:999px;text-decoration:none;color:var(--text);
        box-shadow:0 4px 8px rgba(0,0,0,.18);}
  nav a:hover{background:rgba(255,255,255,.3);}
  main{max-width:1200px;margin:30px auto;padding:0 18px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;}
  .card{background:var(--panel);border-radius:16px;overflow:hidden;
        box-shadow:0 18px 40px rgba(0,0,0,.25);position:relative;
        transition:transform .3s cubic-bezier(.2,.9,.3,1);}
  .card:hover{transform:translateY(-6px);}
  .card img{width:100%;height:240px;object-fit:cover;display:block;}
  .meta{padding:12px 14px 16px;text-align:center;font-style:italic;font-size:15px;}
  .empty{text-align:center;font-size:18px;margin-top:80px;opacity:.8;}
</style>
</head>
<body>
<header>
  <div class="logo">Gallery of Sweet Memories</div>
  <nav>
    <a href="life.html">Back to Life</a>
    <a href="upload.html">Upload</a>
    <a href="/auth/logout">Logout</a>
  </nav>
</header>

<main>
  <section id="grid" class="grid"></section>
  <div id="empty" class="empty" style="display:none;">No photos uploaded yet ðŸŒ¸</div>
</main>

<script>
/* --- Hard guard: require login before loading --- */
async function requireAuth(){
  while (!window.auth0Client) { await new Promise(r=>setTimeout(r,40)); }
  const ok = await auth0Client.isAuthenticated();
  if (!ok) {
    const REDIRECT_URI = location.origin + '/auth/callback';
    await auth0Client.loginWithRedirect({ redirect_uri: REDIRECT_URI });
    return false;
  }
  return true;
}

/* --- Load gallery using session cookie (no bearer header needed) --- */
async function loadGallery(){
  try{
    const res = await fetch("/api/list", { credentials: "include" });
    if(!res.ok) throw new Error("list failed: " + res.status);
    const data = await res.json();

    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");

    if(!Array.isArray(data) || data.length === 0){
      empty.style.display = "block";
      return;
    }

    data.forEach(item=>{
      const card = document.createElement("article");
      card.className = "card";

      // If server stored local url, use it; else stream via API using Drive id
      const srcBase = item.url ? item.url : `/api/file/${encodeURIComponent(item.id)}`;
      const img = document.createElement("img");
      img.src = srcBase + (srcBase.includes("?") ? "&" : "?") + "v=" + Date.now(); // cache-bust
      img.alt = item.caption || "memory";
      img.loading = "lazy";

      // helpful error log if stream fails
      img.onerror = () => {
        console.warn("Image failed:", srcBase);
      };

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = item.caption || "";

      card.appendChild(img);
      card.appendChild(meta);
      grid.appendChild(card);
    });
  }catch(err){
    console.error("Gallery load error:", err);
    const empty = document.getElementById("empty");
    empty.textContent = "Error loading gallery ðŸ’”";
    empty.style.display = "block";
  }
}

document.addEventListener("DOMContentLoaded", async ()=>{
  if (await requireAuth()) loadGallery();
});
</script>
</body>
</html>
