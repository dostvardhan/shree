<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery — Sweet Memories</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    /* wall colors (reference) */
    --wall-1:#f7e7de; /* center */
    --wall-2:#f0c9be; /* mid */
    --wall-3:#e4b1a6; /* edge */
    --vignette:rgba(120,60,50,.28);

    --text:#6e3b3c;
    --card:#ffffffd9;
    --ring:rgba(0,0,0,.07);
    --shadow:0 18px 40px rgba(0,0,0,.12);

    --heart:#e4716f;
    --heart-dots:#ffefef;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: radial-gradient(1400px 900px at 50% 30%, var(--wall-1) 0%, var(--wall-2) 60%, var(--wall-3) 100%);
    position:relative; overflow-x:hidden;
  }
  /* vignette for photo-like depth */
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none;
    background: radial-gradient(1200px 800px at 50% 35%, transparent 0 72%, var(--vignette) 100%);
    mix-blend-mode:multiply;
  }

  /* top nav */
  .topbar{
    position:sticky; top:10px; z-index:6; display:flex; gap:10px;
    justify-content:center; padding:6px 0;
  }
  .topbar a{
    text-decoration:none; padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
    color:#6d535b; background:#ffdfeb; border:1px solid #f2c3d1;
    box-shadow:0 8px 20px -16px rgba(0,0,0,.45);
  }
  .topbar a.active{ background:#fff; }

  /* sprinkled hearts ON WALL (left & right columns) */
  .sprinkles{
    position:fixed; inset:0; pointer-events:none; z-index:1;
  }
  .heart,.dheart{
    position:absolute; transform:rotate(-45deg);
    filter:drop-shadow(0 4px 10px rgba(0,0,0,.12));
  }
  .heart{
    width:clamp(24px,5vw,56px); aspect-ratio:1/1;
    background:
      radial-gradient(120% 120% at 35% 30%, rgba(255,255,255,.55) 0 18%, transparent 19%),
      radial-gradient(140% 140% at 70% 75%, rgba(0,0,0,.20), transparent 40%),
      linear-gradient(180deg, #f38b89, var(--heart));
    border-radius:14% 58% 14% 58% / 14% 58% 14% 58%;
  }
  .heart::before,.heart::after,.dheart::before,.dheart::after{
    content:""; position:absolute; inset:0; border-radius:50%; background:inherit;
  }
  .heart::before{ transform:translate(45%,-30%) rotate(45deg) }
  .heart::after { transform:translate(-30%,45%) rotate(45deg) }

  .dheart{
    width:clamp(20px,4.6vw,50px); aspect-ratio:1/1;
    background:
      radial-gradient(closest-side, var(--heart-dots) 40%, transparent 42%) 0 0/6px 6px,
      linear-gradient(180deg, #e88480, #d95f5b);
    border-radius:14% 58% 14% 58% / 14% 58% 14% 58%;
  }

  /* left column positions */
  .l1{left:1.8%; top:8%} .l2{left:6%; top:24%} .l3{left:3%; top:44%}
  .l4{left:10%; top:64%} .l5{left:5%; top:84%}
  /* right column positions */
  .r1{right:2%; top:10%} .r2{right:8%; top:28%} .r3{right:4%; top:48%}
  .r4{right:11%; top:68%} .r5{right:6%; top:86%}

  /* page content area (no frame) */
  .wrap{
    position:relative; z-index:2;
    max-width:1200px; margin: clamp(18px,3vw,28px) auto 60px;
    padding: 12px 16px;
  }

  .title{
    font-family:"Playfair Display", serif; font-size: clamp(22px,3.2vw,34px);
    text-align:center; margin: 4px 0 12px;
  }

  .grid{
    display:grid; gap:18px;
    grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  }
  .card{
    position:relative; border-radius:18px; background:var(--card);
    border:1px solid var(--ring); box-shadow: var(--shadow); overflow:hidden;
    transition:transform .18s ease;
  }
  .card:hover{ transform:translateY(-2px); }
  .poster{ position:relative; width:100%; aspect-ratio:3/4; }
  .fill{ position:absolute; inset:0; background-position:center; background-size:cover;
         filter: blur(18px) saturate(1.05) brightness(.98); transform:scale(1.06); opacity:.9; }
  .photo{ position:absolute; inset:10px; border-radius:12px; background:#fff;
          display:flex; align-items:center; justify-content:center;
          box-shadow:inset 0 0 0 1px rgba(0,0,0,.06); overflow:hidden; }
  .photo img{ max-width:100%; max-height:100%; object-fit:contain; transition:transform .24s ease; }
  .card:hover .photo img{ transform:scale(1.04); }
  .cap{ padding:8px 10px 12px; font-size:13px; color:#6b3a3c; background:#fff8f5; border-top:1px solid var(--ring); }

  /* pager */
  .pager{ display:flex; justify-content:center; gap:10px; padding:16px 0 6px; }
  .pbtn{ width:40px; height:40px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background:#fff;
         box-shadow:0 10px 24px -16px rgba(0,0,0,.45); font-weight:800; cursor:pointer; }
  .pbtn[disabled]{ opacity:.45; cursor:not-allowed; }

  /* floating animated hearts toggle */
  .float-hearts{ position:fixed; inset:0; pointer-events:none; z-index:3; mix-blend-mode:screen }
  .aheart{ position:absolute; width:14px; height:14px; border-radius:3px; transform:rotate(45deg);
    background:linear-gradient(145deg,hsl(var(--h,330) 92% 68%/.85),hsl(var(--h,330) 92% 58%/.85));
    filter:drop-shadow(0 0 6px hsl(var(--h,330) 92% 60%/.7)) drop-shadow(0 0 14px hsl(var(--h,330) 92% 55%/.45));
    animation:rise var(--dur,24s) linear infinite; opacity:.5 }
  .aheart::before,.aheart::after{content:""; position:absolute; width:100%; height:100%; border-radius:50%; background:inherit; left:-50%; top:0; filter:inherit}
  .aheart::after{ left:0; top:-50% }
  @keyframes rise{
    0%{ transform:translate(var(--x,0),0) rotate(45deg) scale(.95); opacity:.38 }
    50%{ transform:translate(calc(var(--x,0)*-1),-60vh) rotate(45deg) scale(1); opacity:.6 }
    100%{ transform:translate(var(--x,0),-120vh) rotate(45deg) scale(1.05); opacity:0 }
  }

  /* FABs */
  .fab-wrap{ position:fixed; right:14px; bottom:14px; z-index:7; display:flex; flex-direction:column; gap:10px; }
  .fab{ width:46px; height:46px; border-radius:999px; display:flex; align-items:center; justify-content:center;
    background:#ffffffde; border:1px solid #f0c4cc; box-shadow:0 10px 28px -16px rgba(0,0,0,.45); font-weight:800; cursor:pointer; }

  @media (max-width:640px){
    .grid{ grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
  }
</style>

<!-- Guard -->
<script>
  (async function ensureSignedIn(){
    try{ const r = await fetch('/api/diag', { credentials:'include', cache:'no-store' }); if(!r.ok) throw 0; }
    catch{ location.href='/index.html'; }
  })();
</script>
</head>
<body>

<!-- WALL sprinkles (fixed, behind content) -->
<div class="sprinkles" aria-hidden="true">
  <!-- left column hearts -->
  <div class="dheart l1"></div><div class="heart l2"></div><div class="dheart l3"></div>
  <div class="heart l4"></div><div class="dheart l5"></div>
  <!-- right column hearts -->
  <div class="heart r1"></div><div class="dheart r2"></div><div class="heart r3"></div>
  <div class="dheart r4"></div><div class="heart r5"></div>
</div>

<!-- toggleable floating sparkle hearts -->
<div class="float-hearts" id="floatHearts" aria-hidden="true"></div>

<nav class="topbar">
  <a href="/life.html">Life</a>
  <a href="/upload.html">Upload</a>
  <a class="active" href="/gallery.html">Gallery</a>
  <a href="/auth/logout">Logout</a>
</nav>

<main class="wrap">
  <h1 class="title">Sweet Memories of Shreshtha’s Life</h1>
  <section id="grid" class="grid" aria-live="polite">
    <!-- skeletons shown briefly -->
    <div class="card" style="height:260px;opacity:.45"></div>
    <div class="card" style="height:260px;opacity:.45"></div>
    <div class="card" style="height:260px;opacity:.45"></div>
  </section>

  <div class="pager">
    <button id="prevBtn" class="pbtn" title="Previous">‹</button>
    <button id="nextBtn" class="pbtn" title="Next">›</button>
  </div>
</main>

<!-- FABs -->
<div class="fab-wrap">
  <button class="fab" id="musicBtn" title="Play/Pause">♪</button>
  <button class="fab" id="heartsBtn" title="Toggle Hearts">❤</button>
</div>

<audio id="bgMusic" preload="auto" loop>
  <source src="/music/bg.mp3" type="audio/mpeg">
</audio>

<script>
/* floating animated hearts */
(function(){
  const root=document.getElementById('floatHearts'); const N=24;
  for(let i=0;i<N;i++){
    const h=document.createElement('div'); h.className='aheart';
    h.style.setProperty('--h',Math.floor(Math.random()*360));
    h.style.setProperty('--dur',(18+Math.random()*16)+'s');
    h.style.setProperty('--x',(Math.random()*40-20)+'px');
    h.style.left=(Math.random()*100)+'vw';
    h.style.bottom=(-25-Math.random()*60)+'vh';
    h.style.animationDelay=(Math.random()*10)+'s';
    root.appendChild(h);
  }
})();

/* lightbox */
const lb=(()=>{const el=document.createElement('div');
  el.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:10;';
  el.innerHTML=`<button id="x" style="position:absolute;top:20px;right:20px;background:#ffffff26;color:#fff;border:1px solid #ffffff33;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;">✕</button>
  <img id="im" style="max-width:95vw;max-height:88vh;border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 30px 80px -40px rgba(0,0,0,.9);">`;
  document.body.appendChild(el);const im=el.querySelector('#im'),x=el.querySelector('#x');
  x.onclick=()=>{el.style.display='none';im.src=''}; el.addEventListener('click',e=>{if(e.target===el)x.onclick()});
  addEventListener('keydown',e=>{if(e.key==='Escape'&&el.style.display==='flex')x.onclick()});
  return {open:src=>{im.src=src;el.style.display='flex'}}
})();

/* gallery (18/page, recent-first) */
(function(){
  const GRID=document.getElementById('grid'), PREV=document.getElementById('prevBtn'), NEXT=document.getElementById('nextBtn');
  const PAGE=18;

  function getWhen(i){
    for (const k of ['createdAt','uploadedAt','time','timestamp','ts','date']) {
      if (i?.[k]) { const d=new Date(i[k]); if(!isNaN(d)) return d.getTime(); }
    } return 0;
  }
  function captionOf(i){ return i?.caption || i?.title || i?.name || ''; }

  function skeleton(){
    const fig=document.createElement('figure'); fig.className='card';
    const poster=document.createElement('div'); poster.className='poster';
    const fill=document.createElement('div'); fill.className='fill';
    const ph=document.createElement('div'); ph.className='photo';
    const img=document.createElement('img'); img.loading='lazy'; img.alt='';
    ph.appendChild(img); poster.appendChild(fill); poster.appendChild(ph); fig.appendChild(poster);
    const cap=document.createElement('figcaption'); cap.className='cap'; fig.appendChild(cap);
    return {fig,fill,img,cap};
  }

  async function makeCard(item){
    const id=String(item?.id ?? item?._id ?? '');
    const {fig,fill,img,cap}=skeleton();
    cap.textContent = captionOf(item);
    fill.style.background='linear-gradient(135deg,#ffe3ea,#fff)';

    if(id){
      try{
        const r=await fetch(`/api/file/${encodeURIComponent(id)}`,{credentials:'include',cache:'no-store'});
        if(r.status===401){ location.href='/index.html'; return fig; }
        if(!r.ok) throw 0;
        const blob=await r.blob();
        const url=URL.createObjectURL(blob);
        img.src=url; img.onload=()=>setTimeout(()=>URL.revokeObjectURL(url),2500);
        fill.style.backgroundImage=`url('${url}')`;
      }catch{ /* leave placeholder */ }
    }
    fig.onclick=()=>{ if(img.src) lb.open(img.src); };
    return fig;
  }

  function render(items,page){
    GRID.innerHTML='';
    const total=items.length, pages=Math.max(1,Math.ceil(total/PAGE)); if(page>pages) page=pages;
    const s=(page-1)*PAGE, e=Math.min(s+PAGE,total);
    Promise.all(items.slice(s,e).map(makeCard)).then(nodes=>{
      const frag=document.createDocumentFragment(); nodes.forEach(n=>frag.appendChild(n)); GRID.appendChild(frag);
    });
    PREV.disabled=(page<=1); NEXT.disabled=(page>=pages);
    const u=new URL(location.href); u.searchParams.set('page',page); history.replaceState(null,'',u.toString());
  }

  let items=[], page=parseInt(new URL(location.href).searchParams.get('page')||'1',10); if(!(page>0)) page=1;

  (async()=>{
    try{
      const r=await fetch('/api/list',{credentials:'include',cache:'no-store'});
      if(r.status===401){ location.href='/index.html'; return; }
      if(!r.ok) throw 0;
      const data=await r.json();
      const arr=Array.isArray(data)?data:(Array.isArray(data?.items)?data.items:[]);
      items=arr.filter(Boolean).sort((a,b)=>getWhen(b)-getWhen(a));
      if(items.length===0){
        GRID.innerHTML='<div class="card" style="padding:14px;text-align:center">No photos yet. Try Upload page.</div>';
      }else{
        render(items,page);
      }
    }catch{
      GRID.innerHTML='<div class="card" style="padding:14px;text-align:center">Could not load gallery.</div>';
    }
  })();

  PREV.onclick=()=>{ page=Math.max(1,page-1); render(items,page); };
  NEXT.onclick=()=>{ page=page+1; render(items,page); };
})();

/* music + hearts toggle */
(function(){
  const audio=document.getElementById('bgMusic');
  const musicBtn=document.getElementById('musicBtn');
  const heartsBtn=document.getElementById('heartsBtn');
  const floatHearts=document.getElementById('floatHearts');
  let musicOn=localStorage.getItem('musicOn')==='true';
  let heartsOn=localStorage.getItem('heartsOn')!=='false';
  floatHearts.style.display=heartsOn?'block':'none';
  heartsBtn.onclick=()=>{ heartsOn=!heartsOn; floatHearts.style.display=heartsOn?'block':'none'; localStorage.setItem('heartsOn',heartsOn); };
  const resume=()=>{ if(musicOn) audio.play().catch(()=>{}); removeEventListener('pointerdown',resume); };
  addEventListener('pointerdown',resume,{once:true});
  musicBtn.onclick=()=>{ if(audio.paused){ audio.play().then(()=>{musicOn=true;localStorage.setItem('musicOn','true');}).catch(()=>{}); }
                         else { audio.pause(); musicOn=false; localStorage.setItem('musicOn','false'); } };
})();
</script>
</body>
</html>
