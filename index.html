<script>
  function onAuthReady(cb) {
    if (window.__AUTH_READY__) {
      window.__AUTH_READY__.then(cb).catch(err => {
        document.getElementById('status').innerText = 'Auth init failed: ' + (err.message || err);
        console.error('Auth init failed:', err);
      });
    } else {
      // retry after a short delay if __AUTH_READY__ not yet defined
      setTimeout(() => onAuthReady(cb), 100);
    }
  }

  onAuthReady(async () => {
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const status = document.getElementById('status');

    async function refreshUI(){
      const authed = await window.__AUTH__.isAuthenticated();
      if (authed) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        const user = await window.__AUTH__.getUser();
        status.innerText = 'Signed in as ' + (user ? (user.name || user.email || user.sub) : 'user');
      } else {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        status.innerText = 'Not signed in';
      }
    }

    loginBtn.addEventListener('click', async () => {
      await window.__AUTH__.login({ redirect_uri: window.location.origin + '/index.html' });
    });

    logoutBtn.addEventListener('click', () => {
      window.__AUTH__.logout({ returnTo: window.location.origin + '/index.html' });
    });

    await refreshUI();
  });
</script>
