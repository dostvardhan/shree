<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shree • Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    const BACKEND = "https://shree-drive.onrender.com";
    const API_URL = "https://shreshthapushkar.com/.netlify/identity";

    function requireLogin() {
      if (!window.netlifyIdentity) { alert("Identity not loaded"); return; }
      window.netlifyIdentity.init({ APIUrl: API_URL });
      window.netlifyIdentity.on("init", u => { if (!u) window.location.replace("/"); else loadPhoto(); });
    }

    async function token(){ const u=window.netlifyIdentity.currentUser(); if(!u) throw new Error("Not logged in"); return await u.jwt(); }

    async function loadPhoto(){
      const p=new URLSearchParams(location.search);
      const id=p.get("id"), name=p.get("name");
      document.getElementById("title").textContent = name||"Photo";
      try{
        const t=await token();
        const r=await fetch(`${BACKEND}/file/${id}`, { headers:{Authorization:`Bearer ${t}`} });
        if(!r.ok) throw new Error("Fetch failed");
        const blob=await r.blob();
        const url=URL.createObjectURL(blob);
        document.getElementById("img").src=url;
      }catch(e){
        document.getElementById("status").textContent="❌ "+e.message;
      }
    }

    function logout(){ window.netlifyIdentity.logout(); location.replace("/"); }
    document.addEventListener("DOMContentLoaded", requireLogin);
  </script>
  <style>
    body{ font-family:system-ui; margin:0; text-align:center; }
    header{ padding:12px; background:#fff; border-bottom:1px solid #eee; }
    img{ max-width:95%; margin-top:20px; border-radius:10px; }
    #status{ margin:10px; color:#555; }
  </style>
</head>
<body>
  <header>
    <h2 id="title">Photo</h2>
    <a href="/gallery.html">Back to Gallery</a>
    <button onclick="logout()">Logout</button>
  </header>
  <div id="status"></div>
  <img id="img" alt="Photo" />
</body>
</html>
