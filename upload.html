<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upload — Shreshtha</title>
  <style>#app{display:none;} .loading {text-align:center;padding:40px;}</style>
  <script>
    window.__PAGE_GUARD = true;
  </script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>
<body>
  <div id="app">
    <h1>Upload daily photo</h1>
    <form id="uploadForm">
      <label>Photo (jpg/png)</label><br>
      <input type="file" id="photo" name="photo" accept="image/*" required><br><br>
      <label>Caption / Quote</label><br>
      <input type="text" id="caption" name="caption" maxlength="240" required><br><br>
      <button type="submit">Upload</button>
      <div id="status" style="margin-top:12px;"></div>
    </form>
  </div>

  <script>
    const AUTH0_DOMAIN = "dev-zzhjbmtzoxtgoz31.us.auth0.com";
    const AUTH0_CLIENT_ID = "6sfOCkf0BFVHsuzfPJCHoLDffZSNJjzT";
    const AUTH0_AUDIENCE = "https://shree-drive.onrender.com";

    // Auto-switch API base
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:4000'
      : 'https://shree-drive.onrender.com';

    let auth0 = null;

    async function initAuth() {
      auth0 = await createAuth0Client({
        domain: AUTH0_DOMAIN,
        client_id: AUTH0_CLIENT_ID,
        audience: AUTH0_AUDIENCE,
        cacheLocation: 'localstorage',
        useRefreshTokens: true
      });

      if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
        try { await auth0.handleRedirectCallback(); }
        catch (e) { console.error("handleRedirectCallback failed", e); }
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      const isAuthenticated = await auth0.isAuthenticated();
      if (!isAuthenticated) {
        await auth0.loginWithRedirect({ redirect_uri: window.location.origin + '/life.html' });
        return;
      }
      document.getElementById('app').style.display = 'block';
    }

    async function getAccessToken() {
      try {
        const token = await auth0.getTokenSilently({
          audience: AUTH0_AUDIENCE,
          scope: 'openid profile email'
        });
        return token;
      } catch (err) {
        console.error("getTokenSilently error", err);
        await auth0.loginWithRedirect({ redirect_uri: window.location.origin + '/life.html' });
        return null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initAuth();

      const form = document.getElementById('uploadForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const status = document.getElementById('status');
        status.textContent = 'Uploading...';

        const fileInput = document.getElementById('photo');
        if (!fileInput.files || fileInput.files.length === 0) {
          status.textContent = 'Please choose a photo.';
          return;
        }

        const token = await getAccessToken();
        if (!token) {
          status.textContent = 'Unable to get access token.';
          return;
        }

        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        fd.append('caption', document.getElementById('caption').value);

        try {
          const resp = await fetch(API_BASE + '/api/upload', {
            method: 'POST',
            body: fd,
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });

          if (resp.ok) {
            const body = await resp.json();
            status.textContent = 'Uploaded! ' + (body.message || '');
            setTimeout(()=> window.location.href = '/life.html', 700);
          } else if (resp.status === 401) {
            status.textContent = 'Unauthorized — re-login.';
            await auth0.loginWithRedirect({ redirect_uri: window.location.origin + '/life.html' });
          } else {
            const errText = await resp.text();
            status.textContent = 'Upload failed: ' + errText;
          }
        } catch (err) {
          console.error(err);
          status.textContent = 'Network or server error: ' + (err.message || err);
        }
      });
    });
  </script>
</body>
</html>
