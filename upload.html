<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload â€” Shreshtha</title>

  <script src="/auth-init.js"></script>
  <script src="/guard-auth.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#222}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .btn{background:#2e7d32;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    main{max-width:880px;margin:24px auto;padding:18px}
    .drop{border:2px dashed #dcdcdc;border-radius:12px;padding:28px;text-align:center;background:#fff}
    .drop.drag{border-color:#2e7d32;background:#f0fff0}
    input[type="file"]{display:none}
    .row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .progress{height:10px;background:#eee;border-radius:6px;overflow:hidden;width:100%}
    .progress > i{display:block;height:100%;width:0;background:#2e7d32;transition:width .2s}
    .note{color:#666;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <img src="/photo1.jpg" style="width:44px;height:44px;border-radius:8px;object-fit:cover" alt="">
      <div><strong>Upload</strong><div style="font-size:13px;color:#666">Add a memory</div></div>
    </div>
    <nav>
      <button class="btn" id="btnBack">Back</button>
    </nav>
  </header>

  <main>
    <div data-guard>
      <h2>Upload a photo</h2>
      <div id="drop" class="drop">
        <p style="margin:0">Drag & drop an image here or <button id="chooseBtn" style="color:#2e7d32;background:transparent;border:0;cursor:pointer">Choose file</button></p>
        <input id="fileInput" type="file" accept="image/*" />
        <div class="note">Max file size should be reasonable. Uploads are private to invited users.</div>
      </div>

      <div class="row">
        <input id="caption" placeholder="Caption (optional)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd" />
        <button id="uploadBtn" class="btn">Upload</button>
      </div>

      <div style="margin-top:12px">
        <div class="progress" id="progress"><i></i></div>
        <div id="status" class="note"></div>
      </div>
    </div>
  </main>

  <script>
    const drop = document.getElementById("drop");
    const fileInput = document.getElementById("fileInput");
    const chooseBtn = document.getElementById("chooseBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const captionEl = document.getElementById("caption");
    const progBar = document.querySelector("#progress > i");
    const status = document.getElementById("status");
    const btnBack = document.getElementById("btnBack");

    let currentFile = null;

    chooseBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      if (e.target.files && e.target.files[0]) {
        currentFile = e.target.files[0];
        status.textContent = "Selected: " + currentFile.name;
      }
    });

    ;["dragenter","dragover"].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); drop.classList.add("drag"); });
    });
    ;["dragleave","drop"].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); drop.classList.remove("drag"); });
    });
    drop.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) { currentFile = f; status.textContent = "Selected: " + f.name; }
    });

    async function uploadFile() {
      if (!currentFile) return alert("Choose a file first");
      uploadBtn.disabled = true;
      status.textContent = "Preparing upload...";
      progBar.style.width = "0%";

      const token = await window.auth.getToken();
      if (!token) return alert("Not authenticated");

      const fd = new FormData();
      fd.append("file", currentFile);
      fd.append("caption", captionEl.value || "");

      // fetch with progress using XHR
      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${window.location.origin.replace(window.location.hostname, "shree-drive.onrender.com")}/api/upload`); // use Render backend host via origin's host swap if needed
      xhr.setRequestHeader("Authorization", "Bearer " + token);
      xhr.upload.onprogress = (evt) => {
        if (evt.lengthComputable) {
          const pct = Math.round(evt.loaded / evt.total * 100);
          progBar.style.width = pct + "%";
          status.textContent = `Uploading: ${pct}%`;
        }
      };
      xhr.onload = () => {
        uploadBtn.disabled = false;
        if (xhr.status >= 200 && xhr.status < 300) {
          status.textContent = "Upload successful!";
          setTimeout(() => window.location.href = "/life.html", 900);
        } else {
          status.textContent = "Upload failed: " + xhr.responseText;
        }
      };
      xhr.onerror = () => {
        uploadBtn.disabled = false;
        status.textContent = "Upload failed (network)";
      };
      xhr.send(fd);
    }

    uploadBtn.addEventListener("click", uploadFile);
    btnBack.addEventListener("click", () => window.location.href = "/life.html");
  </script>
</body>
</html>
