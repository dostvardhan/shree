<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Daily Memories</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:680px;margin:40px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    h1{margin:0 0 8px}
    .muted{color:#667}
    .row{margin:14px 0}
    input[type="file"], input[type="text"], textarea{width:100%}
    button{padding:10px 16px;border:none;border-radius:8px;background:#0d6efd;color:#fff;cursor:pointer}
    .out{white-space:pre-wrap;background:#f4f6f8;border-radius:8px;padding:10px;margin-top:12px}
    a.btn{display:inline-block;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload a Photo</h1>
    <div class="muted" id="who"></div>

    <div class="row">
      <input id="file" type="file" accept="image/*" />
    </div>
    <div class="row">
      <label>Caption (optional)</label>
      <textarea id="caption" rows="3" placeholder="Say something…"></textarea>
    </div>
    <div class="row">
      <button id="btn">Upload</button>
      <a class="btn" href="/life.html">Back to Life Gallery</a>
    </div>

    <div class="out" id="out"></div>
  </div>

<script>
const CLOUD_NAME   = "YOUR_CLOUDINARY_CLOUD_NAME";   // <-- change
const UPLOAD_PRESET= "YOUR_UNSIGNED_UPLOAD_PRESET";  // <-- change
const FOLDER       = "daily_uploads";

function log(msg){ document.getElementById('out').textContent = msg; }

async function getToken(){
  const u = window.netlifyIdentity?.currentUser();
  if (!u) return null;
  return await u.jwt();
}

function ensureAuth(){
  if (!window.netlifyIdentity) { location.href = "/"; return; }
  netlifyIdentity.on('init', user => {
    if (!user) location.href = "/";
    else document.getElementById('who').textContent = `Logged in as ${user.email}`;
  });
  netlifyIdentity.init();
}

async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET); // UNSIGNED preset
  fd.append("folder", FOLDER);
  // optional: fd.append("context", `caption=${document.getElementById('caption').value}`);

  const res = await fetch(url, { method: "POST", body: fd });
  if (!res.ok) throw new Error(`Cloudinary upload failed (${res.status})`);
  return await res.json(); // has secure_url, public_id, etc.
}

async function savePostToFunction(payload){
  const token = await getToken();
  const res = await fetch("/.netlify/functions/savePost", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      ...(token ? { "Authorization": `Bearer ${token}` } : {})
    },
    body: JSON.stringify(payload)
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt || "savePost failed");
  try { return JSON.parse(txt); } catch { return { ok:true, raw:txt }; }
}

document.getElementById('btn').addEventListener('click', async () => {
  try{
    const file = document.getElementById('file').files[0];
    const caption = document.getElementById('caption').value || "";
    if (!file){ log("Please choose an image."); return; }

    log("Uploading to Cloudinary…");
    const up = await uploadToCloudinary(file);

    log("Saving to Firestore…");
    const saved = await savePostToFunction({
      url: up.secure_url,
      public_id: up.public_id,
      caption
    });

    log("✅ Done!\n" + JSON.stringify(saved, null, 2));
  }catch(err){
    log("❌ Error: " + err.message);
  }
});

ensureAuth();
</script>
</body>
</html>
