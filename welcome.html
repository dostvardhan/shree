<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Welcome • Shreshtha</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#394b3f;color:#222;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0}
    .card{background:#fff;width:620px;margin:60px;padding:28px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.25);text-align:center}
    a{display:block;margin:8px 0;color:#20603f}
    .info{font-size:13px;color:#666;margin-top:12px}
    .danger{color:#a33}
    button.logout{margin-top:10px;padding:8px 12px;border-radius:6px;border:none;background:#f76ca2;color:#fff;cursor:pointer}
  </style>

  <!-- SDK via CDN (defer) - loader script will also try local if needed -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js" defer></script>
</head>
<body>
  <div class="card">
    <h2>Welcome ✨</h2>
    <p id="info" class="info">Finishing sign-in…</p>

    <div id="links" style="display:none">
      <a href="/life.html">Sweet memories of Shreshtha</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/upload.html">Upload</a>
      <div class="info" id="user-info"></div>
      <button id="logout" class="logout">Logout</button>
    </div>

    <div id="denied" style="display:none">
      <p class="danger">Access denied. Your account is not allowed to view this site.</p>
    </div>
  </div>

  <script>
  // config
  const AUTH0_DOMAIN = "dev-zzhjbmtzoxtgoz31.us.auth0.com";
  const AUTH0_CLIENT_ID = "6sfOCkf0BFVHsuzfPJCHoLDffZSNJjzT";
  const AUTH0_AUDIENCE = "https://shree-drive.onrender.com";

  // small helper: recreate createAuth0Client usage and wrapper after SDK present
  async function initAuth() {
    if (typeof createAuth0Client !== 'function') {
      console.error('Auth0 SDK missing on welcome.html');
      return null;
    }
    const auth0 = await createAuth0Client({ domain: AUTH0_DOMAIN, client_id: AUTH0_CLIENT_ID, audience: AUTH0_AUDIENCE, cacheLocation: 'memory' });
    return {
      _auth0: auth0,
      handleCallback: async () => {
        try { return await auth0.handleRedirectCallback(); } catch(e){ console.warn(e); return null; }
      },
      isAuthenticated: () => auth0.isAuthenticated(),
      getUser: () => auth0.getUser(),
      logout: (opts={}) => auth0.logout({ returnTo: window.location.origin + (opts.returnTo||'/') })
    };
  }

  (async function(){
    const infoEl = document.getElementById('info');
    // wait until SDK is available (defer + small wait)
    let wait = 0;
    while (typeof createAuth0Client !== 'function' && wait < 4000) {
      await new Promise(r=>setTimeout(r, 150));
      wait += 150;
    }
    if (typeof createAuth0Client !== 'function') {
      infoEl.textContent = 'Auth SDK not available. Try refresh.';
      return;
    }

    const auth = await initAuth();
    if(!auth){ infoEl.textContent = 'Auth init failed.'; return; }

    try { await auth.handleCallback(); } catch(e){ console.warn('callback handling', e); }

    if (!await auth.isAuthenticated()) {
      infoEl.textContent = 'Not signed in — redirecting to login...';
      setTimeout(()=> window.location.href = '/', 800);
      return;
    }

    // show links
    document.getElementById('links').style.display = 'block';
    infoEl.style.display = 'none';

    const user = await auth.getUser();
    if(user){ document.getElementById('user-info').textContent = 'Signed in as ' + (user.name||user.email||user.sub); }

    document.getElementById('logout').onclick = ()=> auth.logout();
  })();
  </script>
</body>
</html>
