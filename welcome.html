<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Welcome • Shreshtha</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#3a3240;color:#222;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0}
    .card{background:#fff;width:560px;margin:60px;padding:28px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.25);text-align:center}
    a{display:block;margin:8px 0;color:#6a27a8}
    .info{font-size:13px;color:#666;margin-top:12px}
    .denied{color:#a33}
    button.logout{margin-top:10px;padding:8px 12px;border-radius:6px;border:none;background:#f76ca2;color:#fff;cursor:pointer}
  </style>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js" defer></script>
</head>
<body>
  <div class="card" id="card">
    <h2>Welcome ✨</h2>
    <p class="info" id="info">Finishing sign-in…</p>

    <div id="links" style="display:none">
      <a id="life" href="/life.html">Sweet memories of Shreshtha</a>
      <a id="gallery" href="/gallery.html">Gallery</a>
      <a id="upload" href="/upload.html">Upload</a>
      <div class="info" style="margin-top:8px">You are signed in.</div>
      <button id="logout" class="logout">Logout</button>
    </div>

    <div id="denied" style="display:none">
      <p class="denied">Access denied. Your account is not allowed to view this site.</p>
    </div>
  </div>

  <script>
  (function(){
    const AUTH0_DOMAIN = "dev-zzhjbmtzoxtgoz31.us.auth0.com";
    const CLIENT_ID = "0glcwUr7ZZ9sbBTBPiUPahEqqwUcuzfR";
    const AUDIENCE = "https://shree-drive.onrender.com";

    // initialize a small wrapper that exposes the relevant methods
    window.__AUTH_READY__ = (async function init(){
      if (typeof createAuth0Client !== 'function') {
        console.error('Auth0 SDK missing');
        return null;
      }
      try {
        const auth0 = await createAuth0Client({
          domain: AUTH0_DOMAIN,
          client_id: CLIENT_ID,
          audience: AUDIENCE,
          cacheLocation: 'memory'
        });

        return {
          _auth0: auth0,
          handleCallback: async () => {
            try {
              return await auth0.handleRedirectCallback();
            } catch(e){
              console.warn('handleRedirectCallback err', e);
              return null;
            }
          },
          isAuthenticated: () => auth0.isAuthenticated(),
          getUser: () => auth0.getUser(),
          logout: (opts={}) => auth0.logout({ returnTo: window.location.origin + (opts.returnTo||'/') })
        };
      } catch (e) {
        console.error('Auth init failed', e);
        return null;
      }
    })();
  })();

  (async function(){
    const auth = await window.__AUTH_READY__;
    const infoEl = document.getElementById('info');
    if (!auth) {
      infoEl.textContent = 'Auth SDK not available. Try refresh.';
      return;
    }

    // Complete the redirect flow (if there are code/state params)
    try {
      await auth.handleCallback();
    } catch (e) {
      console.warn('callback handling failed', e);
    }

    // If still not authenticated, go back to login (index triggers hosted login)
    if (!await auth.isAuthenticated()) {
      infoEl.textContent = 'Not signed in — redirecting to sign-in...';
      setTimeout(() => { window.location.href = '/'; }, 900);
      return;
    }

    // Authenticated: show links
    document.getElementById('links').style.display = 'block';
    document.getElementById('info').style.display = 'none';

    // optional: you can show username/email if you like:
    try {
      const user = await auth.getUser();
      if(user && (user.name || user.email)) {
        const el = document.createElement('div');
        el.className = 'info';
        el.style.marginTop = '8px';
        el.textContent = 'Signed in as ' + (user.name || user.email);
        document.getElementById('links').insertBefore(el, document.getElementById('logout'));
      }
    } catch(e){ /* ignore */ }

    document.getElementById('logout').onclick = () => auth.logout();
  })();
  </script>
</body>
</html>
