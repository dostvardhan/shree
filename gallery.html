<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>üåø Shree Gallery üåø</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ‚úÖ Correct Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body{margin:0;font-family:sans-serif;background:#f8f8f8;}
    header{display:flex;align-items:center;gap:10px;padding:16px;background:#fff;position:sticky;top:0;border-bottom:1px solid #eee;}
    header a,header button{padding:6px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;text-decoration:none;color:#111}
    h2{margin:0;color:olive;}
    #status{padding:10px;color:#666;}
    #grid{padding:16px;display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
    .card img{width:100%;height:200px;object-fit:cover;}
    .quote{padding:10px;font-size:14px;color:#444;text-align:center;background:#fafafa;}
  </style>
</head>
<body>
  <header>
    <h2>üåø Gallery</h2>
    <a href="/life.html">Life</a>
    <a href="/upload.html">Upload</a>
    <button onclick="logout()">Logout</button>
  </header>
  <div id="status">Loading...</div>
  <div id="grid"></div>

  <script>
    const BACKEND = "https://shree-drive.onrender.com";

    document.addEventListener("DOMContentLoaded", () => {
      if (window.netlifyIdentity) {
        netlifyIdentity.init();
        netlifyIdentity.on("init", user => {
          console.log("üîé Netlify Identity init:", user);
          if (!user) {
            document.getElementById("status").textContent = "‚ö†Ô∏è Not logged in. Please login first.";
            window.location.href = "/"; // redirect to home/login
          } else {
            console.log("‚úÖ Logged in as:", user.email);
            loadGallery();
          }
        });
      } else {
        console.error("‚ùå Identity script not loaded");
      }
    });

    function logout(){ window.netlifyIdentity.logout(); window.location='/'; }

    async function token(){
      const u = netlifyIdentity.currentUser();
      if(!u) throw new Error("Not logged in");
      return await u.jwt();
    }

    async function fetchBlobURL(id){
      const t = await token();
      const r = await fetch(`${BACKEND}/file/${id}`, { headers:{ Authorization:`Bearer ${t}` }});
      if(!r.ok) throw new Error("Fetch failed");
      const blob = await r.blob();
      return URL.createObjectURL(blob);
    }

    async function loadGallery(){
      const status=document.getElementById('status');
      const grid=document.getElementById('grid');
      status.textContent="Loading...";
      grid.innerHTML="";
      try{
        const t = await token();
        console.log("üîë JWT length:", t.length);

        const r = await fetch(`${BACKEND}/list`, { 
          headers:{ Authorization:`Bearer ${t}` }
        });
        console.log("üì° Response status:", r.status);

        const text = await r.text();
        console.log("üì¶ Raw response:", text);

        const files = JSON.parse(text);
        if(!r.ok) throw new Error(files.error||"List failed");

        if(!files.length){ status.textContent="No images yet."; return; }

        status.textContent="";
        for(const f of files){
          const url = await fetchBlobURL(f.id);
          const div=document.createElement('div');
          div.className="card";

          const img=document.createElement('img');
          img.src=url;
          img.alt=f.name;

          const q=document.createElement('div');
          q.className="quote";
          q.textContent=f.description||"";

          div.appendChild(img);
          div.appendChild(q);
          grid.appendChild(div);
        }
      }catch(e){ 
        console.error("‚ùå Gallery error:", e);
        status.textContent="‚ùå "+e.message; 
      }
    }
  </script>
</body>
</html>
