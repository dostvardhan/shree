<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Auth0 SDK (working CDN) -->
  <script src="https://unpkg.com/@auth0/auth0-spa-js@2.1.3/dist/auth0-spa-js.production.js"></script>
</head>
<body>
  <h2>üñºÔ∏è Photo Gallery</h2>
  <div id="gallery"></div>
  <div id="status"></div>

  <script>
    let auth0Client;

    async function initAuth0() {
      auth0Client = await createAuth0Client({
        domain: "dev-zzhjbmtzoxtgoz31.us.auth0.com",
        client_id: "vI2cLCbnMh18LqyQrUjGiaw3zsTkV9yT", // ‚úÖ latest Client ID
        audience: "https://shreshthapushkar.com/api",
        cacheLocation: "localstorage"
      });

      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/gallery.html");
      }

      const isAuthenticated = await auth0Client.isAuthenticated();
      if (!isAuthenticated) {
        await auth0Client.loginWithRedirect({
          redirect_uri: window.location.origin + "/gallery.html"
        });
        return;
      }

      document.getElementById("status").innerText =
        "‚úÖ Logged in as " + (await auth0Client.getUser()).email;

      loadGallery();
    }

    async function loadGallery() {
      try {
        const token = await auth0Client.getTokenSilently();
        const res = await fetch("https://shree-drive.onrender.com/list", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const files = await res.json();

        const galleryDiv = document.getElementById("gallery");
        if (!files.length) {
          galleryDiv.innerHTML = "<p>No files yet.</p>";
          return;
        }

        galleryDiv.innerHTML = files.map(f => `
          <div style="margin:10px; display:inline-block; text-align:center;">
            <img src="https://drive.google.com/uc?id=${f.id}" width="200"/>
            <p>${f.name}</p>
          </div>
        `).join("");
      } catch (err) {
        console.error("Gallery load error:", err);
        document.getElementById("status").innerText =
          "‚ùå Failed to load gallery: " + err.message;
      }
    }

    initAuth0();
  </script>
</body>
</html>
