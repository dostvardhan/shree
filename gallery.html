<script>
const fmtIST = new Intl.DateTimeFormat('en-IN', {
  year:'numeric', month:'short', day:'2-digit',
  hour:'2-digit', minute:'2-digit', hour12:true,
  timeZone: 'Asia/Kolkata'
});

async function loadGallery(){
  const G=document.getElementById('g'), MSG=document.getElementById('msg');
  try{
    const r = await authFetch('https://shree-drive.onrender.com/photos');
    if(!r.ok){
      const t = await r.text();
      G.textContent=''; 
      MSG.innerHTML = `<div class="err">Failed to load (HTTP ${r.status}). ${t}</div>`;
      if(r.status===401) netlifyIdentity.open();
      return;
    }
    const { items=[] } = await r.json();
    items.sort((a,b)=> new Date(b.createdTime)-new Date(a.createdTime));
    if(!items.length){ G.textContent='No photos yet.'; return; }

    G.innerHTML = items.map(f=>{
      const t = new Date(f.createdTime);
      const ap = f.appProperties || {};
      const quote = ap.quote ? `<div class="quote">“${ap.quote}”</div>` : '';
      const src = `https://shree-drive.onrender.com/photo/${f.id}`;
      // prettier title: strip leading timestamp from name
      const pretty = f.name.replace(/^\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}_/, '');
      return `
        <div class="card">
          <img loading="lazy" src="${src}" alt="${f.name}">
          <div class="meta">
            <div class="dt">${fmtIST.format(t)} IST</div>
            <div class="name">${pretty}</div>
            ${quote}
          </div>
        </div>`;
    }).join('');
  }catch(err){
    G.textContent='';
    MSG.innerHTML = `<div class="err">Network error: ${err?.message||err}</div>`;
  }
}
</script>
