<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#f7f7f8;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .actions{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
    .media{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#fafafa;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.3}
    .caption{font-size:13px;opacity:.85;margin-top:6px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .btn{font-size:13px;border:1px solid #ddd;border-radius:10px;background:#fff;padding:6px 10px;text-decoration:none}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gallery</h1>
    <div class="actions">
      <a class="btn" href="/upload.html">+ Upload more</a>
      <span id="status" class="muted"></span>
    </div>

    <div id="gallery" class="grid"></div>
  </div>

  <!-- Netlify Identity (needed for JWT) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    const API = "https://shree-drive.onrender.com";

    // Optional: custom captions
    const captionById = {
      // "1AbCdEF...": "“Yeh hamari yaadon ka rang hai.”",
    };
    const captionByName = {
      // "photo2.jpg": "“Jahan dil lage, wahi ghar hai.”"
    };
    const defaultSecondCaption = "“Jahan dil lage, wahi ghar hai.”";

    function getCaption(file, index) {
      if (captionById[file.id]) return captionById[file.id];
      if (captionByName[file.name]) return captionByName[file.name];
      if (index === 1) return defaultSecondCaption; // 2nd card
      return "";
    }

    async function getToken() {
      if (!window.netlifyIdentity) return null;
      try { window.netlifyIdentity.init(); } catch (_) {}
      const u = window.netlifyIdentity.currentUser();
      if (!u) return null;
      try { return await u.jwt(); } catch { return null; }
    }

    function cardHTML(name, cap, imgURL, viewHref) {
      return `
        <div class="card">
          <a class="media" href="${viewHref}" target="_blank" rel="noopener">
            <img src="${imgURL}" alt="${name}" loading="lazy" />
          </a>
          <div class="meta">
            <div class="name" title="${name}">${name}</div>
            ${cap ? `<div class="caption">${cap}</div>` : ""}
            <div class="row">
              <a class="btn" href="${viewHref}" target="_blank" rel="noopener">View</a>
            </div>
          </div>
        </div>
      `;
    }

    async function loadGallery() {
      const status = document.getElementById("status");
      const wrap = document.getElementById("gallery");
      status.textContent = "Loading…";

      // Require login to view private images
      const token = await getToken();
      if (!token) {
        status.textContent = "Please log in to view the private gallery.";
        return;
      }

      try {
        // Use pageSize (backend ignores 'limit')
        const res = await fetch(`${API}/list?pageSize=200`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("List failed");

        const files = (data.files || []).filter(f => (f.mimeType || "").startsWith("image/"));
        if (!files.length) {
          status.textContent = "No photos yet.";
          wrap.innerHTML = "";
          return;
        }

        const items = [];
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          try {
            // Private image via backend proxy (Authorization header)
            const imgRes = await fetch(`${API}/file/${encodeURIComponent(f.id)}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (!imgRes.ok) throw new Error(`Image HTTP ${imgRes.status}`);
            const blob = await imgRes.blob();
            const url = URL.createObjectURL(blob);

            const cap = getCaption(f, i);
            const viewHref = `https://drive.google.com/file/d/${f.id}/view`; // open in Drive viewer

            items.push(cardHTML(f.name, cap, url, viewHref));
          } catch (e) {
            console.error("Image fetch failed:", f.id, e);
          }
        }

        wrap.innerHTML = items.join("");
        status.textContent = `${items.length} photos`;
      } catch (e) {
        console.error(e);
        status.textContent = "Error loading gallery.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", loadGallery);
        window.netlifyIdentity.on("login", loadGallery);
        window.netlifyIdentity.on("logout", loadGallery);
      }
      loadGallery();
    });
  </script>
</body>
</html>
