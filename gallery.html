<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#f7f7f8;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .actions{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
    .media{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#fafafa;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.3}
    .caption{font-size:13px;opacity:.85;margin-top:6px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .btn{font-size:13px;border:1px solid #ddd;border-radius:10px;background:#fff;padding:6px 10px;text-decoration:none}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gallery</h1>
    <div class="actions">
      <a class="btn" href="/upload.html">+ Upload more</a>
      <span id="status" class="muted"></span>
    </div>

    <div id="gallery" class="grid"></div>
  </div>

  <!-- Netlify Identity (needed for JWT) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    const API = "https://shree-drive.onrender.com";
    const MAX_PAGE = 50;          // load at most 50 files initially (raise later if needed)
    const CONCURRENCY = 4;        // limit parallel image fetches to avoid browser crashes

    // Optional captions
    const captionById = {};
    const captionByName = {};
    const defaultSecondCaption = "“Jahan dil lage, wahi ghar hai.”";

    function getCaption(file, index) {
      if (captionById[file.id]) return captionById[file.id];
      if (captionByName[file.name]) return captionByName[file.name];
      if (index === 1) return defaultSecondCaption;
      return "";
    }

    async function getToken() {
      if (!window.netlifyIdentity) return null;
      try { window.netlifyIdentity.init(); } catch (_) {}
      const u = window.netlifyIdentity.currentUser();
      if (!u) return null;
      try { return await u.jwt(); } catch { return null; }
    }

    function makeCardSkeleton() {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="media"><div style="width:100%;height:100%;background:#eee"></div></div>
        <div class="meta">
          <div class="name">Loading…</div>
        </div>
      `;
      return div;
    }

    function fillCard(card, name, url, caption, viewHref) {
      const mediaHolder = card.querySelector('.media');
      const a = document.createElement('a');
      a.className = 'media';
      a.href = viewHref;
      a.target = '_blank';
      a.rel = 'noopener';

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = name;
      img.src = url;

      // free memory shortly after load
      img.addEventListener('load', () => {
        setTimeout(() => URL.revokeObjectURL(url), 3000);
      });

      a.appendChild(img);
      mediaHolder.replaceWith(a);

      const nameEl = card.querySelector('.name');
      nameEl.textContent = name;

      const meta = card.querySelector('.meta');
      if (caption) {
        const cap = document.createElement('div');
        cap.className = 'caption';
        cap.textContent = caption;
        meta.appendChild(cap);
      }
      const row = document.createElement('div');
      row.className = 'row';
      const viewBtn = document.createElement('a');
      viewBtn.className = 'btn';
      viewBtn.href = viewHref;
      viewBtn.target = '_blank';
      viewBtn.rel = 'noopener';
      viewBtn.textContent = 'View';
      row.appendChild(viewBtn);
      meta.appendChild(row);
    }

    async function fetchImageBlobURL(id, token) {
      const res = await fetch(`${API}/file/${encodeURIComponent(id)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`Image HTTP ${res.status}`);
      const blob = await res.blob();
      return URL.createObjectURL(blob);
    }

    async function loadGallery() {
      const status = document.getElementById("status");
      const grid = document.getElementById("gallery");
      status.textContent = "Loading…";

      const token = await getToken();
      if (!token) {
        status.textContent = "Please log in to view the private gallery.";
        return;
      }

      // 1) Get list (limit to MAX_PAGE first)
      let files = [];
      try {
        const res = await fetch(`${API}/list?pageSize=${MAX_PAGE}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error('List failed');
        files = (data.files || []).filter(f => (f.mimeType || '').startsWith('image/'));
      } catch (e) {
        console.error(e);
        status.textContent = "Error loading gallery.";
        return;
      }

      if (!files.length) {
        status.textContent = "No photos yet.";
        grid.innerHTML = "";
        return;
      }

      // 2) Add skeletons
      grid.innerHTML = '';
      const cards = files.map(() => {
        const c = makeCardSkeleton();
        grid.appendChild(c);
        return c;
      });

      // 3) Fetch images with limited concurrency
      let completed = 0;
      status.textContent = `Loading images… 0/${files.length}`;

      const queue = files.map((file, index) => async () => {
        try {
          const url = await fetchImageBlobURL(file.id, token);
          const caption = getCaption(file, index);
          const viewHref = `https://drive.google.com/file/d/${file.id}/view`;
          fillCard(cards[index], file.name, url, caption, viewHref);
        } catch (err) {
          console.error('Image fetch failed:', file.id, err);
          cards[index].querySelector('.name').textContent = file.name + ' (failed)';
        } finally {
          completed++;
          status.textContent = `Loading images… ${completed}/${files.length}`;
        }
      });

      const runners = new Array(CONCURRENCY).fill(0).map(async () => {
        while (queue.length) {
          const job = queue.shift();
          if (job) await job();
        }
      });
      await Promise.all(runners);

      status.textContent = `${files.length} photos`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", loadGallery);
        window.netlifyIdentity.on("login", loadGallery);
        window.netlifyIdentity.on("logout", loadGallery);
      }
      loadGallery();
    });
  </script>
</body>
</html>
