<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#f7f7f8;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .actions{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column;min-height:280px}
    .media{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#fafafa;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.3}
    .caption{font-size:13px;opacity:.85;margin-top:6px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .btn{font-size:13px;border:1px solid #ddd;border-radius:10px;background:#fff;padding:6px 10px;text-decoration:none;cursor:pointer}
    .muted{opacity:.7}
    .hide{display:none}
    .skeleton{width:100%;height:100%;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sk 1.2s infinite}
    @keyframes sk{0%{background-position:0 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gallery</h1>
    <div class="actions">
      <a class="btn" href="/upload.html">+ Upload more</a>
      <span id="status" class="muted"></span>
      <button id="loadMore" class="btn hide" type="button">Load 12 more</button>
    </div>

    <div id="gallery" class="grid"></div>
  </div>

  <!-- Netlify Identity (needed for JWT) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    const API = "https://shree-drive.onrender.com";

    // batching + concurrency
    const BATCH_SIZE = 12;
    const CONCURRENCY = 2;

    // Optional captions
    const captionById = {};
    const captionByName = {};
    const defaultSecondCaption = "“Jahan dil lage, wahi ghar hai.”";

    function getCaption(file, index) {
      if (captionById[file.id]) return captionById[file.id];
      if (captionByName[file.name]) return captionByName[file.name];
      if (index === 1) return defaultSecondCaption;
      return "";
    }

    async function getToken() {
      if (!window.netlifyIdentity) return null;
      try { window.netlifyIdentity.init(); } catch (_) {}
      const u = window.netlifyIdentity.currentUser();
      if (!u) return null;
      try { return await u.jwt(); } catch { return null; }
    }

    function makeCardSkeleton(name='Loading…') {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="media"><div class="skeleton"></div></div>
        <div class="meta">
          <div class="name">${name}</div>
        </div>
      `;
      return div;
    }

    function fillCard(card, file, blobUrl, caption) {
      const viewHref = `https://drive.google.com/file/d/${file.id}/view`;

      // Replace skeleton with image inside a link
      const mediaHolder = card.querySelector('.media');
      const a = document.createElement('a');
      a.className = 'media';
      a.href = viewHref;
      a.target = '_blank';
      a.rel = 'noopener';

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = file.name;
      img.src = blobUrl;

      img.addEventListener('load', () => {
        // revoke after a short delay
        setTimeout(() => URL.revokeObjectURL(blobUrl), 2500);
      });

      a.appendChild(img);
      mediaHolder.replaceWith(a);

      const meta = card.querySelector('.meta');
      const nameEl = card.querySelector('.name');
      nameEl.textContent = file.name;

      // caption
      if (caption) {
        const cap = document.createElement('div');
        cap.className = 'caption';
        cap.textContent = caption;
        meta.appendChild(cap);
      }

      // row with only View button (no download for private)
      const row = document.createElement('div');
      row.className = 'row';
      const viewBtn = document.createElement('a');
      viewBtn.className = 'btn';
      viewBtn.href = viewHref;
      viewBtn.target = '_blank';
      viewBtn.rel = 'noopener';
      viewBtn.textContent = 'View';
      row.appendChild(viewBtn);
      meta.appendChild(row);
    }

    async function fetchImageBlobURL(id, token) {
      const res = await fetch(`${API}/file/${encodeURIComponent(id)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`Image HTTP ${res.status}`);
      const blob = await res.blob();
      return URL.createObjectURL(blob);
    }

    // State
    let FILES = [];
    let NEXT_INDEX = 0;
    let TOKEN = null;

    function updateButtons() {
      const btn = document.getElementById('loadMore');
      if (NEXT_INDEX >= FILES.length) {
        btn.classList.add('hide');
      } else {
        btn.classList.remove('hide');
      }
    }

    async function renderNextBatch() {
      const status = document.getElementById("status");
      const grid = document.getElementById("gallery");

      const start = NEXT_INDEX;
      const end = Math.min(FILES.length, NEXT_INDEX + BATCH_SIZE);
      if (start >= end) { updateButtons(); return; }

      // skeletons
      const cards = [];
      for (let i = start; i < end; i++) {
        const c = makeCardSkeleton('Loading…');
        grid.appendChild(c);
        cards.push(c);
      }

      // tasks with limited concurrency
      let completed = 0;
      const total = end - start;

      const tasks = FILES.slice(start, end).map((file, idx) => async () => {
        try {
          const url = await fetchImageBlobURL(file.id, TOKEN);
          const caption = getCaption(file, start + idx);
          fillCard(cards[idx], file, url, caption);
        } catch (e) {
          console.error('img fail', file.id, e);
          cards[idx].querySelector('.name').textContent = file.name + ' (failed)';
        } finally {
          completed++;
          status.textContent = `Loading ${completed}/${total}… (${end}/${FILES.length})`;
        }
      });

      const runners = new Array(CONCURRENCY).fill(0).map(async () => {
        while (tasks.length) {
          const job = tasks.shift();
          if (job) await job();
        }
      });
      await Promise.all(runners);

      NEXT_INDEX = end;
      status.textContent = `Showing ${NEXT_INDEX}/${FILES.length} photos`;
      updateButtons();
    }

    async function initGallery() {
      const status = document.getElementById("status");
      const grid = document.getElementById("gallery");
      const loadMoreBtn = document.getElementById("loadMore");

      status.textContent = "Loading…";

      TOKEN = await getToken();
      if (!TOKEN) {
        status.textContent = "Please log in to view the private gallery.";
        return;
      }

      // fetch list (just first 200 metadata)
      try {
        const res = await fetch(`${API}/list?pageSize=200`, {
          headers: { Authorization: `Bearer ${TOKEN}` }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error('List failed');

        FILES = (data.files || []).filter(f => (f.mimeType || '').startsWith('image/'));
        if (!FILES.length) {
          status.textContent = "No photos yet.";
          grid.innerHTML = "";
          return;
        }

        status.textContent = `Found ${FILES.length} photos`;
      } catch (e) {
        console.error(e);
        status.textContent = "Error loading gallery.";
        return;
      }

      // initial batch
      NEXT_INDEX = 0;
      updateButtons();
      await renderNextBatch();

      // button handler
      loadMoreBtn.onclick = () => renderNextBatch();
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", initGallery);
        window.netlifyIdentity.on("login", initGallery);
        window.netlifyIdentity.on("logout", () => location.href='/login.html');
      }
      initGallery();
    });
  </script>
</body>
</html>
