<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Memories</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind (as you already had) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Netlify Identity (for JWT) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    const API_BASE = "https://shree-drive.onrender.com";

    async function identityReady() {
      if (!window.netlifyIdentity) throw new Error("Identity widget missing");
      try { window.netlifyIdentity.init(); } catch(_) {}
    }
    async function getTokenOrLogin() {
      await identityReady();
      const u = window.netlifyIdentity.currentUser();
      if (u) return u.jwt();
      return new Promise((resolve, reject) => {
        const onLogin = async (user) => {
          try { const t = await user.jwt(); netlifyIdentity.off("login", onLogin); resolve(t); }
          catch (e) { reject(e); }
        };
        netlifyIdentity.on("login", onLogin);
        netlifyIdentity.open("login");
      });
    }

    async function listFiles(token) {
      const res = await fetch(`${API_BASE}/list`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || data.error) throw new Error(data.error || `List failed (${res.status})`);
      return data.files || [];
    }

    // Secure image bytes via backend and return a blob URL
    async function fetchImageURL(id, token) {
      const res = await fetch(`${API_BASE}/file/${encodeURIComponent(id)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`Image load failed (${res.status})`);
      const blob = await res.blob();
      return URL.createObjectURL(blob);
    }

    function fileBaseName(name="") {
      const i = name.lastIndexOf(".");
      return i > 0 ? name.slice(0, i) : name;
    }

    function showStatus(msg) {
      const s = document.getElementById("status");
      if (s) s.textContent = msg || "";
    }

    async function loadGallery() {
      showStatus("Loadingâ€¦");
      const grid = document.getElementById("gallery");
      grid.innerHTML = "";

      try {
        const token = await getTokenOrLogin();
        const files = await listFiles(token);
        showStatus("");

        if (!files.length) {
          grid.innerHTML = `<p class="text-center text-gray-500 col-span-full">No memories yet.</p>`;
          return;
        }

        for (const f of files) {
          const card = document.createElement("div");
          card.className = "bg-white rounded-2xl shadow-md overflow-hidden";

          const kb = Math.round((+f.size || 0) / 1024);
          const title = fileBaseName(f.name);

          // placeholder skeleton
          card.innerHTML = `
            <div class="w-full h-48 bg-gray-200 animate-pulse"></div>
            <div class="p-4">
              <p class="text-gray-700 truncate" title="${title}">${title}</p>
              <p class="text-gray-400 text-sm mt-2">${(f.mimeType || "file")} â€¢ ${kb} KB</p>
              <div class="mt-3 flex space-x-2">
                <button class="px-3 py-1 rounded-md bg-rose-500 text-white focus:outline-none focus:ring">View</button>
                <button class="px-3 py-1 rounded-md border border-gray-300 text-gray-700 bg-white focus:outline-none focus:ring">Download</button>
              </div>
            </div>
          `;

          const viewBtn = card.querySelector("button:nth-child(1)");
          const dlBtn   = card.querySelector("button:nth-child(2)");

          // Fill thumbnail privately for images
          if (f.mimeType && f.mimeType.startsWith("image/")) {
            (async () => {
              try {
                const url = await fetchImageURL(f.id, token);
                const img = document.createElement("img");
                img.src = url;
                img.alt = title;
                img.className = "w-full h-48 object-cover";
                card.firstElementChild.replaceWith(img);

                // View in new tab (blob)
                viewBtn.onclick = () => window.open(url, "_blank");
              } catch {
                // leave skeleton on failure
                viewBtn.onclick = () => alert("Preview unavailable.");
              }
            })();
          } else {
            viewBtn.onclick = () => alert("Preview available only for images.");
          }

          // Private download via blob
          dlBtn.onclick = async () => {
            try {
              const res = await fetch(`${API_BASE}/file/${encodeURIComponent(f.id)}`, {
                headers: { Authorization: `Bearer ${token}` }
              });
              if (!res.ok) throw new Error(`Download failed (${res.status})`);
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url; a.download = f.name || "file";
              document.body.appendChild(a); a.click(); a.remove();
              URL.revokeObjectURL(url);
            } catch (e) { alert(e.message); }
          };

          grid.appendChild(card);
        }
      } catch (err) {
        console.error(err);
        showStatus("");
        grid.innerHTML = `<p class="text-center text-gray-500 col-span-full">Failed to load memories.</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", loadGallery);
  </script>
</head>
<body class="bg-gradient-to-br from-pink-50 to-rose-100 min-h-screen p-6">
  <header class="max-w-5xl mx-auto mb-6 flex items-center justify-between">
    <h1 class="text-3xl font-bold text-rose-600">ðŸŒ¸ Daily Memories ðŸŒ¸</h1>
    <div class="space-x-2">
      <a href="upload.html" class="px-3 py-1 rounded-md bg-rose-500 text-white">+ Upload</a>
      <a href="index.html" class="px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700">Home</a>
      <button class="px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700" onclick="try{ netlifyIdentity.open('login'); }catch(e){}">Login</button>
    </div>
  </header>

  <p id="status" class="text-center text-gray-500 mb-4"></p>

  <div id="gallery" class="max-w-5xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    <!-- Cards injected here -->
  </div>
</body>
</html>
